<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joey's Career Tracker V30</title>
    <style>
        :root { 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --text: #1f1f1f; 
            --text-muted: #666;
            --border: #e1e4e8; 
            --primary: #333; 
            --input-bg: #fff;
            --input-border: #ccc;
            --session-bg: #f8f9fa;
            --success: #28a745;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --tourn-color: #6f42c1;
        }
        
        [data-theme="dark"] { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #e4e6eb; 
            --text-muted: #b0b3b8;
            --border: #383838; 
            --input-bg: #2a2a2a;
            --input-border: #555;
            --session-bg: #252525;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --tourn-color: #a76dff;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: background 0.3s, color 0.3s; }

        /* NAVIGATION - OPTIMIZED FOR MOBILE */
        .navbar { 
            background: var(--card); 
            border-bottom: 1px solid var(--border); 
            padding: 10px 15px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-wrap: wrap; /* Allows wrapping on mobile */
            gap: 10px;
            align-items: center;
        }

        /* Default (Desktop) Layout: All in one line */
        .nav-group-teams, .nav-group-utils {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            align-items: center;
        }
        
        /* Utility group pushes to the right on desktop */
        .nav-group-utils { margin-left: auto; }

        .nav-item { 
            padding: 8px 16px; 
            border-radius: 25px; 
            cursor: pointer; 
            font-weight: 700; 
            font-size: 0.9rem; 
            white-space: nowrap; 
            opacity: 0.6; 
            transition: 0.2s; 
            border: 2px solid transparent; 
        }
        .nav-item.active { opacity: 1; background: var(--primary); color: #fff; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transform: translateY(-1px); border-color: var(--primary); }
        
        .nav-item.career { border-color: #ffd700; color: #b8860b; background: transparent; }
        .nav-item.career.active { background: linear-gradient(135deg, #ffd700, #daa520); color: #000; border-color: transparent; }
        .nav-item.tournaments { border-color: var(--tourn-color); color: var(--tourn-color); background: transparent; }
        .nav-item.tournaments.active { background: var(--tourn-color); color: #fff; border-color: transparent; }
        .nav-item.admin { background: #e9ecef; color: #333; }
        .nav-item.admin.active { background: #333; color: #fff; }

        .season-display { font-size: 0.8rem; font-weight: 700; color: var(--text-muted); background: var(--session-bg); padding: 6px 10px; border-radius: 8px; border: 1px solid var(--border); white-space: nowrap; display: flex; align-items: center; height: 32px; box-sizing: border-box; }

        .icon-btn { margin-left: 5px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 50%; width: 40px; height: 40px; min-width: 40px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; color: var(--text); transition: 0.2s; }

        /* MOBILE OVERRIDES (< 600px) */
        @media (max-width: 600px) {
            .navbar { padding: 8px 10px; gap: 8px; justify-content: space-between; }
            
            /* Force distinct rows */
            .nav-group-teams { 
                width: 100%; 
                order: 1; 
                padding-bottom: 5px; 
                border-bottom: 1px solid var(--border);
                margin-bottom: 5px;
                justify-content: flex-start; /* Left align teams */
            }
            
            .nav-group-utils { 
                width: 100%; 
                order: 2; 
                margin-left: 0;
                justify-content: space-between; /* Spread utilities evenly */
            }

            .nav-item { font-size: 0.85rem; padding: 6px 12px; }
            .season-display { font-size: 0.75rem; padding: 4px 8px; height: auto; }
            .icon-btn { width: 36px; height: 36px; min-width: 36px; font-size: 1rem; }
        }

        .container { max-width: 800px; margin: 25px auto; padding: 0 15px; }

        /* CARDS */
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; transition: border-color 0.3s; }
        .card::before { content: ""; position: absolute; top: 0; left: 0; width: 100%; height: 6px; background: var(--primary); opacity: 0.8; transition: background 0.3s; }
        .card-header { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; color: var(--text); }
        
        /* STATS GRID */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item { background: var(--bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-item span { font-size: 0.7rem; text-transform: uppercase; font-weight: 700; color: var(--text-muted); display: block; margin-bottom: 5px; }
        .stat-item strong { font-size: 1.5rem; color: var(--primary); display: block; line-height: 1; }

        /* INPUTS & FORMS */
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        label { display: block; font-size: 0.85rem; font-weight: 700; margin-bottom: 8px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; box-sizing: border-box; background: var(--input-bg); color: var(--text); transition: border 0.2s; outline: none; font-family: inherit; }
        select:focus, input:focus, textarea:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(100,100,100,0.1); }
        textarea { resize: vertical; }

        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 0.95rem; transition: transform 0.1s, opacity 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-add { background: var(--primary); color: #fff; margin-bottom: 10px; }
        .btn-save { background: var(--success); color: white; }
        .btn-del { background: transparent; color: var(--danger); font-size: 1.1rem; padding: 5px; cursor: pointer; border: none; }
        .btn-edit { background: transparent; color: #3b82f6; font-size: 1.2rem; padding: 5px; cursor: pointer; border: none; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }

        /* HISTORY */
        .session-card { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.03); }
        .session-header { background: var(--session-bg); padding: 12px 15px; font-size: 0.9rem; font-weight: 700; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; color: var(--text-muted); }
        .match-row { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: var(--card); }
        .match-row:last-child { border-bottom: none; }
        
        .result-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; min-width: 30px; text-align: center; }
        .res-w { background: rgba(40, 167, 69, 0.15); color: #28a745; border: 1px solid rgba(40, 167, 69, 0.2); }
        .res-l { background: rgba(220, 53, 69, 0.15); color: #dc3545; border: 1px solid rgba(220, 53, 69, 0.2); }
        .res-d { background: rgba(255, 193, 7, 0.15); color: #d39e00; border: 1px solid rgba(255, 193, 7, 0.2); }

        /* TABLES & LISTS */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: var(--session-bg); text-align: center; padding: 12px 8px; font-weight: 700; color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; font-weight: 500; }
        .t-left { text-align: left; }
        .pos-1 { background: rgba(255, 215, 0, 0.08); position: relative; }
        .pos-1 td:first-child::before { content: "ğŸ‘‘ "; }
        
        .admin-list li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); align-items: center; }
        .queue-item { background: var(--session-bg); border-left: 4px solid var(--primary); padding: 12px; margin-bottom: 10px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; font-weight: 600; }

        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(3px); }
        .modal-box { background: var(--card); padding: 25px; border-radius: 16px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5); border: 1px solid var(--border); }

        .hidden { display: none !important; }
        .season-tag { font-size: 0.75rem; background: var(--primary); color: #fff; padding: 2px 6px; border-radius: 4px; opacity: 0.8; margin-left: 5px; }
    </style>
</head>
<body>

<div class="navbar" id="navBar"></div>

<div class="container">
    <div id="viewMatchDay" class="hidden">
        <div class="card">
            <div class="card-header">
                <span>ğŸ“Š <span id="teamStatTitle">Stats</span></span>
                <span class="season-tag" id="mdSeasonDisplay"></span>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><span>Games</span><strong id="st-p">0</strong></div>
                <div class="stat-item"><span>Wins</span><strong id="st-w">0</strong></div>
                <div class="stat-item"><span>Goals</span><strong id="st-g">0</strong></div>
                <div class="stat-item"><span>Awards</span><strong id="st-a">0</strong></div>
            </div>
        </div>

        <div class="card" style="border-top: 4px solid var(--success);">
            <div class="card-header">âš½ Match Day Input</div>
            <p style="font-size:0.85rem; opacity:0.7; margin-top:-15px; margin-bottom:20px;">Record games for the <strong>Current Season</strong>.</p>
            
            <div class="form-group"><label>Date:</label><input type="date" id="mDate"></div>
            
            <div class="form-group"><label>Competition:</label><select id="mTourn"><option value="League">League</option></select></div>
            <div class="form-row"><div><label>Opponent:</label><select id="mOpp"></select></div><div><label>Manager:</label><select id="mCoach"></select></div></div>
            <div class="form-row">
                <div><label>Us:</label><input type="number" id="mOur" value="0" min="0" oninput="validity.valid||(value='0'); renderScorers('m')"></div>
                <div><label>Them:</label><input type="number" id="mTheir" value="0" min="0" oninput="validity.valid||(value='0')"></div>
            </div>
            <div id="mScorerList" class="form-group"></div>
            <div id="mAwardList" class="form-group"></div>
            
            <div class="form-group">
                <label>Notes (Optional):</label>
                <textarea id="mNotes" rows="2" placeholder="Formations, key moments, tactical notes..."></textarea>
            </div>

            <button class="btn btn-add" onclick="addToQueue()">+ Add Game to Queue</button>
            <div id="matchQueue" style="margin-top:15px; border-top:1px solid var(--border); padding-top:15px;"></div>
            <button id="btnFinalize" class="btn btn-save hidden" onclick="saveSession()">ğŸ’¾ Save Session</button>
        </div>

        <div class="card"><div class="card-header">ğŸ† League Table <small style="font-weight:normal; opacity:0.6; margin-left:5px;">(Current Season)</small></div><table id="teamLeagueTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody></tbody></table></div>
        <div class="card"><div class="card-header">ğŸ•’ Match History <small style="font-weight:normal; opacity:0.6; margin-left:5px;">(Current Season)</small></div><div id="teamHistoryList"></div></div>
    </div>

    <div id="viewTournaments" class="hidden">
        <div class="card" style="border-color: var(--tourn-color);">
            <div class="card-header" style="color: var(--tourn-color);">ğŸ† Tournament Hub
                <button class="btn-outline" style="width:auto; padding:5px 12px; font-size:0.8rem;" onclick="document.getElementById('addTournModal').classList.remove('hidden')">+ New</button>
            </div>
            
            <div class="form-group"><label>Select Active Tournament:</label><select id="tournSelector" onchange="renderTournamentView()"></select></div>
            
            <div id="tournStatsArea" class="hidden">
                <div style="display:flex; justify-content:flex-end; margin-bottom:10px;">
                    <button class="btn-edit" style="font-size:0.9rem; display:flex; align-items:center; gap:5px;" onclick="openEditActiveTourn()">âš™ï¸ Manage Tournament</button>
                </div>

                <div class="stat-grid">
                    <div class="stat-item"><span>Games</span><strong id="tr-p">0</strong></div>
                    <div class="stat-item"><span>Wins</span><strong id="tr-w">0</strong></div>
                    <div class="stat-item"><span>Goals</span><strong id="tr-g">0</strong></div>
                    <div class="stat-item"><span>Awards</span><strong id="tr-a">0</strong></div>
                </div>

                <h3 style="margin-top:25px; font-size:1rem; border-bottom:2px solid var(--border); padding-bottom:5px;">ğŸ† Mini-League Table</h3>
                <table><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody id="tournLeagueBody"></tbody></table>

                <h3 style="margin-top:25px; font-size:1rem; border-bottom:2px solid var(--border); padding-bottom:5px;">ğŸ•’ Match History</h3>
                <div id="tournHistoryList"></div>
            </div>
        </div>
        <div class="card"><div class="card-header">ğŸ“‚ Archived Tournaments</div><ul id="tournArchiveList" class="admin-list"></ul></div>
    </div>

    <div id="viewCareer" class="hidden">
        <div class="card" style="border-color: #DAA520;">
            <div class="card-header" style="color: #B8860B;">
                <span>ğŸŒŸ Career Overview</span>
                <select id="careerSeasonFilter" onchange="renderCareer()" style="width:auto; padding:5px; font-size:0.9rem; border-color:#DAA520;">
                    <option value="All Time">All Time</option>
                </select>
            </div>
            <div class="stat-grid">
                <div class="stat-item"><span>Total Games</span><strong id="c-p">0</strong></div>
                <div class="stat-item"><span>Total Wins</span><strong id="c-w">0</strong></div>
                <div class="stat-item"><span>Total Goals</span><strong id="c-g">0</strong></div>
                <div class="stat-item"><span>Total Awards</span><strong id="c-a">0</strong></div>
            </div>
        </div>
        <div class="card"><div class="card-header">ğŸ† Team Comparison Table</div><table id="masterTable"><thead><tr><th class="t-left">My Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>GF</th><th>Pts</th></tr></thead><tbody></tbody></table></div>
    </div>

    <div id="viewAdmin" class="hidden">
        <h2 style="margin-bottom:20px;">âš™ï¸ Admin & Settings</h2>
        
        <div class="card">
            <div class="card-header">ğŸ›  Select Team to Edit</div>
            <select id="admTeamSelect" onchange="renderAdminDetails()"></select>
        </div>

        <div class="card" style="border-left: 5px solid #007bff;">
            <div class="card-header">ğŸ“… Season Manager</div>
            <div class="form-group">
                <label>Active Season (Record matches here):</label>
                <div style="display:flex; gap:10px;">
                    <select id="admActiveSeason" onchange="switchActiveSeason()"></select>
                    <button class="btn-del" title="Delete Season" onclick="deleteSeason()">ğŸ—‘</button>
                </div>
            </div>
            <button class="btn btn-save" onclick="document.getElementById('newSeasonModal').classList.remove('hidden')">â• Create New Season</button>
            <p style="font-size:0.8rem; opacity:0.7; margin-top:10px;">Switch active seasons using the dropdown above if you started one by mistake.</p>
        </div>

        <div class="card">
            <div class="card-header">ğŸƒâ€â™‚ï¸ Squad & Staff</div>
            <div class="form-group"><label>Players:</label><div style="display:flex; gap:5px;"><input type="text" id="admNewPlayer" placeholder="Name"><button class="btn btn-add" style="width:auto; margin:0;" onclick="adminAddItem('players', 'admNewPlayer')">Add</button></div><ul id="admPlayerList" class="admin-list"></ul></div>
            <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;"><label>Coaches:</label><div style="display:flex; gap:5px;"><input type="text" id="admNewCoach" placeholder="Name"><button class="btn btn-add" style="width:auto; margin:0;" onclick="adminAddItem('coaches', 'admNewCoach')">Add</button></div><ul id="admCoachList" class="admin-list"></ul></div>
            <div class="form-group" style="margin-top:20px; border-top:1px solid var(--border); padding-top:10px;"><label>Opponents:</label><div style="display:flex; gap:5px;"><input type="text" id="admNewOpp" placeholder="Name"><button class="btn btn-add" style="width:auto; margin:0;" onclick="adminAddItem('opps', 'admNewOpp')">Add</button></div><ul id="admOppList" class="admin-list"></ul></div>
        </div>

        <div class="card">
            <div class="card-header">ğŸ… Awards Configuration</div>
            <div style="display:flex; gap:5px;"><input type="text" id="newAwardName" placeholder="Name"><input type="number" id="newAwardMax" placeholder="Qty" style="width:80px;" value="1"><button class="btn btn-save" style="width:auto;" onclick="addAwardConfig()">Add</button></div>
            <ul id="admAwardList" class="admin-list"></ul>
        </div>

        <div class="card">
            <div class="card-header">ğŸŒ Global Settings</div>
            <label>Add New Club:</label><div style="display:flex; gap:5px; margin-bottom:10px;"><input type="text" id="newTeamName" placeholder="Club Name"><input type="color" id="newTeamColor" value="#333333" style="width:60px; padding:2px; height:46px;"><button class="btn btn-add" style="width:auto; margin:0;" onclick="addTeam()">Create</button></div>
            <label>Manage Clubs:</label><ul id="admTeamList" class="admin-list"></ul>
            <hr style="border:0; border-top:1px solid var(--border); margin:20px 0;">
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="exportData()">Export</button><button class="btn" style="background:#6c757d; color:white;" onclick="document.getElementById('importFile').click()">Import</button><input type="file" id="importFile" class="hidden" onchange="importData(event)"><button class="btn btn-del" style="grid-column:span 2; border:1px solid var(--danger); margin-top:10px;" onclick="factoryReset()">Factory Reset</button></div>
        </div>
    </div>
</div>

<div id="guideModal" class="modal-overlay hidden"><div class="modal-box"><h2>ğŸ“– User Guide</h2><p><strong>Retrospective Entry:</strong> You can select a past date when entering games.</p><p><strong>Notes:</strong> Add details about formations or weather. A ğŸ—’ï¸ icon will appear on games with notes.</p><button class="btn btn-add" onclick="document.getElementById('guideModal').classList.add('hidden')">Close</button></div></div>

<div id="newSeasonModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>ğŸ Start New Season</h3>
        <div class="form-group">
            <label>New Season Name (e.g. 2026/27)</label>
            <input type="text" id="newSeasonNameInput" placeholder="YYYY/YY">
        </div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
            <button class="btn btn-save" onclick="startNewSeason()">Start</button>
            <button class="btn" onclick="document.getElementById('newSeasonModal').classList.add('hidden')">Cancel</button>
        </div>
    </div>
</div>

<div id="addTournModal" class="modal-overlay hidden">
    <div class="modal-box"><h3>ğŸ† Create Tournament</h3><div class="form-group"><label>For Which Team?</label><select id="newTournTeam"></select></div><div class="form-group"><label>Tournament Name</label><input type="text" id="newTournNameModal"></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="createTournamentFromHub()">Create</button><button class="btn" onclick="document.getElementById('addTournModal').classList.add('hidden')">Cancel</button></div></div>
</div>

<div id="editModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>âœï¸ Edit Match</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>Date</label><input type="date" id="eDate"></div>
        <div class="form-group"><label>Comp</label><select id="eTourn"></select></div>
        <div class="form-row"><div><label>Opp</label><select id="eOpp"></select></div><div><label>Coach</label><select id="eCoach"></select></div></div>
        <div class="form-row"><div><label>Us</label><input type="number" id="eOur" min="0" oninput="validity.valid||(value='0'); renderScorers('e')"></div><div><label>Them</label><input type="number" id="eTheir" min="0" oninput="validity.valid||(value='0')"></div></div>
        <div id="eScorerList" class="form-group"></div>
        <div id="eAwardList" class="form-group"></div>
        <div class="form-group"><label>Notes</label><textarea id="eNotes" rows="3"></textarea></div>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="saveEditedMatch()">Save</button><button class="btn" onclick="closeEditModal()">Cancel</button></div>
    </div>
</div>

<div id="editTournModal" class="modal-overlay hidden"><div class="modal-box"><h3>ğŸ† Edit Tournament</h3><input type="hidden" id="etTeam"><input type="hidden" id="etIdx"><div class="form-group"><label>Name</label><input type="text" id="etName"></div><div class="form-group"><label>Status</label><select id="etStatus"><option value="true">Active</option><option value="false">Archived</option></select></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="saveEditedTourn()">Save</button><button class="btn" onclick="document.getElementById('editTournModal').classList.add('hidden')">Cancel</button></div></div></div>

<div id="editSimpleModal" class="modal-overlay hidden"><div class="modal-box"><h3>âœï¸ Edit Item</h3><input type="hidden" id="esTeam"><input type="hidden" id="esType"><input type="hidden" id="esIdx"><div class="form-group"><label>Value</label><input type="text" id="esVal"></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="saveEditSimple()">Save</button><button class="btn" onclick="document.getElementById('editSimpleModal').classList.add('hidden')">Cancel</button></div></div></div>

<div id="editAwardModal" class="modal-overlay hidden"><div class="modal-box"><h3>ğŸ… Edit Award</h3><input type="hidden" id="eaTeam"><input type="hidden" id="eaIdx"><div class="form-group"><label>Name</label><input type="text" id="eaName"></div><div class="form-group"><label>Max Winners</label><input type="number" id="eaMax"></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="saveEditAward()">Save</button><button class="btn" onclick="document.getElementById('editAwardModal').classList.add('hidden')">Cancel</button></div></div></div>

<div id="editTeamModal" class="modal-overlay hidden"><div class="modal-box"><h3>ğŸ›¡ Edit Team</h3><input type="hidden" id="etOldName"><div class="form-group"><label>Team Name</label><input type="text" id="etNewName"></div><div class="form-group"><label>Color</label><input type="color" id="etNewColor" style="height:50px;"></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;"><button class="btn btn-save" onclick="saveEditTeam()">Save</button><button class="btn" onclick="document.getElementById('editTeamModal').classList.add('hidden')">Cancel</button></div></div></div>

<script>
    const defaultDB = {
        teams: {
            "Llanelli Town": { color: "#d32f2f", players: ["Joey"], opps: ["Swansea"], coaches: ["Coach A"], awards: [{name:"TOTW", max:3}], tournaments: [], active: true },
            "Dunvant": { color: "#fdd835", players: ["Joey"], opps: ["Mumbles"], coaches: ["Coach B"], awards: [{name:"MOTM", max:1}], tournaments: [], active: true }
        },
        history: [], 
        settings: { theme: 'light', currentSeason: "2025/26", seasons: ["2025/26"] }
    };

    let db = JSON.parse(localStorage.getItem('joey_v30')) || defaultDB;
    let currentView = Object.keys(db.teams)[0];
    let sessionQueue = [];

    // --- MIGRATION: Ensure Season Data Exists ---
    if(!db.settings.currentSeason) { db.settings.currentSeason = "2025/26"; db.settings.seasons = ["2025/26"]; }
    db.history.forEach(m => { if(!m.season) m.season = "2025/26"; });
    // ---------------------------------------------

    function save() { localStorage.setItem('joey_v30', JSON.stringify(db)); }
    
    function init() {
        applyTheme();
        renderNav();
        if(currentView!=='Career'&&currentView!=='Admin'&&currentView!=='Tournaments'&&!db.teams[currentView]) currentView = Object.keys(db.teams)[0];
        switchView(currentView);
    }

    function toggleTheme() { db.settings.theme = db.settings.theme === 'light' ? 'dark' : 'light'; save(); applyTheme(); }
    function applyTheme() { document.body.setAttribute('data-theme', db.settings.theme); }

    function formatDateNice(dateStr) {
        if(!dateStr) return "";
        const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
        // Handle YYYY-MM-DD
        const [y, m, d] = dateStr.split('-');
        if(!y || !m || !d) return dateStr; 
        
        const day = parseInt(d);
        const month = months[parseInt(m)-1];
        const year = y;
        
        let suffix = "th";
        if (day % 10 === 1 && day !== 11) suffix = "st";
        else if (day % 10 === 2 && day !== 12) suffix = "nd";
        else if (day % 10 === 3 && day !== 13) suffix = "rd";
        
        return `${day}${suffix} ${month} ${year}`;
    }

    function renderNav() {
        const nav = document.getElementById('navBar'); nav.innerHTML = '';
        
        // Container for Teams
        const groupTeams = document.createElement('div');
        groupTeams.className = 'nav-group-teams';
        Object.keys(db.teams).forEach(t => {
            if(!db.teams[t].active) return;
            const btn = document.createElement('div'); btn.className = `nav-item ${currentView === t ? 'active' : ''}`;
            btn.innerText = t; btn.onclick = () => switchView(t); groupTeams.appendChild(btn);
        });
        nav.appendChild(groupTeams);

        // Container for Utils (Tournaments, Career, Admin, Season, Tools)
        const groupUtils = document.createElement('div');
        groupUtils.className = 'nav-group-utils';

        const tourn = document.createElement('div'); tourn.className = `nav-item tournaments ${currentView === 'Tournaments' ? 'active' : ''}`;
        tourn.innerHTML = 'ğŸ† Tournaments'; tourn.onclick = () => switchView('Tournaments'); groupUtils.appendChild(tourn);

        const career = document.createElement('div'); career.className = `nav-item career ${currentView === 'Career' ? 'active' : ''}`;
        career.innerHTML = 'ğŸŒŸ Career'; career.onclick = () => switchView('Career'); groupUtils.appendChild(career);

        const admin = document.createElement('div'); admin.className = `nav-item admin ${currentView === 'Admin' ? 'active' : ''}`;
        admin.innerHTML = 'âš™ï¸ Admin'; admin.onclick = () => switchView('Admin'); groupUtils.appendChild(admin);

        // Season Display
        const seasonEl = document.createElement('div');
        seasonEl.className = 'season-display';
        seasonEl.innerText = 'Season ' + db.settings.currentSeason;
        groupUtils.appendChild(seasonEl);

        const themeBtn = document.createElement('button'); themeBtn.className = 'icon-btn'; themeBtn.innerHTML = db.settings.theme === 'light' ? 'ğŸŒ™' : 'â˜€ï¸'; themeBtn.onclick = toggleTheme; groupUtils.appendChild(themeBtn);
        const guideBtn = document.createElement('button'); guideBtn.className = 'icon-btn'; guideBtn.innerHTML = 'ğŸ“–'; guideBtn.onclick = () => document.getElementById('guideModal').classList.remove('hidden'); groupUtils.appendChild(guideBtn);

        nav.appendChild(groupUtils);
    }

    function switchView(viewName) {
        currentView = viewName; renderNav();
        ['viewMatchDay', 'viewCareer', 'viewAdmin', 'viewTournaments'].forEach(id => document.getElementById(id).classList.add('hidden'));

        if(viewName === 'Career') {
            document.getElementById('viewCareer').classList.remove('hidden'); renderCareer();
        } else if(viewName === 'Tournaments') {
            document.getElementById('viewTournaments').classList.remove('hidden'); 
            renderTournamentView();
        } else if (viewName === 'Admin') {
            document.getElementById('viewAdmin').classList.remove('hidden'); 
            document.documentElement.style.setProperty('--primary', '#555'); 
            renderAdmin();
        } else {
            document.getElementById('viewMatchDay').classList.remove('hidden');
            document.documentElement.style.setProperty('--primary', db.teams[viewName].color);
            document.getElementById('teamStatTitle').innerText = viewName + " Stats";
            document.getElementById('mdSeasonDisplay').innerText = db.settings.currentSeason;
            renderMatchDayInputs(); renderTeamStats(); renderHistoryList('teamHistoryList', db.history.filter(m => m.team === viewName && m.season === db.settings.currentSeason)); renderTeamLeague();
        }
    }

    // --- SEASON MANAGER ---
    function startNewSeason() {
        const newName = document.getElementById('newSeasonNameInput').value.trim();
        if(newName) {
            if(!db.settings.seasons.includes(newName)) db.settings.seasons.push(newName);
            db.settings.currentSeason = newName; // Switch to it
            save();
            alert("New Season Started: " + newName);
            document.getElementById('newSeasonModal').classList.add('hidden');
            renderAdmin(); renderNav(); // Refresh nav to update top label
        }
    }

    function switchActiveSeason() {
        const val = document.getElementById('admActiveSeason').value;
        if(val) {
            db.settings.currentSeason = val;
            save();
            renderNav(); // Update top label
        }
    }

    function deleteSeason() {
        const cur = db.settings.currentSeason;
        if(db.settings.seasons.length <= 1) return alert("Cannot delete the only season.");
        
        // Check for matches
        const matches = db.history.filter(m => m.season === cur);
        if(matches.length > 0) {
            if(!confirm(`WARNING: This season has ${matches.length} matches recorded. Deleting it will PERMANENTLY delete these matches. Continue?`)) return;
            // Delete matches
            db.history = db.history.filter(m => m.season !== cur);
        }

        // Remove from list
        db.settings.seasons = db.settings.seasons.filter(s => s !== cur);
        // Set new current to last one
        db.settings.currentSeason = db.settings.seasons[db.settings.seasons.length - 1];
        save();
        renderAdmin();
        renderNav();
        alert("Season deleted.");
    }

    // --- TOURNAMENT HUB LOGIC ---
    function renderTournamentView() {
        renderArchiveList();
        const sel = document.getElementById('tournSelector');
        if(sel.options.length === 0 || sel.innerHTML === "") {
            sel.innerHTML = '<option value="">-- Select Active Tournament --</option>';
            Object.keys(db.teams).forEach(t => {
                if(db.teams[t].tournaments) {
                    db.teams[t].tournaments.forEach(tr => {
                        if(tr.active) sel.add(new Option(`${tr.name} (${t})`, `${t}|${tr.name}`));
                    });
                }
            });
            const teamSel = document.getElementById('newTournTeam'); teamSel.innerHTML = "";
            Object.keys(db.teams).forEach(t => teamSel.add(new Option(t,t)));
        }
        
        const val = sel.value;
        if(!val) { document.getElementById('tournStatsArea').classList.add('hidden'); return; }
        
        const [teamName, tournName] = val.split('|');
        document.getElementById('tournStatsArea').classList.remove('hidden');

        // FILTER BY SEASON + TOURNAMENT
        const h = db.history.filter(m => m.tourn === tournName && m.team === teamName && m.season === db.settings.currentSeason);
        
        document.getElementById('tr-p').innerText = h.length;
        document.getElementById('tr-w').innerText = h.filter(m => m.our > m.their).length;
        let g=0, a=0; h.forEach(m => { g+=m.scorers.filter(p=>p==="Joey").length; a+=m.awards.filter(x=>x.player==="Joey").length; });
        document.getElementById('tr-g').innerText = g; document.getElementById('tr-a').innerText = a;

        const data = calcLeague(h);
        document.getElementById('tournLeagueBody').innerHTML = data.map((t, i) => `
            <tr class="${t.name === teamName ? 'pos-1' : ''}"><td class="t-left">${i+1}. ${t.name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td><td>${t.gf - t.ga}</td><td><b>${t.pts}</b></td></tr>
        `).join('');

        renderHistoryList('tournHistoryList', h);
    }
    
    function createTournamentFromHub() {
        const t = document.getElementById('newTournTeam').value;
        const n = document.getElementById('newTournNameModal').value.trim();
        if(n) {
            if(!db.teams[t].tournaments) db.teams[t].tournaments = [];
            db.teams[t].tournaments.push({name:n, active:true});
            save();
            document.getElementById('addTournModal').classList.add('hidden');
            document.getElementById('tournSelector').innerHTML = "";
            renderTournamentView();
        }
    }
    function openEditActiveTourn() {
        const val = document.getElementById('tournSelector').value; if(!val) return;
        const [teamName, tournName] = val.split('|');
        const idx = db.teams[teamName].tournaments.findIndex(tr => tr.name === tournName);
        if(idx !== -1) editTourn(teamName, idx);
    }
    function renderArchiveList() {
        const ul = document.getElementById('tournArchiveList'); ul.innerHTML = "";
        Object.keys(db.teams).forEach(t => { if(db.teams[t].tournaments) { db.teams[t].tournaments.forEach((tr, i) => { if(!tr.active) ul.innerHTML += `<li><span>${tr.name} (${t})</span><div><button class="btn-edit" onclick="editTourn('${t}', ${i})">âœ</button></div></li>`; }); }});
    }

    // --- ADMIN RENDERERS ---
    function renderAdmin() {
        const admSes = document.getElementById('admActiveSeason');
        admSes.innerHTML = "";
        db.settings.seasons.forEach(s => admSes.add(new Option(s, s)));
        admSes.value = db.settings.currentSeason;

        const tSel = document.getElementById('admTeamSelect'); 
        const cur = tSel.value || Object.keys(db.teams)[0];
        tSel.innerHTML = ''; Object.keys(db.teams).forEach(t => tSel.add(new Option(t,t))); tSel.value = cur;
        renderAdminDetails();
        document.getElementById('admTeamList').innerHTML = Object.keys(db.teams).map(t => `<li><span style="display:flex; align-items:center; gap:10px;"><span style="width:15px; height:15px; border-radius:50%; background:${db.teams[t].color}; border:1px solid #ccc;"></span> ${t}</span><div><button class="btn-edit" onclick="openEditTeam('${t}')">âœ</button><button class="btn-del" onclick="deleteTeam('${t}')">ğŸ—‘</button></div></li>`).join('');
    }
    function renderAdminDetails() {
        const tn = document.getElementById('admTeamSelect').value; const t = db.teams[tn]; if(!t) return;
        document.documentElement.style.setProperty('--primary', t.color);
        const list = (id, arr, k) => document.getElementById(id).innerHTML = arr.map((x,i) => `<li><span>${x}</span><div><button class="btn-edit" onclick="openEditSimple('${tn}','${k}',${i})">âœ</button><button class="btn-del" onclick="admDel('${tn}','${k}',${i})">ğŸ—‘</button></div></li>`).join('');
        list('admPlayerList', t.players, 'players'); list('admCoachList', t.coaches, 'coaches'); list('admOppList', t.opps, 'opps');
        document.getElementById('admAwardList').innerHTML = t.awards.map((a,i) => `<li><span>${a.name} (Max: ${a.max})</span><div><button class="btn-edit" onclick="openEditAward('${tn}',${i})">âœ</button><button class="btn-del" onclick="admDelAw('${tn}',${i})">ğŸ—‘</button></div></li>`).join('');
    }

    // --- GENERIC / EDIT FUNCS ---
    function openEditSimple(team, type, idx) { document.getElementById('esTeam').value = team; document.getElementById('esType').value = type; document.getElementById('esIdx').value = idx; document.getElementById('esVal').value = db.teams[team][type][idx]; document.getElementById('editSimpleModal').classList.remove('hidden'); }
    function saveEditSimple() { const t=document.getElementById('esTeam').value, type=document.getElementById('esType').value, idx=document.getElementById('esIdx').value, val=document.getElementById('esVal').value; if(val){ db.teams[t][type][idx]=val; save(); document.getElementById('editSimpleModal').classList.add('hidden'); renderAdminDetails(); } }
    function openEditAward(team, idx) { const aw=db.teams[team].awards[idx]; document.getElementById('eaTeam').value=team; document.getElementById('eaIdx').value=idx; document.getElementById('eaName').value=aw.name; document.getElementById('eaMax').value=aw.max; document.getElementById('editAwardModal').classList.remove('hidden'); }
    function saveEditAward() { const t=document.getElementById('eaTeam').value, idx=document.getElementById('eaIdx').value, n=document.getElementById('eaName').value, m=parseInt(document.getElementById('eaMax').value)||1; if(n){ db.teams[t].awards[idx]={name:n, max:m}; save(); document.getElementById('editAwardModal').classList.add('hidden'); renderAdminDetails(); } }
    function openEditTeam(name) { document.getElementById('etOldName').value=name; document.getElementById('etNewName').value=name; document.getElementById('etNewColor').value=db.teams[name].color; document.getElementById('editTeamModal').classList.remove('hidden'); }
    function saveEditTeam() { const oldN=document.getElementById('etOldName').value, newN=document.getElementById('etNewName').value, newC=document.getElementById('etNewColor').value; if(!newN)return; db.teams[oldN].color=newC; if(oldN!==newN){ if(db.teams[newN]) return alert("Name exists!"); db.teams[newN]=JSON.parse(JSON.stringify(db.teams[oldN])); delete db.teams[oldN]; db.history.forEach(m=>{if(m.team===oldN)m.team=newN}); if(currentView===oldN)currentView=newN; } save(); document.getElementById('editTeamModal').classList.add('hidden'); renderAdmin(); renderNav(); renderAdminDetails(); }
    function editTourn(team, idx) { const tr=db.teams[team].tournaments[idx]; document.getElementById('etTeam').value=team; document.getElementById('etIdx').value=idx; document.getElementById('etName').value=tr.name; document.getElementById('etStatus').value=tr.active; document.getElementById('editTournModal').classList.remove('hidden'); }
    function saveEditedTourn() { const team=document.getElementById('etTeam').value, idx=document.getElementById('etIdx').value, oldName=db.teams[team].tournaments[idx].name, newName=document.getElementById('etName').value, active=document.getElementById('etStatus').value==='true'; db.teams[team].tournaments[idx]={name:newName, active:active}; if(oldName!==newName) db.history.forEach(m=>{if(m.tourn===oldName&&m.team===team)m.tourn=newName}); save(); document.getElementById('editTournModal').classList.add('hidden'); document.getElementById('tournSelector').innerHTML=""; renderTournamentView(); }
    function adminAddItem(k, id) { const t=document.getElementById('admTeamSelect').value, v=document.getElementById(id).value.trim(); if(v){ db.teams[t][k].push(v); document.getElementById(id).value=""; save(); renderAdminDetails(); }}
    function admDel(t,k,i) { db.teams[t][k].splice(i,1); save(); renderAdminDetails(); }
    function addAwardConfig() { const t=document.getElementById('admTeamSelect').value, n=document.getElementById('newAwardName').value, m=document.getElementById('newAwardMax').value; if(n){ db.teams[t].awards.push({name:n, max:parseInt(m)||1}); document.getElementById('newAwardName').value=""; save(); renderAdminDetails(); }}
    function admDelAw(t,i) { db.teams[t].awards.splice(i,1); save(); renderAdminDetails(); }
    function addTeam() { const n=document.getElementById('newTeamName').value, c=document.getElementById('newTeamColor').value; if(n&&!db.teams[n]){ db.teams[n]={color:c, players:["Joey"], opps:[], coaches:[], awards:[], tournaments:[], active:true}; save(); renderAdmin(); renderNav(); }}
    function deleteTeam(n) { if(confirm(`Delete ${n}?`)) { delete db.teams[n]; save(); location.reload(); }}
    function exportData() { const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(db)],{type:'application/json'})); a.download='JoeyV30.json'; a.click(); }
    function importData(e) { const r=new FileReader(); r.onload=(ev)=>{try{let imp=JSON.parse(ev.target.result); if(imp.data&&!imp.teams){imp.teams=imp.data;delete imp.data;} if(imp.teams)Object.values(imp.teams).forEach(t=>{if(!t.tournaments)t.tournaments=[];if(!t.awards)t.awards=[];if(typeof t.active==='undefined')t.active=true;}); if(imp.history)imp.history.forEach(m=>{if(!m.batchId)m.batchId=m.id||Date.now();if(!m.scorers)m.scorers=[];if(!m.awards)m.awards=[];if(!m.season)m.season="2025/26";}); if(!imp.settings)imp.settings={theme:'light',currentSeason:"2025/26",seasons:["2025/26"]}; db=imp; save(); alert("Imported!"); location.reload();}catch(e){alert("Failed");}}; r.readAsText(e.target.files[0]); }
    function factoryReset() { if(confirm("RESET ALL?")) { localStorage.clear(); location.reload(); }}

    // --- MATCH DAY LOGIC ---
    function renderMatchDayInputs() {
        document.getElementById('mDate').value = new Date().toISOString().split('T')[0];

        const t = db.teams[currentView];
        const fill = (id, arr) => { const el = document.getElementById(id); el.innerHTML = ""; arr.forEach(x => el.add(new Option(x,x))); };
        const tournEl = document.getElementById('mTourn'); tournEl.innerHTML = '<option value="League">League</option>';
        if(t.tournaments) t.tournaments.forEach(tr => { if(tr.active) tournEl.add(new Option("ğŸ† " + tr.name, tr.name)); });
        fill('mOpp', t.opps); fill('mCoach', t.coaches); renderScorers('m');
    }
    function renderScorers(prefix) {
        const count = parseInt(document.getElementById(prefix + 'Our').value) || 0;
        const div = document.getElementById(prefix + 'ScorerList'); div.innerHTML = count > 0 ? '<label>Goal Scorers:</label>' : '';
        const players = db.teams[currentView].players;
        for(let i=0; i<count; i++) {
            const sel = document.createElement('select'); sel.className = prefix + '-sc-input'; sel.style.marginBottom = '5px';
            players.forEach(p => sel.add(new Option(p,p))); div.appendChild(sel);
        }
        const awDiv = document.getElementById(prefix + 'AwardList'); awDiv.innerHTML = '';
        const awards = db.teams[currentView].awards || [];
        if(awards.length > 0) awDiv.innerHTML = '<label>Awards:</label>';
        awards.forEach(aw => {
            const wrapper = document.createElement('div'); wrapper.style.background = 'var(--session-bg)'; wrapper.style.padding = '8px'; wrapper.style.borderRadius = '8px'; wrapper.style.marginBottom = '5px';
            wrapper.innerHTML = `<small><strong>${aw.name}</strong> (Pick up to ${aw.max})</small>`;
            for(let k=0; k<aw.max; k++) {
                const s = document.createElement('select'); s.className = prefix + '-aw-input'; s.dataset.name = aw.name;
                s.add(new Option("- Select Winner -", "")); players.forEach(p => s.add(new Option(p,p))); s.style.marginTop = '4px'; wrapper.appendChild(s);
            }
            awDiv.appendChild(wrapper);
        });
    }
    function addToQueue() {
        const opp = document.getElementById('mOpp').value;
        if(!opp) return alert("Select an opponent (Add in Admin if empty)");
        
        let dVal = document.getElementById('mDate').value;
        if(!dVal) dVal = new Date().toISOString().split('T')[0];

        sessionQueue.push({
            id: Date.now() + Math.random(), 
            date: dVal,
            team: currentView, opp: opp, tourn: document.getElementById('mTourn').value,
            our: parseInt(document.getElementById('mOur').value)||0, their: parseInt(document.getElementById('mTheir').value)||0,
            coach: document.getElementById('mCoach').value,
            scorers: Array.from(document.querySelectorAll('.m-sc-input')).map(s => s.value),
            awards: Array.from(document.querySelectorAll('.m-aw-input')).filter(s => s.value).map(s => ({name: s.dataset.name, player: s.value})),
            notes: document.getElementById('mNotes').value,
            season: db.settings.currentSeason 
        });
        renderQueue(); 
        document.getElementById('mOur').value=0; 
        document.getElementById('mTheir').value=0; 
        document.getElementById('mNotes').value="";
        renderScorers('m');
    }
    function renderQueue() {
        const qDiv = document.getElementById('matchQueue'); const btn = document.getElementById('btnFinalize');
        qDiv.innerHTML = sessionQueue.map((g, i) => `<div class="queue-item"><div><strong>vs ${g.opp}</strong> (${g.our}-${g.their})<br><small>${formatDateNice(g.date)}</small></div><button class="btn-del" style="font-size:1rem;" onclick="sessionQueue.splice(${i},1); renderQueue()">âœ•</button></div>`).join('');
        btn.classList.toggle('hidden', sessionQueue.length === 0);
    }
    function saveSession() {
        const batchId = Date.now(); sessionQueue.forEach(g => g.batchId = batchId);
        db.history.push(...sessionQueue); sessionQueue = []; save(); renderQueue(); updateAll(); alert("Session Saved!");
    }
    function renderHistoryList(elementId, historyData) {
        const list = document.getElementById(elementId); list.innerHTML = '';
        const h = historyData.reverse();
        const groups = {};
        h.forEach(m => { const bid = m.batchId || m.id; if(!groups[bid]) groups[bid] = []; groups[bid].push(m); });
        
        Object.values(groups).forEach(group => {
            const headerDate = formatDateNice(group[0].date) || "Unknown Date";
            const container = document.createElement('div'); container.className = 'session-card';
            let header = `<div class="session-header"><span>ğŸ“… ${headerDate}</span><small>${group.length} Game(s)</small></div>`;
            let rows = group.map(m => {
                let resClass = m.our > m.their ? 'res-w' : (m.our < m.their ? 'res-l' : 'res-d');
                let details = "";
                if(m.scorers.length) details += `<br><small>âš½ ${m.scorers.join(', ')}</small>`;
                if(m.awards.length) details += `<br><small>ğŸ… ${m.awards.map(a=>a.player).join(', ')}</small>`;
                if(m.notes) details += `<br><small style="color:var(--text-muted);">ğŸ“ <em>${m.notes}</em></small>`;
                
                let notesIcon = m.notes ? '<span title="Has Notes">ğŸ—’ï¸</span> ' : '';

                return `
                    <div class="match-row">
                        <div class="match-info">
                            ${notesIcon}<strong>vs ${m.opp}</strong> <span style="font-size:0.8rem; opacity:0.6">${m.tourn}</span>
                            ${details}
                        </div>
                        <div class="result-badge ${resClass}">${m.our}-${m.their}</div>
                        <div style="margin-left:10px;">
                            <button class="btn-edit" onclick="openEditModal('${m.id}')">âœ</button>
                            <button class="btn-del" onclick="deleteMatch('${m.id}')">ğŸ—‘</button>
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = header + rows; list.appendChild(container);
        });
    }
    function openEditModal(id) {
        const m = db.history.find(x => x.id == id); if(!m) return;
        document.getElementById('editId').value = id;
        document.getElementById('eDate').value = m.date || new Date().toISOString().split('T')[0]; 
        document.getElementById('eOur').value = m.our;
        document.getElementById('eTheir').value = m.their;
        document.getElementById('eNotes').value = m.notes || ""; 
        
        const t = db.teams[m.team];
        const fill = (eid, arr, val) => { const el = document.getElementById(eid); el.innerHTML = ""; arr.forEach(x => el.add(new Option(x,x))); el.value = val; };
        fill('eOpp', t.opps, m.opp); fill('eCoach', t.coaches, m.coach);
        const tournEl = document.getElementById('eTourn'); tournEl.innerHTML = '<option value="League">League</option>';
        if(t.tournaments) t.tournaments.forEach(tr => tournEl.add(new Option("ğŸ† " + tr.name, tr.name)));
        tournEl.value = m.tourn;
        renderScorers('e');
        const sInputs = document.querySelectorAll('.e-sc-input'); m.scorers.forEach((p, i) => { if(sInputs[i]) sInputs[i].value = p; });
        const aInputs = document.querySelectorAll('.e-aw-input'); m.awards.forEach(aw => { const match = Array.from(aInputs).find(inp => inp.dataset.name === aw.name && inp.value === ""); if(match) match.value = aw.player; });
        document.getElementById('editModal').classList.remove('hidden');
    }
    function closeEditModal() { document.getElementById('editModal').classList.add('hidden'); }
    function saveEditedMatch() {
        const id = document.getElementById('editId').value; const idx = db.history.findIndex(x => x.id == id); if(idx === -1) return;
        db.history[idx] = { ...db.history[idx],
            date: document.getElementById('eDate').value, 
            opp: document.getElementById('eOpp').value, tourn: document.getElementById('eTourn').value, coach: document.getElementById('eCoach').value,
            our: parseInt(document.getElementById('eOur').value)||0, their: parseInt(document.getElementById('eTheir').value)||0,
            scorers: Array.from(document.querySelectorAll('.e-sc-input')).map(s => s.value),
            awards: Array.from(document.querySelectorAll('.e-aw-input')).filter(s => s.value).map(s => ({name: s.dataset.name, player: s.value})),
            notes: document.getElementById('eNotes').value
        }; save(); closeEditModal(); updateAll();
    }
    function deleteMatch(id) { if(confirm("Delete match?")) { db.history = db.history.filter(m => m.id != id); save(); updateAll(); } }
    function updateAll() { renderTeamStats(); renderHistoryList('teamHistoryList', db.history.filter(m => m.team === currentView && m.season === db.settings.currentSeason)); renderTeamLeague(); }
    function calcLeague(matches) {
        let stats = {};
        matches.forEach(m => {
            const update = (name, gf, ga) => {
                if(!stats[name]) stats[name] = { name, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0 };
                const s = stats[name]; s.p++; s.gf += gf; s.ga += ga;
                if(gf > ga) { s.w++; s.pts += 3; } else if(gf < ga) { s.l++; s.pts += 0; } else { s.d++; s.pts += 1; }
            }; update(m.team, m.our, m.their); update(m.opp, m.their, m.our);
        });
        return Object.values(stats).sort((a,b) => (b.pts - a.pts) || ((b.gf-b.ga)-(a.gf-a.ga)) || (b.gf-a.gf) || a.name.localeCompare(b.name));
    }
    function renderTeamLeague() {
        const matches = db.history.filter(m => m.team === currentView && m.season === db.settings.currentSeason);
        const data = calcLeague(matches);
        document.querySelector('#teamLeagueTable tbody').innerHTML = data.map((t, i) => `<tr class="${t.name === currentView ? 'pos-1' : ''}"><td class="t-left">${i+1}. ${t.name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td><td>${t.gf - t.ga}</td><td><b>${t.pts}</b></td></tr>`).join('');
    }
    function renderCareer() {
        const sel = document.getElementById('careerSeasonFilter');
        if(sel.options.length <= 1) { db.settings.seasons.forEach(s => sel.add(new Option(s, s))); }
        const filter = sel.value;
        let h = db.history;
        if(filter !== 'All Time') h = h.filter(m => m.season === filter);

        document.getElementById('c-p').innerText = h.length;
        document.getElementById('c-w').innerText = h.filter(m => m.our > m.their).length;
        document.getElementById('c-g').innerText = h.reduce((acc, m) => acc + m.scorers.filter(p => p === "Joey").length, 0);
        document.getElementById('c-a').innerText = h.reduce((acc, m) => acc + m.awards.filter(a => a.player === "Joey").length, 0);
        
        const myTeams = Object.keys(db.teams);
        const allStats = calcLeague(h);
        const filteredStats = allStats.filter(t => myTeams.includes(t.name));
        document.querySelector('#masterTable tbody').innerHTML = filteredStats.map((t, i) => `<tr class="${i===0 ? 'pos-1' : ''}"><td class="t-left">${i+1}. ${t.name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td><td>${t.gf - t.ga}</td><td>${t.gf}</td><td><b>${t.pts}</b></td></tr>`).join('');
    }
    function renderTeamStats() {
        const h = db.history.filter(m => m.team === currentView && m.season === db.settings.currentSeason);
        document.getElementById('st-p').innerText = h.length;
        document.getElementById('st-w').innerText = h.filter(m => m.our > m.their).length;
        let g=0, a=0; h.forEach(m => { g+=m.scorers.filter(p=>p==="Joey").length; a+=m.awards.filter(x=>x.player==="Joey").length; });
        document.getElementById('st-g').innerText = g; document.getElementById('st-a').innerText = a;
    }

    init();
</script>
</body>
</html>
