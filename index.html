<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joey's Career Tracker V13</title>
    <style>
        :root { 
            --bg: #f0f2f5; --card: #ffffff; --text: #333; --border: #ddd; 
            --team-primary: #333; --btn-text: #fff; 
        }
        [data-theme="dark"] { 
            --bg: #121212; --card: #1e1e1e; --text: #e0e0e0; --border: #444; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); padding: 10px; margin: 0; transition: 0.3s; }
        .container { max-width: 600px; background: var(--card); padding: 15px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin: auto; border-top: 5px solid var(--team-primary); }

        .header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .team-switcher { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; justify-content: center; }
        .team-select-btn { flex: 1; min-width: 120px; padding: 12px; border: 2px solid transparent; border-radius: 8px; font-weight: bold; cursor: pointer; opacity: 0.5; transition: 0.2s; filter: grayscale(0.5); }
        .team-select-btn.active { opacity: 1; transform: scale(1.02); filter: grayscale(0); border-color: var(--text); box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .tabs { display: flex; gap: 5px; margin-bottom: 20px; border-bottom: 2px solid var(--border); padding-bottom: 10px; }
        .tab-btn { background: none; border: none; font-size: 0.85rem; font-weight: bold; color: var(--text); opacity: 0.6; padding: 10px 5px; cursor: pointer; flex: 1; text-align: center; border-radius: 6px; }
        .tab-btn.active { opacity: 1; background: var(--team-primary); color: var(--btn-text); }
        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }

        .stats-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; margin-bottom: 20px; text-align: center; }
        .stat-box { background: var(--team-primary); color: var(--btn-text); padding: 12px 5px; border-radius: 8px; font-size: 0.75rem; text-transform: uppercase; border: 1px solid rgba(0,0,0,0.1); }
        .stat-box b { display: block; font-size: 1.5rem; margin-bottom: 2px; }

        .form-group { margin-bottom: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        select, input { width: 100%; padding: 12px; background: var(--card); color: var(--text); border: 1px solid var(--border); border-radius: 8px; box-sizing: border-box; font-size: 1rem; }
        button { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; transition: 0.2s; }
        .btn-add { background: var(--team-primary); color: var(--btn-text); width: 100%; margin: 10px 0; }
        .btn-tool { background: #6c757d; color: white; padding: 8px 12px; font-size: 0.8rem; }
        .tag { font-size: 0.7rem; font-weight: bold; padding: 2px 6px; border-radius: 4px; display: inline-block; }

        .award-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; align-items: center; margin-bottom: 8px; background: rgba(0,0,0,0.02); padding: 5px; border-radius: 6px; }

        .joey-card { 
            background: linear-gradient(135deg, #FFD700, #DAA520); 
            color: #333; padding: 20px; border-radius: 12px; text-align: center; 
        }
        .joey-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; margin-top: 15px; }
        .joey-stat { background: rgba(255,255,255,0.4); padding: 8px 2px; border-radius: 8px; }

        .modal { display: none; position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); overflow-y: auto; }
        .modal-content { background: var(--card); margin: 15% auto; padding: 25px; border-radius: 12px; width: 85%; max-width: 500px; color: var(--text); }
        
        table { width: 100%; margin-top: 20px; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 10px 5px; border-bottom: 1px solid var(--border); text-align: center; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-row">
        <h2 style="margin:0; color:var(--team-primary);">‚öΩ Joey's Tracker</h2>
        <div style="display:flex; gap:8px;">
            <button class="btn-tool" onclick="showGuide()">üìñ Guide</button>
            <button class="btn-tool" onclick="toggleTheme()">üåì</button>
        </div>
    </div>

    <div id="teamSwitcherContainer" class="team-switcher"></div>

    <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('match')">Match Day</button>
        <button class="tab-btn" onclick="switchTab('stats')">Career Stats</button>
        <button class="tab-btn" onclick="switchTab('admin')">Admin</button>
    </div>

    <div id="match" class="tab-content active">
        <div class="stats-row">
            <div class="stat-box">Played<b id="st-m">0</b></div>
            <div class="stat-box">Wins<b id="st-w">0</b></div>
            <div class="stat-box">Goals<b id="st-g">0</b></div>
        </div>

        <div class="form-group">
            <label>üèÜ Competition:</label>
            <select id="tournSelect"><option value="">League</option></select>
        </div>
        <div class="form-group">
            <label>Opponent:</label>
            <select id="oppList"></select>
        </div>
        <div class="form-group">
            <label>Coach / Manager:</label>
            <select id="managerSelect"></select>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div><label>Our Score:</label><input type="number" id="hS" value="0" oninput="updateScorerInputs()"></div>
            <div><label>Opp Score:</label><input type="number" id="aS" value="0"></div>
        </div>
        
        <div id="scorerContainer" class="form-group" style="margin-top:10px;"></div>

        <div id="awardsContainer" class="form-group">
            <label>üèÖ Match Awards:</label>
            <div id="awardListMatch"></div>
        </div>

        <button id="saveMatchBtn" class="btn-add" onclick="saveMatch()">Save Match Result</button>
        <button id="cancelEditBtn" class="btn-tool" style="display:none; width:100%; margin-bottom:10px;" onclick="cancelEdit()">Cancel Edit</button>
        
        <table id="matchTable"><thead><tr><th>Match</th><th>Score</th><th>Scorers/Awards</th><th>Actions</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="stats" class="tab-content">
        <div class="joey-card">
            <h3>üèÜ All-Time Career</h3>
            <div class="joey-grid">
                <div class="joey-stat"><span>Games</span><strong id="j-played">0</strong></div>
                <div class="joey-stat"><span>Wins</span><strong id="j-wins">0</strong></div>
                <div class="joey-stat"><span>Goals</span><strong id="j-goals">0</strong></div>
                <div class="joey-stat"><span>Win %</span><strong id="j-perc">0%</strong></div>
            </div>
        </div>
        <h3 style="margin-top:20px;">üìä Stats by Team</h3>
        <table id="leagueTable"><thead><tr><th>Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GF</th><th>GA</th></tr></thead><tbody></tbody></table>
        <h3 style="margin-top:20px;">‚öΩ Leaders</h3>
        <table id="scorerTable"><thead><tr><th>Player</th><th>Team</th><th>Goals</th><th>Aw.</th></tr></thead><tbody></tbody></table>
    </div>

    <div id="admin" class="tab-content">
        <p>Managing: <b id="adminTeamLabel"></b></p>
        
        <div style="background: rgba(0,0,0,0.03); padding:10px; border-radius:8px; margin-bottom:15px;">
            <label><strong>üèÖ Manage Custom Awards</strong></label>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input type="text" id="newAwardName" placeholder="e.g. Spectators Player">
                <button class="btn-tool" style="background:#28a745" onclick="addCustomAward()">Add</button>
            </div>
            <ul id="customAwardList" style="padding:0; list-style:none;"></ul>
        </div>

        <div style="background: rgba(255, 215, 0, 0.1); padding:10px; border-radius:8px; border:1px solid #FFD700; margin-bottom:15px;">
            <label><strong>üèÜ Tournaments</strong></label>
            <div style="display:flex; gap:5px;"><input type="text" id="newTournName"><button class="btn-tool" onclick="addTournament()">Create</button></div>
            <ul id="activeTournList" style="padding:0; list-style:none;"></ul>
        </div>

        <div class="form-group"><label>Add Player:</label><div style="display:flex; gap:5px;"><input type="text" id="newPlayerName"><button class="btn-tool" onclick="addItem('players','newPlayerName')">Add</button></div><ul id="playerList" style="padding:0; list-style:none;"></ul></div>
        <div class="form-group"><label>Add Coach:</label><div style="display:flex; gap:5px;"><input type="text" id="newCoachName"><button class="btn-tool" onclick="addItem('coaches','newCoachName')">Add</button></div><ul id="coachList" style="padding:0; list-style:none;"></ul></div>
        <div class="form-group"><label>Add Opponent:</label><div style="display:flex; gap:5px;"><input type="text" id="newOppName"><button class="btn-tool" onclick="addItem('opps','newOppName')">Add</button></div><ul id="oppListAdmin" style="padding:0; list-style:none;"></ul></div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:20px;">
            <button class="btn-tool" style="background:#28a745" onclick="exportData()">üíæ Export</button>
            <button class="btn-tool" style="background:#1a73e8" onclick="document.getElementById('importInput').click()">üìÇ Import</button>
            <input type="file" id="importInput" style="display:none" onchange="importData(event)">
            <button class="btn-tool" style="background:#dc3545; grid-column: span 2;" onclick="resetAll()">‚ö†Ô∏è Factory Reset</button>
        </div>
    </div>
</div>

<div id="guideModal" class="modal">
    <div class="modal-content">
        <h2 style="margin-top:0">üìñ User Guide V13</h2>
        <p><strong>1. Editing Matches:</strong> Notice a mistake? Use the <strong>Edit</strong> button in the history table to reload a match and fix scores, scorers, or awards.</p>
        <p><strong>2. Custom Awards:</strong> In <strong>Admin</strong>, you can create specific awards for your team. These will appear as checkboxes on the Match Day screen.</p>
        <p><strong>3. Saving History:</strong> After editing, the "Update Match" button replaces the original record so your career stats stay accurate.</p>
        <button class="btn-add" onclick="closeGuide()">Understood!</button>
    </div>
</div>

<script>
    const defaultData = {
        "Llanelli Town": { active: true, color: "#d32f2f", opps: [], players: ["Joey"], coaches: [], tournaments: [], customAwards: ["Man of the Match"] },
        "Dunvant": { active: true, color: "#fdd835", opps: [], players: ["Joey"], coaches: [], tournaments: [], customAwards: ["Player of the Week"] }
    };

    let appData = JSON.parse(localStorage.getItem('footy_v13_data')) || defaultData;
    let history = JSON.parse(localStorage.getItem('footy_v13_hist')) || [];
    let activeTeam = Object.keys(appData)[0];
    let editIndex = -1;

    function saveData() { 
        localStorage.setItem('footy_v13_data', JSON.stringify(appData));
        localStorage.setItem('footy_v13_hist', JSON.stringify(history));
    }

    function setActiveTeam(team) { 
        activeTeam = team; 
        renderTeamButtons(); loadMatchOptions(); renderAdminLists(); renderAwardsInput();
    }

    function renderTeamButtons() {
        const container = document.getElementById('teamSwitcherContainer');
        container.innerHTML = "";
        Object.keys(appData).forEach(t => {
            const btn = document.createElement('button');
            btn.className = `team-select-btn ${t === activeTeam ? 'active' : ''}`;
            btn.style.backgroundColor = appData[t].color;
            btn.style.color = (appData[t].color === '#fdd835') ? '#1b5e20' : '#fff';
            btn.innerText = t;
            btn.onclick = () => setActiveTeam(t);
            container.appendChild(btn);
        });
        document.documentElement.style.setProperty('--team-primary', appData[activeTeam].color);
        document.documentElement.style.setProperty('--btn-text', (appData[activeTeam].color === '#fdd835') ? '#1b5e20' : '#fff');
    }

    function loadMatchOptions() {
        const oppS = document.getElementById('oppList'), mgrS = document.getElementById('managerSelect'), tournS = document.getElementById('tournSelect');
        oppS.innerHTML = ""; mgrS.innerHTML = "<option>None</option>";
        tournS.innerHTML = '<option value="">League</option>';
        if(appData[activeTeam]) {
            appData[activeTeam].opps.forEach(o => oppS.add(new Option(o,o)));
            appData[activeTeam].coaches.forEach(c => mgrS.add(new Option(c,c)));
            appData[activeTeam].tournaments.forEach(t => { if(t.active) tournS.add(new Option("üèÜ " + t.name, t.name)); });
        }
    }

    function renderAwardsInput() {
        const list = document.getElementById('awardListMatch');
        list.innerHTML = "";
        const awards = appData[activeTeam].customAwards || [];
        awards.forEach(aw => {
            const div = document.createElement('div');
            div.className = "award-row";
            div.innerHTML = `<span>${aw}</span><select class="match-award-select" data-award="${aw}"><option value="">- Select -</option></select>`;
            const sel = div.querySelector('select');
            appData[activeTeam].players.forEach(p => sel.add(new Option(p,p)));
            list.appendChild(div);
        });
    }

    function updateScorerInputs() {
        const score = parseInt(document.getElementById('hS').value) || 0;
        const container = document.getElementById('scorerContainer');
        container.innerHTML = "";
        for(let i=1; i<=score; i++) {
            const sel = document.createElement('select');
            sel.className = "dynamic-scorer-select";
            sel.style.marginBottom = "5px";
            appData[activeTeam].players.forEach(p => sel.add(new Option(p,p)));
            container.appendChild(sel);
        }
    }

    function saveMatch() {
        const scorers = Array.from(document.querySelectorAll('.dynamic-scorer-select')).map(s => s.value);
        const awards = Array.from(document.querySelectorAll('.match-award-select'))
            .filter(s => s.value !== "").map(s => ({ name: s.getAttribute('data-award'), player: s.value }));

        const entry = {
            t: activeTeam, o: document.getElementById('oppList').value,
            tourn: document.getElementById('tournSelect').value,
            h: parseInt(document.getElementById('hS').value) || 0,
            aS: parseInt(document.getElementById('aS').value) || 0,
            s: scorers, aw: awards, coach: document.getElementById('managerSelect').value
        };

        if(editIndex > -1) {
            history[editIndex] = entry;
            editIndex = -1;
            document.getElementById('saveMatchBtn').innerText = "Save Match Result";
            document.getElementById('cancelEditBtn').style.display = "none";
        } else {
            history.push(entry);
        }
        
        saveData();
        clearMatchForm();
        renderHistory();
        alert("Success!");
    }

    function editMatch(idx) {
        editIndex = idx;
        const m = history[idx];
        setActiveTeam(m.t);
        document.getElementById('oppList').value = m.o;
        document.getElementById('tournSelect').value = m.tourn;
        document.getElementById('hS').value = m.h;
        document.getElementById('aS').value = m.aS;
        document.getElementById('managerSelect').value = m.coach;
        
        updateScorerInputs();
        const scorerSels = document.querySelectorAll('.dynamic-scorer-select');
        m.s.forEach((name, i) => { if(scorerSels[i]) scorerSels[i].value = name; });

        renderAwardsInput();
        const awardSels = document.querySelectorAll('.match-award-select');
        m.aw.forEach(awardObj => {
            const sel = Array.from(awardSels).find(s => s.getAttribute('data-award') === awardObj.name);
            if(sel) sel.value = awardObj.player;
        });

        document.getElementById('saveMatchBtn').innerText = "Update Match Result";
        document.getElementById('cancelEditBtn').style.display = "block";
        window.scrollTo(0,0);
    }

    function cancelEdit() {
        editIndex = -1;
        clearMatchForm();
        document.getElementById('saveMatchBtn').innerText = "Save Match Result";
        document.getElementById('cancelEditBtn').style.display = "none";
    }

    function clearMatchForm() {
        document.getElementById('hS').value = 0;
        document.getElementById('aS').value = 0;
        updateScorerInputs();
        renderAwardsInput();
    }

    function deleteMatch(idx) {
        if(confirm("Delete match?")) { history.splice(idx, 1); saveData(); renderHistory(); }
    }

    function renderHistory() {
        const tbody = document.querySelector("#matchTable tbody");
        tbody.innerHTML = "";
        [...history].reverse().forEach((x, i) => {
            const realIdx = history.length - 1 - i;
            const row = tbody.insertRow();
            const tm = appData[x.t];
            const c = tm ? tm.color : '#666';
            const tc = (c === '#fdd835') ? '#1b5e20' : '#fff';
            
            row.insertCell(0).innerHTML = `<span class="tag" style="background:${c}; color:${tc}">${x.t}</span><br>${x.o}<br><small>${x.coach}</small>`;
            row.insertCell(1).innerHTML = `<b>${x.h}-${x.aS}</b>`;
            
            const scorers = x.s.join(', ');
            const awards = x.aw.map(a => `üèÖ ${a.name}: ${a.player}`).join('<br>');
            row.insertCell(2).innerHTML = `<small>‚öΩ ${scorers}<br>${awards}</small>`;
            
            row.insertCell(3).innerHTML = `<button class="btn-tool" onclick="editMatch(${realIdx})">Edit</button><br><button class="btn-tool" style="background:#dc3545;margin-top:5px" onclick="deleteMatch(${realIdx})">üóë</button>`;
        });
        updateDashboard();
    }

    function updateDashboard() {
        const h = history.filter(m => m.t === activeTeam);
        document.getElementById('st-m').innerText = h.length;
        document.getElementById('st-w').innerText = h.filter(m => m.h > m.aS).length;
        let goals = 0; h.forEach(m => m.s.forEach(p => { if(p === "Joey") goals++; }));
        document.getElementById('st-g').innerText = goals;
    }

    function calculateStats() {
        let jP = 0, jW = 0, jG = 0, teams = {}, scorers = {};
        history.forEach(m => {
            jP++; if(m.h > m.aS) jW++;
            if(!teams[m.t]) teams[m.t] = { p:0, w:0, gf:0, ga:0 };
            teams[m.t].p++; teams[m.t].gf += m.h; teams[m.t].ga += m.aS; if(m.h > m.aS) teams[m.t].w++;
            
            m.s.forEach(p => {
                if(p === "Joey") jG++;
                const k = `${p}|${m.t}`; scorers[k] = scorers[k] || { g:0, a:0 }; scorers[k].g++;
            });
            m.aw.forEach(a => {
                const k = `${a.player}|${m.t}`; scorers[k] = scorers[k] || { g:0, a:0 }; scorers[k].a++;
            });
        });
        document.getElementById('j-played').innerText = jP;
        document.getElementById('j-wins').innerText = jW;
        document.getElementById('j-goals').innerText = jG;
        document.getElementById('j-perc').innerText = jP ? Math.round((jW/jP)*100)+'%' : '0%';
        
        const lb = document.querySelector("#leagueTable tbody"); lb.innerHTML = "";
        Object.entries(teams).forEach(([n, t]) => {
            lb.insertRow().innerHTML = `<td>${n}</td><td>${t.p}</td><td>${t.w}</td><td>${t.p-t.w}</td><td>-</td><td>${t.gf}</td><td>${t.ga}</td>`;
        });
        const sb = document.querySelector("#scorerTable tbody"); sb.innerHTML = "";
        Object.entries(scorers).sort((a,b) => b[1].g - a[1].g).forEach(([k, v]) => {
            const [n, t] = k.split('|');
            lb.insertRow(); sb.insertRow().innerHTML = `<td>${n}</td><td>${t}</td><td>${v.g}</td><td>${v.a}</td>`;
        });
    }

    function renderAdminLists() {
        document.getElementById('adminTeamLabel').innerText = activeTeam;
        ['players', 'coaches', 'opps'].forEach(cat => {
            const el = document.getElementById(cat === 'players' ? 'playerList' : cat === 'coaches' ? 'coachList' : 'oppListAdmin');
            el.innerHTML = "";
            appData[activeTeam][cat].forEach((item, idx) => {
                const li = document.createElement('li'); li.style = "display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid var(--border)";
                li.innerHTML = `<span>${item}</span><button style="color:red; background:none; border:none" onclick="deleteItem('${cat}',${idx})">üóë</button>`;
                el.appendChild(li);
            });
        });
        renderAwardAdmin();
    }

    function addCustomAward() {
        const name = document.getElementById('newAwardName').value.trim();
        if(!name) return;
        if(!appData[activeTeam].customAwards) appData[activeTeam].customAwards = [];
        appData[activeTeam].customAwards.push(name);
        saveData(); document.getElementById('newAwardName').value = ""; renderAwardAdmin(); renderAwardsInput();
    }

    function renderAwardAdmin() {
        const ul = document.getElementById('customAwardList'); ul.innerHTML = "";
        (appData[activeTeam].customAwards || []).forEach((aw, idx) => {
            const li = document.createElement('li'); li.style = "display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid var(--border)";
            li.innerHTML = `<span>${aw}</span><button style="color:red; background:none; border:none" onclick="deleteAward(${idx})">üóë</button>`;
            ul.appendChild(li);
        });
    }

    function deleteAward(idx) { appData[activeTeam].customAwards.splice(idx,1); saveData(); renderAwardAdmin(); renderAwardsInput(); }
    function addItem(cat, id) { const v = document.getElementById(id).value; if(v){ appData[activeTeam][cat].push(v); saveData(); document.getElementById(id).value=""; renderAdminLists(); loadMatchOptions(); }}
    function deleteItem(cat, idx) { appData[activeTeam][cat].splice(idx,1); saveData(); renderAdminLists(); loadMatchOptions(); }
    function switchTab(t) { document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active')); document.getElementById(t).classList.add('active'); event.target.classList.add('active'); if(t==='stats') calculateStats(); }
    function toggleTheme() { const b = document.body; b.setAttribute('data-theme', b.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function showGuide() { document.getElementById('guideModal').style.display='block'; }
    function closeGuide() { document.getElementById('guideModal').style.display='none'; }
    function exportData() { const b = new Blob([JSON.stringify({appData, history})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download='JoeyCareer.json'; a.click(); }
    function importData(e) { const r = new FileReader(); r.onload = (ev) => { const d = JSON.parse(ev.target.result); appData = d.appData; history = d.history; saveData(); location.reload(); }; r.readAsText(e.target.files[0]); }
    function resetAll() { if(confirm("FULL RESET?")) { localStorage.clear(); location.reload(); } }

    setActiveTeam(activeTeam);
    renderHistory();
</script>
</body>
</html>
