<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joey's Career Tracker V51</title>
    <style>
        :root { 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --text: #1f1f1f; 
            --text-muted: #666;
            --border: #e1e4e8; 
            --primary: #333; 
            --primary-tint: #f8f9fa; 
            --text-on-primary: #fff;
            --success: #28a745;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --tourn-color: #6f42c1;
        }
        
        [data-theme="dark"] { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #e4e6eb; 
            --text-muted: #b0b3b8;
            --border: #383838; 
            --primary-tint: #252525;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --tourn-color: #a76dff;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: background 0.3s, color 0.3s; }

        /* NAV */
        .nav-container { background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-primary { display: flex; padding: 10px 15px; align-items: center; border-bottom: 1px solid var(--border); flex-wrap: wrap; gap: 10px; }
        .nav-scroll-area { display: flex; gap: 10px; overflow-x: auto; flex: 1; min-width: 200px; align-items: center; }
        .nav-controls { display: flex; gap: 8px; align-items: center; margin-left: auto; flex-wrap: wrap; justify-content: flex-end; }
        
        .nav-secondary { display: flex; padding: 0 15px; background: var(--primary-tint); gap: 20px; overflow-x: auto; border-bottom: 1px solid var(--border); }
        
        .nav-btn { padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.9rem; white-space: nowrap; opacity: 0.6; transition: 0.2s; border: 2px solid transparent; }
        .nav-btn.active { opacity: 1; background: var(--primary); color: var(--text-on-primary); transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        
        .nav-btn.career { border-color: #ffd700; color: #b8860b; background: transparent; }
        .nav-btn.career.active { background: linear-gradient(135deg, #ffd700, #daa520); color: #000; border-color: transparent; }
        
        .nav-btn.admin { background: #e9ecef; color: #333; }
        .nav-btn.admin.active { background: #333; color: #fff; }
        
        .ctl-btn { background: transparent; border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 8px; font-size: 0.75rem; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 4px; }
        .ctl-btn:hover { background: var(--primary-tint); }
        .season-tag { font-size: 0.75rem; font-weight: bold; color: var(--primary); background: var(--primary-tint); padding: 4px 8px; border-radius: 6px; border: 1px solid var(--border); }

        .tab-btn { padding: 12px 10px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); border-bottom: 3px solid transparent; opacity: 0.7; transition: 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); opacity: 1; font-weight: 700; }

        .container { max-width: 800px; margin: 25px auto; padding: 0 15px; }
        
        /* CARD STYLES */
        .card { background: var(--card); border-radius: 16px; padding: 0; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
        .card-header { font-size: 1.1rem; font-weight: 800; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center; background: var(--primary-tint); color: var(--primary); border-bottom: 1px solid var(--border); }
        .card-body { padding: 20px; }
        
        /* NEUTRAL CARD (Global Settings) */
        .neutral-card .card-header { background: #f0f2f5; color: #333; }
        [data-theme="dark"] .neutral-card .card-header { background: #252525; color: #eee; }

        details > summary { list-style: none; cursor: pointer; outline: none; font-weight: bold; font-size: 1.1rem; }
        details > summary::after { content: ' â–¼'; float: right; font-size: 0.8em; opacity: 0.5; }
        details[open] > summary::after { transform: rotate(180deg); }

        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item { background: var(--bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-item strong { font-size: 1.5rem; color: var(--primary); display: block; line-height: 1; }
        
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; background: var(--card); color: var(--text); box-sizing: border-box; }
        
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .flex-grow { flex: 1; min-width: 0; }
        .color-picker { width: 50px; padding: 2px; height: 45px; cursor: pointer; border-radius: 8px; border: 1px solid var(--border); }

        /* HISTORY */
        .history-group { border: 1px solid var(--border); border-radius: 12px; margin-bottom: 20px; overflow: hidden; background: var(--card); box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        .group-header { background: var(--primary-tint); padding: 10px 15px; font-size: 0.9rem; font-weight: bold; color: var(--primary); border-bottom: 1px solid var(--border); display:flex; justify-content:space-between; align-items: center; }
        
        .match-row { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; background: var(--card); gap: 10px; }
        .match-row:last-child { border-bottom: none; }
        .match-info { flex: 1; } 
        .result-badge { padding: 6px 10px; border-radius: 8px; font-weight: 800; font-size: 0.95rem; min-width: 40px; text-align: center; }
        .res-w { background: rgba(40, 167, 69, 0.15); color: #28a745; }
        .res-l { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
        .res-d { background: rgba(255, 193, 7, 0.15); color: #d39e00; }
        .match-actions { display: flex; align-items: center; gap: 5px; }

        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 0.95rem; margin-top:5px; transition: 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-add { background: var(--primary); color: var(--text-on-primary); }
        .btn-save { background: var(--success); color: white; }
        .btn-del { background: transparent; color: var(--danger); font-size: 1.1rem; border: none; cursor:pointer; }
        .btn-edit { background: transparent; color: #3b82f6; font-size: 1.2rem; border: none; cursor:pointer; }
        .btn-google { background: #4285F4; color: white; margin-bottom: 10px; }
        .btn-guest { background: transparent; border: 2px solid var(--border); color: var(--text); }
        
        .admin-list li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); align-items: center; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: var(--primary-tint); color: var(--primary); padding: 12px 8px; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; }
        .t-left { text-align: left; }
        .is-me { background: var(--primary-tint); font-weight: bold; }

        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-box { background: var(--card); padding: 25px; border-radius: 16px; width: 100%; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        #authOverlay, #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; padding: 20px; text-align: center; }
        .auth-card { background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px; width: 100%; border: 1px solid var(--border); }
    </style>
</head>
<body>

<div id="loadingOverlay"><h2>â˜ï¸ Syncing...</h2></div>
<div id="authOverlay" class="hidden">
    <div class="auth-card">
        <h2 style="margin-top:0;">âš½ Joey's Tracker</h2>
        <button id="btnLogin" class="btn btn-google">Sign in with Google</button>
        <button id="btnGuest" class="btn btn-guest" onclick="app.enterAsGuest()">Guest View</button>
    </div>
</div>

<div class="nav-container hidden" id="mainNav">
    <div class="nav-primary"><div class="nav-scroll-area" id="navTeamList"></div><div class="nav-controls" id="navControls"></div></div>
    <div class="nav-secondary hidden" id="navSecondary">
        <div class="tab-btn" id="tabStats" onclick="ui.switchSubTab('Stats')">ğŸ“Š Stats & Input</div>
        <div class="tab-btn" id="tabTourn" onclick="ui.switchSubTab('Tournaments')">ğŸ† Tournaments</div>
    </div>
</div>

<div class="container hidden" id="mainApp">
    <div id="viewMatchDay" class="hidden">
        <div class="card"><div class="card-header">ğŸ“Š <span id="teamStatTitle">Stats</span></div><div class="card-body"><div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="st-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="st-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="st-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="st-a">0</strong></div></div></div></div>
        <div class="card protected-area"><details><summary class="card-header">âš½ Match Day Input</summary><div class="card-body"><div class="form-group"><label>Date:</label><input type="date" id="mDate"></div><div class="form-group"><label>Competition:</label><select id="mTourn"><option value="League">League</option></select></div><div class="form-row"><div><label>Opponent:</label><select id="mOpp"></select></div><div><label>Manager:</label><select id="mCoach"></select></div></div><div class="form-row"><div><label>Us:</label><input type="number" id="mOur" value="0" oninput="ui.renderScorers('m')"></div><div><label>Them:</label><input type="number" id="mTheir" value="0"></div></div><div id="mScorerList" class="form-group"></div><div id="mAwardList" class="form-group"></div><div class="form-group"><label>Notes:</label><textarea id="mNotes" rows="2"></textarea></div><button type="button" class="btn btn-add" onclick="app.addToQueue()">+ Add Game</button><div id="matchQueue"></div><button type="button" id="btnFinalize" class="btn btn-save hidden" onclick="app.saveSession()">ğŸ’¾ Save Session</button></div></details></div>
        <div class="card"><details open><summary class="card-header">ğŸ† League Table</summary><div class="card-body" style="padding:0;"><table id="teamLeagueTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody></tbody></table></div></details></div>
        <div class="card"><details open><summary class="card-header">ğŸ•’ Match History</summary><div class="card-body" id="teamHistoryList" style="padding:10px;"></div></details></div>
    </div>
    <div id="viewTournaments" class="hidden"><div class="card" style="border-color: var(--tourn-color);"><div class="card-header" style="background:rgba(111, 66, 193, 0.05); color:var(--tourn-color);">ğŸ† Tournament Hub</div><div class="card-body"><select id="tournSelector" onchange="ui.renderTournamentView()"></select><div id="tournStatsArea" class="hidden"><div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="tr-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="tr-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="tr-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="tr-a">0</strong></div></div><div id="tournHistoryList"></div></div></div></div></div>
    <div id="viewCareer" class="hidden">
        <div class="card" style="border-color: #DAA520;"><div class="card-header" style="color: #B8860B; background:rgba(218, 165, 32, 0.1);"><span>ğŸŒŸ Career Overview</span><select id="careerSeasonFilter" onchange="ui.renderCareer()" style="width:auto;"><option value="All Time">All Time</option></select></div><div class="card-body"><div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="c-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="c-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="c-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="c-a">0</strong></div></div></div></div>
        <div class="card"><div class="card-header" style="color:#B8860B; background:rgba(218, 165, 32, 0.1);">ğŸ† Your Clubs Comparison</div><div class="card-body" style="padding:0;"><table id="masterTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>GF</th><th>Pts</th></tr></thead><tbody></tbody></table></div></div>
    </div>
    <div id="viewAdmin" class="hidden protected-area">
        <h2 style="margin-bottom:20px;">âš™ï¸ Admin</h2>
        <div class="card">
            <div class="card-header">ğŸ›  Select Team</div>
            <div class="card-body">
                <div class="flex-row">
                    <select id="admTeamSelect" onchange="ui.renderAdminDetails()" class="flex-grow"></select>
                    <button class="btn-edit" style="font-size:0.9rem; width:auto;" onclick="app.renameTeamPrompt()">Rename</button>
                </div>
            </div>
        </div>
        <div class="card"><div class="card-header">ğŸ“… Season</div><div class="card-body"><div class="flex-row"><select id="admActiveSeason" onchange="app.switchActiveSeason()" class="flex-grow"></select><button class="btn-del" style="width:auto;" onclick="app.deleteSeason()">ğŸ—‘</button></div><button class="btn btn-save" onclick="document.getElementById('newSeasonModal').classList.remove('hidden')">â• New Season</button></div></div>
        <div class="card"><div class="card-header">ğŸƒâ€â™‚ï¸ Squad</div><div class="card-body"><div class="form-group flex-row"><input type="text" id="admNewPlayer" placeholder="Add Player" class="flex-grow"><button class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddItem('players', 'admNewPlayer')">Add</button></div><ul id="admPlayerList" class="admin-list"></ul></div></div>
        <div class="card"><div class="card-header">ğŸ›¡ Opponents</div><div class="card-body"><div class="form-group flex-row"><input type="text" id="admNewOpp" placeholder="Add Opponent" class="flex-grow"><button class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddItem('opps', 'admNewOpp')">Add</button></div><ul id="admOppList" class="admin-list"></ul></div></div>
        <div class="card"><div class="card-header">ğŸ… Awards</div><div class="card-body"><div class="flex-row" style="margin-bottom:10px;"><input type="text" id="newAwardName" placeholder="Name" class="flex-grow"><input type="number" id="newAwardMax" placeholder="Max" style="width:70px;"><button class="btn btn-save" style="width:auto; margin-top:0;" onclick="app.addAwardConfig()">Add</button></div><ul id="admAwardList" class="admin-list"></ul></div></div>
        <div class="card neutral-card">
            <div class="card-header">ğŸŒ Global Settings</div>
            <div class="card-body">
                <label style="display:block; margin-bottom:5px;">Add Club:</label>
                <div class="flex-row">
                    <input type="text" id="newTeamName" placeholder="Club Name" class="flex-grow">
                    <input type="color" id="newTeamColor" value="#333333" class="color-picker">
                    <button class="btn btn-add" style="width:auto; margin-top:0; background:#333;" onclick="app.addTeam()">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="editModal" class="modal-overlay hidden"><div class="modal-box"><h3>Edit Match</h3><input type="hidden" id="editId"><input type="date" id="eDate"><select id="eTourn"></select><select id="eOpp"></select><input type="number" id="eOur" oninput="ui.renderScorers('e')"><input type="number" id="eTheir"><div id="eScorerList"></div><div id="eAwardList"></div><textarea id="eNotes"></textarea><button class="btn btn-save" onclick="app.saveEditedMatch()">Save</button><button class="btn" onclick="document.getElementById('editModal').classList.add('hidden')">Cancel</button></div></div>
<div id="addTournModal" class="modal-overlay hidden"><div class="modal-box"><h3>Create Tournament</h3><input type="text" id="newTournNameModal" placeholder="Name"><button class="btn btn-save" onclick="app.createTournamentFromHub()">Create</button><button class="btn" onclick="document.getElementById('addTournModal').classList.add('hidden')">Cancel</button></div></div>
<div id="newSeasonModal" class="modal-overlay hidden"><div class="modal-box"><h3>New Season</h3><input type="text" id="newSeasonNameInput" placeholder="YYYY/YY"><button class="btn btn-save" onclick="app.startNewSeason()">Start</button><button class="btn" onclick="document.getElementById('newSeasonModal').classList.add('hidden')">Cancel</button></div></div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAkhLB-XkffuTny8yJOw_FCtZSRIo5qQLE", authDomain: "joeyfootball-875eb.firebaseapp.com", databaseURL: "https://joeyfootball-875eb-default-rtdb.europe-west1.firebasedatabase.app", projectId: "joeyfootball-875eb", storageBucket: "joeyfootball-875eb.firebasestorage.app", messagingSenderId: "647816306796", appId: "1:647816306796:web:686918e1d1c82b8a17f849", measurementId: "G-PX5PH27CES" };
    const ALLOWED_UIDS = ["QC6D1Smr9SVgpITffUTrRZSTQEq1", "Np9ZXcd2wNWvwsYA3X1QTcFpSIB3"];
    let app, auth, rtdb, globalData, activeContext = "Llanelli Town", activeSubTab = "Stats", sessionQueue = [], currentUser = null, isGuest = false;

    try { app = initializeApp(firebaseConfig); rtdb = getDatabase(app); auth = getAuth(app); } catch (e) { document.getElementById('loadingOverlay').innerHTML = "<h2>âš ï¸ Error</h2><p>Firebase Failed</p>"; }
    document.getElementById('btnLogin').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    window.app = window.app || {};
    window.app.enterAsGuest = () => { isGuest = true; currentUser = { uid: "GUEST" }; document.getElementById('authOverlay').classList.add('hidden'); listenToData(); };
    window.app.doSignOut = () => { isGuest = false; signOut(auth).then(() => window.location.reload()); };

    onAuthStateChanged(auth, (user) => { if (isGuest) return; currentUser = class="nav-primary">
        <div class="nav-scroll-area" id="navTeamList"></div>
        <div class="nav-controls" id="navControls"></div>
    </div>
    <div class="nav-secondary hidden" id="navSecondary">
        <div class="tab-btn" id="tabStats" onclick="ui.switchSubTab('Stats')">ğŸ“Š Stats & Input</div>
        <div class="tab-btn" id="tabTourn" onclick="ui.switchSubTab('Tournaments')">ğŸ† Tournaments</div>
    </div>
</div>

<div class="container hidden" id="mainApp">
    <div id="viewMatchDay" class="hidden">
        <div class="card">
            <div class="card-header"><span>ğŸ“Š <span id="teamStatTitle">Stats</span></span></div>
            <div class="card-body">
                <div class="stat-grid">
                    <div class="stat-item"><span>Games</span><strong id="st-p">0</strong></div>
                    <div class="stat-item"><span>Wins</span><strong id="st-w">0</strong></div>
                    <div class="stat-item"><span>Goals</span><strong id="st-g">0</strong></div>
                    <div class="stat-item"><span>Awards</span><strong id="st-a">0</strong></div>
                </div>
            </div>
        </div>
        <div class="card protected-area" style="border-top: 4px solid var(--success);">
            <details>
                <summary class="card-header">âš½ Match Day Input</summary>
                <div class="card-body">
                    <div class="form-group"><label>Date:</label><input type="date" id="mDate"></div>
                    <div class="form-group"><label>Competition:</label><select id="mTourn"><option value="League">League</option></select></div>
                    <div class="form-row"><div><label>Opponent:</label><select id="mOpp"></select></div><div><label>Manager:</label><select id="mCoach"></select></div></div>
                    <div class="form-row"><div><label>Us:</label><input type="number" id="mOur" value="0" oninput="ui.renderScorers('m')"></div><div><label>Them:</label><input type="number" id="mTheir" value="0"></div></div>
                    <div id="mScorerList" class="form-group"></div>
                    <div id="mAwardList" class="form-group"></div>
                    <div class="form-group"><label>Notes:</label><textarea id="mNotes" rows="2"></textarea></div>
                    <button type="button" class="btn btn-add" onclick="app.addToQueue()">+ Add Game to Queue</button>
                    <div id="matchQueue" style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);"></div>
                    <button type="button" id="btnFinalize" class="btn btn-save hidden" onclick="app.saveSession()">ğŸ’¾ Save Session</button>
                </div>
            </details>
        </div>
        <div class="card">
            <details open>
                <summary class="card-header">ğŸ† League Table</summary>
                <div class="card-body" style="padding:0;">
                    <table id="teamLeagueTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody></tbody></table>
                </div>
            </details>
        </div>
        <div class="card">
            <details open>
                <summary class="card-header">ğŸ•’ Match History</summary>
                <div class="card-body" id="teamHistoryList" style="padding:10px;"></div>
            </details>
        </div>
    </div>

    <div id="viewTournaments" class="hidden">
        <div class="card" style="border-color: var(--tourn-color);">
            <div class="card-header" style="color: var(--tourn-color); background:rgba(111, 66, 193, 0.05);">ğŸ† Tournament Hub
                <button class="btn-outline protected-area" style="width:auto; padding:5px 12px; font-size:0.8rem;" onclick="document.getElementById('addTournModal').classList.remove('hidden')">+ New</button>
            </div>
            <div class="card-body">
                <div class="form-group"><label>Select Tournament:</label><select id="tournSelector" onchange="ui.renderTournamentView()"></select></div>
                <div id="tournStatsArea" class="hidden">
                    <div class="stat-grid">
                        <div class="stat-item"><span>Games</span><strong id="tr-p">0</strong></div>
                        <div class="stat-item"><span>Wins</span><strong id="tr-w">0</strong></div>
                        <div class="stat-item"><span>Goals</span><strong id="tr-g">0</strong></div>
                        <div class="stat-item"><span>Awards</span><strong id="tr-a">0</strong></div>
                    </div>
                    <div class="protected-area" style="margin-top:20px; text-align:right;"><button class="btn-edit" style="width:auto;" onclick="app.openEditActiveTourn()">âš™ï¸ Manage</button></div>
                    <div class="protected-area" style="background:var(--primary-tint); padding:15px; border-radius:10px; margin-top:20px; border:1px solid var(--border);">
                        <label>ğŸ† Tournament Winner:</label>
                        <div class="flex-row"><input type="text" id="tournWinnerInput" placeholder="Enter winner" class="flex-grow"><button class="btn btn-save" style="width:auto; margin-top:0;" onclick="app.saveTournWinner()">Save</button></div>
                    </div>
                    <h3 style="margin-top:25px; border-bottom:2px solid var(--border);">ğŸ•’ Fixtures</h3>
                    <div id="tournHistoryList"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="viewCareer" class="hidden">
        <div class="card" style="border-color: #DAA520;">
            <div class="card-header" style="color: #B8860B; background:rgba(218, 165, 32, 0.1);"><span>ğŸŒŸ Career</span><select id="careerSeasonFilter" onchange="ui.renderCareer()" style="width:auto;"><option value="All Time">All Time</option></select></div>
            <div class="card-body">
                <div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="c-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="c-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="c-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="c-a">0</strong></div></div>
            </div>
        </div>
        <div class="card">
            <div class="card-header" style="color:#B8860B; background:rgba(218, 165, 32, 0.1);">ğŸ† Comparison</div>
            <div class="card-body" style="padding:0;">
                <table id="masterTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>GF</th><th>Pts</th></tr></thead><tbody></tbody></table>
            </div>
        </div>
    </div>

    <div id="viewAdmin" class="hidden protected-area">
        <h2 style="margin-bottom:20px;">âš™ï¸ Admin</h2>
        <div class="card"><div class="card-header">ğŸ›  Select Team</div><div class="card-body"><select id="admTeamSelect" onchange="ui.renderAdminDetails()"></select></div></div>
        
        <div class="card"><div class="card-header">ğŸ“… Season</div><div class="card-body"><div class="flex-row"><select id="admActiveSeason" onchange="app.switchActiveSeason()" class="flex-grow"></select><button class="btn-del" style="width:auto;" onclick="app.deleteSeason()">ğŸ—‘</button></div><button class="btn btn-save" onclick="document.getElementById('newSeasonModal').classList.remove('hidden')">â• New Season</button></div></div>
        
        <div class="card">
            <div class="card-header">ğŸƒâ€â™‚ï¸ Squad</div>
            <div class="card-body">
                <div class="form-group flex-row"><input type="text" id="admNewPlayer" placeholder="Add Player" class="flex-grow"><button class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddItem('players', 'admNewPlayer')">Add</button></div>
                <ul id="admPlayerList" class="admin-list"></ul>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">ğŸ›¡ Opponents</div>
            <div class="card-body">
                <div class="form-group flex-row"><input type="text" id="admNewOpp" placeholder="Add Opponent" class="flex-grow"><button class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddItem('opps', 'admNewOpp')">Add</button></div>
                <ul id="admOppList" class="admin-list"></ul>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">ğŸ… Awards</div>
            <div class="card-body">
                <div class="flex-row" style="margin-bottom:10px;"><input type="text" id="newAwardName" placeholder="Name" class="flex-grow"><input type="number" id="newAwardMax" placeholder="Max" style="width:70px;"><button class="btn btn-save" style="width:auto; margin-top:0;" onclick="app.addAwardConfig()">Add</button></div>
                <ul id="admAwardList" class="admin-list"></ul>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">ğŸŒ Global Settings</div>
            <div class="card-body">
                <label style="display:block; margin-bottom:5px;">Add Club:</label>
                <div class="flex-row">
                    <input type="text" id="newTeamName" placeholder="Club Name" class="flex-grow">
                    <input type="color" id="newTeamColor" value="#333333" class="color-picker">
                    <button class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.addTeam()">Create</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="addTournModal" class="modal-overlay hidden"><div class="modal-box"><h3>Create Tournament</h3><input type="text" id="newTournNameModal" placeholder="Name"><button class="btn btn-save" onclick="app.createTournamentFromHub()">Create</button><button class="btn" onclick="document.getElementById('addTournModal').classList.add('hidden')">Cancel</button></div></div>
<div id="newSeasonModal" class="modal-overlay hidden"><div class="modal-box"><h3>New Season</h3><input type="text" id="newSeasonNameInput" placeholder="YYYY/YY"><button class="btn btn-save" onclick="app.startNewSeason()">Start</button><button class="btn" onclick="document.getElementById('newSeasonModal').classList.add('hidden')">Cancel</button></div></div>
<div id="editModal" class="modal-overlay hidden"><div class="modal-box"><h3>Edit Match</h3><input type="hidden" id="editId"><input type="date" id="eDate"><select id="eTourn"></select><select id="eOpp"></select><input type="number" id="eOur" oninput="ui.renderScorers('e')"><input type="number" id="eTheir"><div id="eScorerList"></div><div id="eAwardList"></div><textarea id="eNotes"></textarea><button class="btn btn-save" onclick="app.saveEditedMatch()">Save</button><button class="btn" onclick="document.getElementById('editModal').classList.add('hidden')">Cancel</button></div></div>
<div id="helpModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>â“ User Guide</h3>
        <ul style="padding-left:20px; line-height:1.6;">
            <li><strong>Adding Games:</strong> Select your team, go to 'Stats & Input', fill in the details and click '+ Add Game'. Click 'ğŸ’¾ Save Session' to finish.</li>
            <li><strong>Editing:</strong> Click the âœ icon next to any match in history to fix mistakes.</li>
            <li><strong>Admin:</strong> Use the âš™ï¸ Admin tab to add players, opponents, and configure awards.</li>
            <li><strong>Tournaments:</strong> Use the ğŸ† Tournaments tab to filter games by cup competitions.</li>
            <li><strong>Sync:</strong> All data saves automatically to the cloud.</li>
        </ul>
        <button class="btn" onclick="document.getElementById('helpModal').classList.add('hidden')">Close</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAkhLB-XkffuTny8yJOw_FCtZSRIo5qQLE",
        authDomain: "joeyfootball-875eb.firebaseapp.com",
        databaseURL: "https://joeyfootball-875eb-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "joeyfootball-875eb",
        storageBucket: "joeyfootball-875eb.firebasestorage.app",
        messagingSenderId: "647816306796",
        appId: "1:647816306796:web:686918e1d1c82b8a17f849",
        measurementId: "G-PX5PH27CES"
    };

    const ALLOWED_UIDS = ["QC6D1Smr9SVgpITffUTrRZSTQEq1", "Np9ZXcd2wNWvwsYA3X1QTcFpSIB3"];
    let app, db, auth, rtdb, globalData, activeContext = "Llanelli Town", activeSubTab = "Stats", sessionQueue = [], currentUser = null, isGuest = false;

    try { app = initializeApp(firebaseConfig); rtdb = getDatabase(app); auth = getAuth(app); } 
    catch (e) { document.getElementById('loadingOverlay').innerHTML = "<h2>âš ï¸ Error</h2><p>Firebase Config Failed</p>"; }

    const btnLogin = document.getElementById('btnLogin');
    btnLogin.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    window.app = window.app || {};
    window.app.enterAsGuest = () => { isGuest = true; currentUser = { uid: "GUEST" }; document.getElementById('authOverlay').classList.add('hidden'); document.getElementById('loadingOverlay').classList.remove('hidden'); document.body.classList.add('read-only-mode'); listenToData(); };
    window.app.doSignOut = () => { isGuest = false; signOut(auth).then(() => window.location.reload()); };

    onAuthStateChanged(auth, (user) => {
        if (isGuest) return;
        currentUser = user;
        if (user) {
            document.getElementById('authOverlay').classList.add('hidden');
            if (ALLOWED_UIDS.includes(user.uid)) { document.body.classList.remove('read-only-mode'); document.querySelectorAll('.protected-area').forEach(el => el.classList.remove('hidden')); }
            else { document.body.classList.add('read-only-mode'); document.querySelectorAll('.protected-area').forEach(el => el.classList.add('hidden')); }
            listenToData();
        } else {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('authOverlay').classList.remove('hidden');
            document.getElementById('mainNav').classList.add('hidden'); document.getElementById('mainApp').classList.add('hidden');
        }
    });

    function listenToData() {
        const dataRef = ref(rtdb, 'joey_v38');
        onValue(dataRef, (snapshot) => {
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('mainNav').classList.remove('hidden'); document.getElementById('mainApp').classList.remove('hidden');
            const val = snapshot.val();
            if (val) { globalData = val; initUI(); }
            else { globalData = { teams: { "Llanelli Town": { color: "#d32f2f", players: ["Joey"], opps: [], coaches: [], awards: [], tournaments: [], active: true } }, history: [], settings: { theme: 'light', currentSeason: "2025/26", seasons: ["2025/26"] } }; if(!isGuest && ALLOWED_UIDS.includes(currentUser?.uid)) set(dataRef, globalData); initUI(); }
        });
    }

    function saveToCloud() { if (!ALLOWED_UIDS.includes(currentUser?.uid) || isGuest) return alert("Read Only Mode"); return set(ref(rtdb, 'joey_v38'), globalData); }

    function initUI() {
        if(globalData && globalData.teams && !globalData.teams[activeContext]) activeContext = Object.keys(globalData.teams)[0] || 'Career';
        if(globalData && !globalData.history) globalData.history = [];
        ui.renderNav(); ui.renderMainView(); document.body.setAttribute('data-theme', globalData?.settings?.theme || 'light');
    }

    // Hex to RGB helper for tinting
    function hexToRgb(hex) {
        let r = 0, g = 0, b = 0;
        if (hex.length === 4) {
            r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3];
        } else if (hex.length === 7) {
            r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6];
        }
        return `rgba(${+r},${+g},${+b}, 0.08)`;
    }

    Object.assign(window.app, {
        saveSession: () => { const batchId = Date.now(); sessionQueue.forEach(g => g.batchId = batchId); globalData.history.push(...sessionQueue); sessionQueue = []; saveToCloud().then(()=>{ui.renderQueue(); alert("Saved!");}); },
        addToQueue: () => {
            const opp = document.getElementById('mOpp').value; if(!opp) return alert("Select Opponent");
            let dVal = document.getElementById('mDate').value || new Date().toISOString().split('T')[0];
            sessionQueue.push({ id: Date.now()+Math.random(), date:dVal, team:activeContext, opp:opp, tourn:document.getElementById('mTourn').value, our:parseInt(document.getElementById('mOur').value)||0, their:parseInt(document.getElementById('mTheir').value)||0, coach:document.getElementById('mCoach').value, scorers:Array.from(document.querySelectorAll('.m-sc-input')).map(s=>s.value), awards:Array.from(document.querySelectorAll('.m-aw-input')).filter(s=>s.value).map(s=>({name:s.dataset.name, player:s.value})), notes:document.getElementById('mNotes').value, season:globalData.settings.currentSeason });
            ui.renderQueue(); document.getElementById('mOur').value=0; document.getElementById('mTheir').value=0; document.getElementById('mNotes').value=""; ui.renderScorers('m');
        },
        adminAddItem: (k, id) => { const t = document.getElementById('admTeamSelect').value, v = document.getElementById(id).value.trim(); if(v) { globalData.teams[t][k].push(v); document.getElementById(id).value=""; saveToCloud().then(()=>ui.renderAdminDetails()); } },
        admDel: (k, i) => { const t = document.getElementById('admTeamSelect').value; globalData.teams[t][k].splice(i,1); saveToCloud().then(()=>ui.renderAdminDetails()); },
        addAwardConfig: () => { const t = document.getElementById('admTeamSelect').value, n = document.getElementById('newAwardName').value, m = parseInt(document.getElementById('newAwardMax').value) || 1; if(n) { globalData.teams[t].awards.push({name:n, max:m}); document.getElementById('newAwardName').value=""; saveToCloud().then(()=>ui.renderAdminDetails()); } },
        admDelAw: (i) => { const t = document.getElementById('admTeamSelect').value; globalData.teams[t].awards.splice(i,1); saveToCloud().then(()=>ui.renderAdminDetails()); },
        addTeam: () => { const n=document.getElementById('newTeamName').value, c=document.getElementById('newTeamColor').value; if(n && !globalData.teams[n]) { globalData.teams[n]={color:c, players:["Joey"], opps:[], coaches:[], awards:[], tournaments:[], active:true}; saveToCloud().then(()=>ui.renderNav()); } },
        startNewSeason: () => { const n = document.getElementById('newSeasonNameInput').value; if(n) { globalData.settings.seasons.push(n); globalData.settings.currentSeason = n; saveToCloud().then(()=>{document.getElementById('newSeasonModal').classList.add('hidden')}); } },
        switchActiveSeason: () => { globalData.settings.currentSeason = document.getElementById('admActiveSeason').value; saveToCloud().then(()=>{ui.renderNav(); ui.renderMainView();}); },
        createTournamentFromHub: () => { const n = document.getElementById('newTournNameModal').value; if(n) { if(!globalData.teams[activeContext].tournaments) globalData.teams[activeContext].tournaments = []; globalData.teams[activeContext].tournaments.push({name:n, active:true, winner:""}); saveToCloud().then(()=>{document.getElementById('addTournModal').classList.add('hidden'); ui.renderTournamentView();}); } },
        saveTournWinner: () => { const tName = activeContext, trName = document.getElementById('tournSelector').value, win = document.getElementById('tournWinnerInput').value, idx = globalData.teams[tName].tournaments.findIndex(t=>t.name===trName); if(idx !== -1) { globalData.teams[tName].tournaments[idx].winner = win; saveToCloud().then(()=>alert("Saved")); } },
        openEditActiveTourn: () => { alert("Use Admin panel to edit."); },
        deleteSeason: () => { if(confirm("Delete current season?")) { const c = globalData.settings.currentSeason; globalData.history = globalData.history.filter(m=>m.season!==c); globalData.settings.seasons = globalData.settings.seasons.filter(s=>s!==c); globalData.settings.currentSeason = globalData.settings.seasons[0] || "2025/26"; saveToCloud().then(()=>ui.renderMainView()); } },
        saveEditedMatch: () => { const id=document.getElementById('editId').value, i=globalData.history.findIndex(x=>x.id==id); if(i===-1)return; globalData.history[i]={...globalData.history[i], date:document.getElementById('eDate').value, opp:document.getElementById('eOpp').value, tourn:document.getElementById('eTourn').value, our:parseInt(document.getElementById('eOur').value)||0, their:parseInt(document.getElementById('eTheir').value)||0, scorers:Array.from(document.querySelectorAll('.e-sc-input')).map(s=>s.value), awards:Array.from(document.querySelectorAll('.e-aw-input')).filter(s=>s.value).map(s=>({name:s.dataset.name,player:s.value})), notes:document.getElementById('eNotes').value }; saveToCloud().then(()=>{document.getElementById('editModal').classList.add('hidden'); ui.renderMainView();}); }
    });

    window.ui = {
        renderNav: () => {
            const list = document.getElementById('navTeamList'); list.innerHTML='';
            Object.keys(globalData.teams).forEach(t => { const b = document.createElement('div'); b.className=`nav-btn ${activeContext===t?'active':''}`; b.innerText=t; b.onclick=()=>{ui.switchContext(t);}; list.appendChild(b); });
            const c = document.createElement('div'); c.className=`nav-btn career ${activeContext==='Career'?'active':''}`; c.innerText='ğŸŒŸ Career'; c.onclick=()=>ui.switchContext('Career'); list.appendChild(c);
            const a = document.createElement('div'); a.className=`nav-btn admin ${activeContext==='Admin'?'active':''}`; a.innerText='âš™ï¸ Admin'; a.onclick=()=>ui.switchContext('Admin'); list.appendChild(a);
            
            const ctrls = document.getElementById('navControls'); ctrls.innerHTML = '';
            
            // Season Tag
            const s = document.createElement('div'); s.className='season-tag'; s.innerText=globalData.settings.currentSeason; ctrls.appendChild(s);
            
            // Guide
            const gd = document.createElement('button'); gd.className='ctl-btn'; gd.innerHTML='â“ Guide'; gd.onclick=()=>document.getElementById('helpModal').classList.remove('hidden'); ctrls.appendChild(gd);

            // Theme
            const tm = document.createElement('button'); tm.className='ctl-btn'; tm.innerHTML=globalData.settings.theme==='light'?'ğŸŒ™ Dark':'â˜€ï¸ Light'; 
            tm.onclick = () => { globalData.settings.theme = globalData.settings.theme === 'light' ? 'dark' : 'light'; document.body.setAttribute('data-theme', globalData.settings.theme); saveToCloud(); };
            ctrls.appendChild(tm);

            // Logout
            const so = document.createElement('button'); so.className='ctl-btn'; so.innerHTML='ğŸšª Log Out'; so.onclick = () => app.doSignOut(); ctrls.appendChild(so);

            if(activeContext==='Career'||activeContext==='Admin') document.getElementById('navSecondary').classList.add('hidden'); else document.getElementById('navSecondary').classList.remove('hidden');
        },
        updateSecondaryNav: () => {
            document.getElementById('tabStats').classList.toggle('active', activeSubTab === 'Stats');
            document.getElementById('tabTourn').classList.toggle('active', activeSubTab === 'Tournaments');
        },
        switchContext: (c) => { 
            activeContext = c; 
            if(c === 'Career') {
                document.documentElement.style.setProperty('--primary', '#B8860B'); 
                document.documentElement.style.setProperty('--primary-tint', 'rgba(218, 165, 32, 0.08)');
                document.documentElement.style.setProperty('--text-on-primary', '#000');
            } else if (c === 'Admin') {
                document.documentElement.style.setProperty('--primary', '#333');
                document.documentElement.style.setProperty('--primary-tint', '#f0f2f5');
                document.documentElement.style.setProperty('--text-on-primary', '#fff');
            } else if(globalData.teams[c]) {
                const color = globalData.teams[c].color;
                document.documentElement.style.setProperty('--primary', color);
                document.documentElement.style.setProperty('--primary-tint', hexToRgb(color));
                document.documentElement.style.setProperty('--text-on-primary', '#fff');
            }
            ui.renderNav(); ui.renderMainView(); 
        },
        switchSubTab: (t) => { activeSubTab = t; ui.updateSecondaryNav(); ui.renderMainView(); },
        renderMainView: () => {
            ui.updateSecondaryNav();
            ['viewMatchDay','viewTournaments','viewAdmin','viewCareer'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            if(activeContext === 'Career') { document.getElementById('viewCareer').classList.remove('hidden'); ui.renderCareer(); } 
            else if(activeContext === 'Admin') { document.getElementById('viewAdmin').classList.remove('hidden'); const sel = document.getElementById('admTeamSelect'); sel.innerHTML=''; Object.keys(globalData.teams).forEach(t=>sel.add(new Option(t,t))); const sSel = document.getElementById('admActiveSeason'); sSel.innerHTML=''; globalData.settings.seasons.forEach(s=>sSel.add(new Option(s,s))); sSel.value = globalData.settings.currentSeason; ui.renderAdminDetails(); } 
            else { 
                if(activeSubTab === 'Stats') { document.getElementById('viewMatchDay').classList.remove('hidden'); document.getElementById('teamStatTitle').innerText = activeContext; ui.renderMatchDayInputs(); ui.renderTeamStats(); ui.renderLeagueTable(); ui.renderHistory(globalData.history.filter(m=>m.team===activeContext && m.season===globalData.settings.currentSeason)); } 
                else { document.getElementById('viewTournaments').classList.remove('hidden'); ui.renderTournHub(); } 
            }
        },
        renderMatchDayInputs: () => { const t = globalData.teams[activeContext]; const fill = (id, arr) => {const el=document.getElementById(id); el.innerHTML=""; arr.forEach(x=>el.add(new Option(x,x)))}; fill('mOpp', t.opps || []); fill('mCoach', t.coaches || []); const te = document.getElementById('mTourn'); te.innerHTML='<option value="League">League</option>'; if(t.tournaments) t.tournaments.forEach(tr => { if(tr.active) te.add(new Option("ğŸ† " + tr.name, tr.name)); }); document.getElementById('mDate').value = new Date().toISOString().split('T')[0]; ui.renderScorers('m'); },
        renderScorers: (p) => { const c = parseInt(document.getElementById(p + 'Our').value) || 0; const d = document.getElementById(p + 'ScorerList'); d.innerHTML = c > 0 ? '<label>Goal Scorers:</label>' : ''; const pl = globalData.teams[activeContext].players; for(let i=0; i<c; i++) { const s = document.createElement('select'); s.className = p + '-sc-input'; s.style.marginBottom='5px'; pl.forEach(x => s.add(new Option(x,x))); d.appendChild(s); } const ad = document.getElementById(p + 'AwardList'); ad.innerHTML = ''; (globalData.teams[activeContext].awards || []).forEach(aw => { const w = document.createElement('div'); w.style.cssText='background:var(--session-bg);padding:8px;border-radius:8px;margin-bottom:5px;'; w.innerHTML = `<small><strong>${aw.name}</strong> (Max ${aw.max})</small>`; for(let k=0; k<aw.max; k++) { const s = document.createElement('select'); s.className = p + '-aw-input'; s.dataset.name = aw.name; s.add(new Option("-", "")); pl.forEach(x => s.add(new Option(x,x))); w.appendChild(s); } ad.appendChild(w); }); },
        renderQueue: () => { const q=document.getElementById('matchQueue'); q.innerHTML=sessionQueue.map((g,i)=>`<div class="queue-item"><div><strong>vs ${g.opp}</strong> (${g.our}-${g.their})</div><button class="btn-del" onclick="sessionQueue.splice(${i},1);ui.renderQueue()">âœ•</button></div>`).join(''); document.getElementById('btnFinalize').classList.toggle('hidden', sessionQueue.length===0); },
        renderHistory: (data) => { 
            const list = document.getElementById('teamHistoryList'); 
            if(!data.length) { list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">No matches yet</div>'; return; }
            
            data.sort((a,b) => b.id - a.id); 
            let html = '';
            let currentBatch = null;
            
            data.forEach((m, i) => {
                const batchId = m.batchId || m.date; 
                if(batchId !== currentBatch) {
                    if(currentBatch !== null) html += '</div>'; 
                    currentBatch = batchId;
                    html += `<div class="history-group"><div class="group-header">ğŸ“… ${m.date}</div>`;
                }
                html += `
                <div class="match-row">
                    <div class="match-info">
                        ${m.notes?'ğŸ—’ï¸ ':''}<strong>vs ${m.opp}</strong> <span style="font-size:0.8em">${m.tourn}</span><br>
                        <small>${(m.scorers||[]).length? 'âš½ '+(m.scorers||[]).join(', '):''}</small>
                    </div>
                    <div class="match-actions">
                        <div class="result-badge ${m.our>m.their?'res-w':m.our<m.their?'res-l':'res-d'}">${m.our}-${m.their}</div>
                        <div class="protected-area"><button class="btn-edit" onclick="ui.openEditModal('${m.id}')">âœ</button></div>
                    </div>
                </div>`;
            });
            html += '</div>'; 
            list.innerHTML = html;
            
            if(!ALLOWED_UIDS.includes(currentUser?.uid) || isGuest) document.querySelectorAll('.protected-area').forEach(el=>el.classList.add('hidden')); 
        },
        renderLeagueTable: () => { const matches = globalData.history.filter(m => m.team === activeContext && m.season === globalData.settings.currentSeason); let my = { p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0 }; matches.forEach(m => { my.p++; my.gf += m.our; my.ga += m.their; if(m.our > m.their) { my.w++; my.pts+=3; } else if(m.our < m.their) { my.l++; my.pts+=0; } else { my.d++; my.pts+=1; } }); let opp = { p: my.p, w: my.l, d: my.d, l: my.w, gf: my.ga, ga: my.gf, pts: (my.l * 3) + (my.d * 1) }; let data = [{ name: activeContext, ...my, isMe: true }, { name: "Opponents", ...opp, isMe: false }]; data.sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga))); document.querySelector('#teamLeagueTable tbody').innerHTML = data.map((d, i) => `<tr class="${d.isMe?'is-me'+(i===0?' pos-1':''):''}"><td class="t-left">${i+1}. ${d.name}</td><td>${d.p}</td><td>${d.w}</td><td>${d.d}</td><td>${d.l}</td><td>${d.gf-d.ga}</td><td><b>${d.pts}</b></td></tr>`).join(''); },
        renderTeamStats: () => { const h = globalData.history.filter(m => m.team === activeContext && m.season === globalData.settings.currentSeason); document.getElementById('st-p').innerText = h.length; document.getElementById('st-w').innerText = h.filter(m=>m.our>m.their).length; document.getElementById('st-g').innerText = h.reduce((a,m)=>(a+(m.scorers||[]).filter(s=>s==="Joey").length),0); document.getElementById('st-a').innerText = h.reduce((a,m)=>(a+(m.awards||[]).filter(x=>x.player==="Joey").length),0); },
        renderCareer: () => { 
            const f = document.getElementById('careerSeasonFilter').value; 
            let h = globalData.history; 
            if(f !== 'All Time') h = h.filter(m => m.season === f); 
            document.getElementById('c-p').innerText = h.length; document.getElementById('c-w').innerText = h.filter(m=>m.our>m.their).length; document.getElementById('c-g').innerText = h.reduce((a,m)=>(a+(m.scorers||[]).filter(s=>s==="Joey").length),0); document.getElementById('c-a').innerText = h.reduce((a,m)=>(a+(m.awards||[]).filter(x=>x.player==="Joey").length),0); 
            let stats={}; 
            h.forEach(m=>{const u=(n,gf,ga)=>{if(!stats[n])stats[n]={name:n,p:0,w:0,d:0,l:0,gf:0,ga:0,pts:0};const st=stats[n];st.p++;st.gf+=gf;st.ga+=ga;if(gf>ga){st.w++;st.pts+=3;}else if(gf<ga){st.l++;st.pts+=0;}else{st.d++;st.pts+=1;}};u(m.team,m.our,m.their);u(m.opp,m.their,m.our);}); 
            const d=Object.values(stats).sort((a,b)=>(b.pts-a.pts)||((b.gf-b.ga)-(a.gf-a.ga))); 
            
            document.querySelector('#masterTable tbody').innerHTML=d.map((t,i)=>{
                // Check if this row is one of our teams to colorize it
                const isMyTeam = globalData.teams[t.name] !== undefined;
                const teamColor = isMyTeam ? globalData.teams[t.name].color : 'inherit';
                const fontWeight = isMyTeam ? 'bold' : 'normal';
                
                return `<tr class="${i===0?'pos-1':''}"><td class="t-left" style="color:${teamColor}; font-weight:${fontWeight}">${i+1}. ${t.name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td><td>${t.gf-t.ga}</td><td>${t.gf}</td><td><b>${t.pts}</b></td></tr>`;
            }).join(''); 
        },
        renderAdminDetails: () => { 
            const t=globalData.teams[document.getElementById('admTeamSelect').value]; 
            if(!t) return; 
            document.documentElement.style.setProperty('--primary', t.color); 
            document.documentElement.style.setProperty('--primary-tint', hexToRgb(t.color));
            
            const l=(id,k)=>document.getElementById(id).innerHTML=t[k].map((x,i)=>`<li>${x}<button class="btn-del" onclick="app.admDel('${k}',${i})">ğŸ—‘</button></li>`).join(''); 
            l('admPlayerList', 'players'); l('admCoachList', 'coaches'); l('admOppList', 'opps'); 
            document.getElementById('admAwardList').innerHTML = t.awards.map((a,i)=>`<li>${a.name} (Max:${a.max})<button class="btn-del" onclick="app.admDelAw(${i})">ğŸ—‘</button></li>`).join(''); 
        },
        renderTournamentView: () => { const tName = activeContext; const sel = document.getElementById('tournSelector'); if(sel.options.length <= 1) { sel.innerHTML = '<option value="">-- Select --</option>'; if(globalData.teams[tName].tournaments) globalData.teams[tName].tournaments.forEach(tr => { if(tr.active) sel.add(new Option(tr.name, tr.name)); }); } const val = sel.value; if(!val) { document.getElementById('tournStatsArea').classList.add('hidden'); return; } document.getElementById('tournStatsArea').classList.remove('hidden'); const h = globalData.history.filter(m => m.tourn === val && m.team === tName && m.season === globalData.settings.currentSeason); document.getElementById('tr-p').innerText = h.length; document.getElementById('tr-w').innerText = h.filter(m => m.our > m.their).length; document.getElementById('tr-g').innerText = h.reduce((a,m)=>(a+(m.scorers||[]).filter(s=>s==="Joey").length),0); document.getElementById('tr-a').innerText = h.reduce((a,m)=>(a+(m.awards||[]).filter(x=>x.player==="Joey").length),0); ui.renderHistory(h, 'tournHistoryList'); },
        openEditModal: (id) => { const m = globalData.history.find(x => x.id == id); document.getElementById('editId').value = id; document.getElementById('eDate').value = m.date; document.getElementById('eOur').value = m.our; document.getElementById('eTheir').value = m.their; document.getElementById('eNotes').value = m.notes || ""; const t = globalData.teams[m.team]; const fill = (eid, arr, val) => { const el = document.getElementById(eid); el.innerHTML = ""; arr.forEach(x => el.add(new Option(x,x))); el.value = val; }; fill('eOpp', t.opps, m.opp); const te = document.getElementById('eTourn'); te.innerHTML='<option value="League">League</option>'; if(t.tournaments) t.tournaments.forEach(tr => te.add(new Option("ğŸ† "+tr.name, tr.name))); te.value = m.tourn; ui.renderScorers('e'); document.getElementById('editModal').classList.remove('hidden'); }
    };
</script>
</body>
</html>
