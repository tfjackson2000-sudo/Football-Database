<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joey's Career Tracker V37 (Cloud)</title>
    <style>
        :root { 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --text: #1f1f1f; 
            --text-muted: #666;
            --border: #e1e4e8; 
            --primary: #333; 
            --session-bg: #f8f9fa;
            --success: #28a745;
            --danger: #dc3545;
            --shadow: 0 4px 12px rgba(0,0,0,0.08);
            --tourn-color: #6f42c1;
        }
        
        [data-theme="dark"] { 
            --bg: #121212; 
            --card: #1e1e1e; 
            --text: #e4e6eb; 
            --text-muted: #b0b3b8;
            --border: #383838; 
            --session-bg: #252525;
            --shadow: 0 4px 12px rgba(0,0,0,0.4);
            --tourn-color: #a76dff;
        }

        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 80px; transition: background 0.3s, color 0.3s; }

        /* NAV */
        .nav-container { background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .nav-primary { display: flex; padding: 10px 15px; gap: 10px; overflow-x: auto; align-items: center; border-bottom: 1px solid var(--border); }
        .nav-secondary { display: flex; padding: 0 15px; background: var(--session-bg); gap: 20px; overflow-x: auto; }
        .nav-btn { padding: 8px 16px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.9rem; white-space: nowrap; opacity: 0.6; transition: 0.2s; border: 2px solid transparent; }
        .nav-btn.active { opacity: 1; background: var(--primary); color: #fff; transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .nav-btn.career { border-color: #ffd700; color: #b8860b; background: transparent; }
        .nav-btn.career.active { background: linear-gradient(135deg, #ffd700, #daa520); color: #000; border-color: transparent; }
        .nav-btn.admin { background: #e9ecef; color: #333; margin-left: auto;}
        .nav-btn.admin.active { background: #333; color: #fff; }
        .tab-btn { padding: 12px 5px; cursor: pointer; font-weight: 600; font-size: 0.9rem; color: var(--text-muted); border-bottom: 3px solid transparent; opacity: 0.8; transition: 0.2s; }
        .tab-btn.active { color: var(--primary); border-bottom-color: var(--primary); opacity: 1; }

        /* UI ELEMENTS */
        .container { max-width: 800px; margin: 25px auto; padding: 0 15px; }
        .card { background: var(--card); border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); position: relative; overflow: hidden; }
        .card-header { font-size: 1.2rem; font-weight: 800; margin-bottom: 20px; display:flex; justify-content:space-between; align-items:center; color: var(--text); }
        
        details > summary { list-style: none; cursor: pointer; outline: none; font-weight: bold; font-size: 1.1rem; }
        details > summary::after { content: ' â–¼'; float: right; font-size: 0.8em; opacity: 0.5; }
        details[open] > summary::after { transform: rotate(180deg); }
        details[open] .card-header { margin-bottom: 20px; }
        details:not([open]) .card-header { margin-bottom: 0; }

        /* STATS & FORMS */
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item { background: var(--bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-item strong { font-size: 1.5rem; color: var(--primary); display: block; line-height: 1; }
        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; background: var(--card); color: var(--text); box-sizing: border-box; }
        
        /* BUTTONS */
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 0.95rem; margin-top:5px; }
        .btn-add { background: var(--primary); color: #fff; }
        .btn-save { background: var(--success); color: white; }
        .btn-del { background: transparent; color: var(--danger); font-size: 1.1rem; border: none; cursor:pointer; }
        .btn-edit { background: transparent; color: #3b82f6; font-size: 1.2rem; border: none; cursor:pointer; }
        .btn-google { background: #4285F4; color: white; margin-bottom: 20px; }

        /* TABLES & LISTS */
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; }
        th { background: var(--session-bg); padding: 12px 8px; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border); }
        td { padding: 12px 8px; border-bottom: 1px solid var(--border); text-align: center; }
        .t-left { text-align: left; }
        .pos-1 { background: rgba(255, 215, 0, 0.08); font-weight: bold; }
        
        .match-row { padding: 15px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .result-badge { padding: 4px 8px; border-radius: 6px; font-weight: bold; font-size: 0.9rem; min-width: 30px; text-align: center; }
        .res-w { background: rgba(40, 167, 69, 0.15); color: #28a745; }
        .res-l { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
        .res-d { background: rgba(255, 193, 7, 0.15); color: #d39e00; }

        .hidden { display: none !important; }
        .auth-locked { opacity: 0.5; pointer-events: none; filter: grayscale(1); }
    </style>
</head>
<body>

<div id="authContainer" style="padding: 20px; text-align: center; background: var(--card); border-bottom: 1px solid var(--border);">
    <h2 id="welcomeMsg">Welcome to Career Tracker</h2>
    <p id="uidDisplay" style="font-family:monospace; font-size:0.8rem; color:var(--text-muted);"></p>
    <button id="btnLogin" class="btn btn-google" style="width: auto; padding: 10px 20px;">Sign in with Google</button>
    <button id="btnLogout" class="btn hidden" style="width: auto; padding: 10px 20px; background: #666; color: white;">Sign Out</button>
</div>

<div class="nav-container">
    <div class="nav-primary" id="navPrimary"></div>
    <div class="nav-secondary hidden" id="navSecondary">
        <div class="tab-btn" id="tabStats" onclick="ui.switchSubTab('Stats')">ğŸ“Š Stats & Input</div>
        <div class="tab-btn" id="tabTourn" onclick="ui.switchSubTab('Tournaments')">ğŸ† Tournaments</div>
    </div>
</div>

<div class="container">
    <div id="loadingMsg" style="text-align:center; padding:50px;">â³ Connecting to Cloud...</div>
    <div id="mainApp" class="hidden">
        
        <div id="viewMatchDay" class="hidden">
            <div class="card">
                <div class="card-header"><span>ğŸ“Š <span id="teamStatTitle">Stats</span></span></div>
                <div class="stat-grid">
                    <div class="stat-item"><span>Games</span><strong id="st-p">0</strong></div>
                    <div class="stat-item"><span>Wins</span><strong id="st-w">0</strong></div>
                    <div class="stat-item"><span>Goals</span><strong id="st-g">0</strong></div>
                    <div class="stat-item"><span>Awards</span><strong id="st-a">0</strong></div>
                </div>
            </div>

            <div class="card protected-area" style="border-top: 4px solid var(--success);">
                <details>
                    <summary class="card-header">âš½ Match Day Input</summary>
                    <div class="form-group"><label>Date:</label><input type="date" id="mDate"></div>
                    <div class="form-group"><label>Competition:</label><select id="mTourn"><option value="League">League</option></select></div>
                    <div class="form-row"><div><label>Opponent:</label><select id="mOpp"></select></div><div><label>Manager:</label><select id="mCoach"></select></div></div>
                    <div class="form-row"><div><label>Us:</label><input type="number" id="mOur" value="0"></div><div><label>Them:</label><input type="number" id="mTheir" value="0"></div></div>
                    <div id="mScorerList" class="form-group"></div>
                    <div id="mAwardList" class="form-group"></div>
                    <div class="form-group"><label>Notes:</label><textarea id="mNotes" rows="2"></textarea></div>
                    <button type="button" class="btn btn-add" onclick="app.addToQueue()">+ Add Game to Queue</button>
                    <div id="matchQueue" style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);"></div>
                    <button type="button" id="btnFinalize" class="btn btn-save hidden" onclick="app.saveSession()">ğŸ’¾ Save Session</button>
                </details>
            </div>

            <div class="card">
                <details open><summary class="card-header">ğŸ† League Table</summary>
                <table id="teamLeagueTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>Pts</th></tr></thead><tbody></tbody></table>
                </details>
            </div>
            <div class="card">
                <details><summary class="card-header">ğŸ•’ Match History</summary><div id="teamHistoryList"></div></details>
            </div>
        </div>

        <div id="viewTournaments" class="hidden">
            <div class="card" style="border-color: var(--tourn-color);">
                <div class="card-header" style="color: var(--tourn-color);">ğŸ† Tournament Hub
                    <button class="btn-outline protected-area" style="width:auto; padding:5px 12px; font-size:0.8rem;" onclick="document.getElementById('addTournModal').classList.remove('hidden')">+ New</button>
                </div>
                <div class="form-group"><label>Select Tournament:</label><select id="tournSelector" onchange="ui.renderTournamentView()"></select></div>
                <div id="tournStatsArea" class="hidden">
                    <div class="stat-grid">
                        <div class="stat-item"><span>Games</span><strong id="tr-p">0</strong></div>
                        <div class="stat-item"><span>Wins</span><strong id="tr-w">0</strong></div>
                        <div class="stat-item"><span>Goals</span><strong id="tr-g">0</strong></div>
                        <div class="stat-item"><span>Awards</span><strong id="tr-a">0</strong></div>
                    </div>
                    <div class="protected-area" style="margin-top:20px; text-align:right;">
                        <button class="btn-edit" style="width:auto;" onclick="app.openEditActiveTourn()">âš™ï¸ Manage</button>
                    </div>
                    <div class="protected-area" style="background:var(--session-bg); padding:15px; border-radius:10px; margin-top:20px; border:1px solid var(--border);">
                        <label>ğŸ† Tournament Winner:</label>
                        <div style="display:flex; gap:10px;">
                            <input type="text" id="tournWinnerInput" placeholder="Enter winner">
                            <button class="btn btn-save" style="width:auto;" onclick="app.saveTournWinner()">Save</button>
                        </div>
                    </div>
                    <h3 style="margin-top:25px; border-bottom:2px solid var(--border);">ğŸ•’ Fixtures</h3>
                    <div id="tournHistoryList"></div>
                </div>
            </div>
        </div>

        <div id="viewCareer" class="hidden">
            <div class="card" style="border-color: #DAA520;">
                <div class="card-header" style="color: #B8860B;"><span>ğŸŒŸ Career</span><select id="careerSeasonFilter" onchange="ui.renderCareer()" style="width:auto;"><option value="All Time">All Time</option></select></div>
                <div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="c-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="c-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="c-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="c-a">0</strong></div></div>
            </div>
            <div class="card"><div class="card-header">ğŸ† Comparison</div><table id="masterTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>GF</th><th>Pts</th></tr></thead><tbody></tbody></table></div>
        </div>

        <div id="viewAdmin" class="hidden protected-area">
            <h2 style="margin-bottom:20px;">âš™ï¸ Admin</h2>
            <div class="card" style="background:#e3f2fd; border:2px dashed #2196f3;">
                <div class="card-header">â˜ï¸ Cloud Migration</div>
                <p>If you have data from the old version on this device, click below to upload it to the cloud.</p>
                <button class="btn btn-primary" onclick="app.migrateLocalToCloud()">Upload Local Data to Cloud</button>
            </div>
            <div class="card"><div class="card-header">ğŸ›  Select Team</div><select id="admTeamSelect" onchange="ui.renderAdminDetails()"></select></div>
            <div class="card"><div class="card-header">ğŸ“… Season</div><div style="display:flex; gap:10px;"><select id="admActiveSeason" onchange="app.switchActiveSeason()"></select><button class="btn-del" onclick="app.deleteSeason()">ğŸ—‘</button></div><button class="btn btn-save" onclick="document.getElementById('newSeasonModal').classList.remove('hidden')">â• New Season</button></div>
            <div class="card"><div class="card-header">ğŸƒâ€â™‚ï¸ Squad</div><div class="form-group"><input type="text" id="admNewPlayer" placeholder="Add Player"><button class="btn btn-add" onclick="app.adminAddItem('players', 'admNewPlayer')">Add</button><ul id="admPlayerList"></ul></div></div>
            <div class="card"><div class="card-header">ğŸ›¡ Opponents</div><div class="form-group"><input type="text" id="admNewOpp" placeholder="Add Opponent"><button class="btn btn-add" onclick="app.adminAddItem('opps', 'admNewOpp')">Add</button><ul id="admOppList"></ul></div></div>
        </div>
    </div>
</div>

<div id="addTournModal" class="modal-overlay hidden"><div class="modal-box"><h3>Create Tournament</h3><input type="text" id="newTournNameModal" placeholder="Name"><button class="btn btn-save" onclick="app.createTournamentFromHub()">Create</button><button class="btn" onclick="document.getElementById('addTournModal').classList.add('hidden')">Cancel</button></div></div>
<div id="newSeasonModal" class="modal-overlay hidden"><div class="modal-box"><h3>New Season</h3><input type="text" id="newSeasonNameInput" placeholder="YYYY/YY"><button class="btn btn-save" onclick="app.startNewSeason()">Start</button><button class="btn" onclick="document.getElementById('newSeasonModal').classList.add('hidden')">Cancel</button></div></div>
<div id="editModal" class="modal-overlay hidden"><div class="modal-box"><h3>Edit Match</h3><input type="hidden" id="editId"><input type="date" id="eDate"><select id="eTourn"></select><select id="eOpp"></select><input type="number" id="eOur"><input type="number" id="eTheir"><div id="eScorerList"></div><div id="eAwardList"></div><textarea id="eNotes"></textarea><button class="btn btn-save" onclick="app.saveEditedMatch()">Save</button><button class="btn" onclick="document.getElementById('editModal').classList.add('hidden')">Cancel</button></div></div>

<script type="module">
    // --- IMPORT FIREBASE ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    // --- PASTE YOUR FIREBASE CONFIG HERE ---
    // 1. Go to Firebase Console > Project Settings > General > Your Apps > Web
    // 2. Copy the config object and paste it below:
    const firebaseConfig = {
        apiKey: "AIzaSyAkhLB-XkffuTny8yJOw_FCtZSRIo5qQLE",
  authDomain: "joeyfootball-875eb.firebaseapp.com",
  databaseURL: "https://joeyfootball-875eb-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "joeyfootball-875eb",
  storageBucket: "joeyfootball-875eb.firebasestorage.app",
  messagingSenderId: "647816306796",
  appId: "1:647816306796:web:686918e1d1c82b8a17f849",
  measurementId: "G-PX5PH27CES"
    };

    // --- ALLOWED USERS (The VIP List) ---
    // Once you log in, your UID will appear on screen. Copy it and paste it into this list.
    const ALLOWED_UIDS = [
        "REPLACE_WITH_YOUR_UID",
        "REPLACE_WITH_SONS_UID"
    ];

    // --- INITIALIZE FIREBASE ---
    let app, db, auth, rtdb;
    try {
        app = initializeApp(firebaseConfig);
        rtdb = getDatabase(app);
        auth = getAuth(app);
    } catch (e) {
        document.body.innerHTML = "<h2 style='text-align:center; margin-top:50px;'>âš ï¸ Error: Firebase Config Missing</h2><p style='text-align:center;'>Open the code and paste your Firebase Config keys.</p>";
    }

    // --- GLOBAL STATE ---
    let globalData = {
        teams: {
            "Llanelli Town": { color: "#d32f2f", players: ["Joey"], opps: ["Swansea"], coaches: ["Coach A"], awards: [{name:"TOTW", max:3}], tournaments: [], active: true },
        },
        history: [], 
        settings: { theme: 'light', currentSeason: "2025/26", seasons: ["2025/26"] }
    };
    let activeContext = "Llanelli Town"; 
    let activeSubTab = "Stats"; 
    let sessionQueue = [];
    let currentUser = null;

    // --- AUTHENTICATION LOGIC ---
    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');
    const uidDisplay = document.getElementById('uidDisplay');

    btnLogin.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
    btnLogout.onclick = () => signOut(auth);

    onAuthStateChanged(auth, (user) => {
        currentUser = user;
        if (user) {
            btnLogin.classList.add('hidden');
            btnLogout.classList.remove('hidden');
            document.getElementById('welcomeMsg').innerText = `Hello, ${user.displayName}`;
            uidDisplay.innerText = `Your UID: ${user.uid}`; // Copy this to ALLOWED_UIDS
            
            // Check Permissions
            if (ALLOWED_UIDS.includes(user.uid)) {
                document.body.classList.remove('read-only-mode');
                document.querySelectorAll('.protected-area').forEach(el => el.classList.remove('hidden'));
            } else {
                document.body.classList.add('read-only-mode');
                // Hide inputs for unauthorized users
                document.querySelectorAll('.protected-area').forEach(el => el.classList.add('hidden'));
                uidDisplay.innerText += " (View Only)";
            }

            // Start Listening to Data
            listenToData();
        } else {
            btnLogin.classList.remove('hidden');
            btnLogout.classList.add('hidden');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('welcomeMsg').innerText = "Please Sign In";
            uidDisplay.innerText = "";
        }
    });

    // --- REALTIME DB LISTENERS ---
    function listenToData() {
        const dataRef = ref(rtdb, 'joey_v37');
        onValue(dataRef, (snapshot) => {
            const val = snapshot.val();
            document.getElementById('loadingMsg').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            if (val) {
                globalData = val;
                // Ensure defaults
                if(!globalData.history) globalData.history = [];
                if(!globalData.teams) globalData.teams = {};
                // Refresh UI
                if(!globalData.teams[activeContext]) activeContext = Object.keys(globalData.teams)[0] || 'Career';
                ui.renderNav();
                ui.renderMainView();
                applyTheme();
            } else {
                // DB is empty (first run)
                console.log("Database empty. Ready for migration.");
                ui.renderNav();
                ui.renderMainView();
            }
        });
    }

    // --- SAVE TO CLOUD ---
    function saveToCloud() {
        if (!ALLOWED_UIDS.includes(currentUser?.uid)) return alert("You don't have permission to edit.");
        set(ref(rtdb, 'joey_v37'), globalData)
            .then(() => console.log("Cloud Saved"))
            .catch((e) => alert("Save failed: " + e.message));
    }

    // --- EXPORT APP FUNCTIONS (for HTML buttons) ---
    window.app = {
        saveSession: () => {
             const batchId = Date.now();
             sessionQueue.forEach(g => g.batchId = batchId);
             globalData.history.push(...sessionQueue);
             sessionQueue = [];
             saveToCloud();
             ui.renderQueue();
             alert("Saved to Cloud!");
        },
        addToQueue: () => {
            const opp = document.getElementById('mOpp').value;
            if(!opp) return alert("Select Opponent");
            let dVal = document.getElementById('mDate').value || new Date().toISOString().split('T')[0];
            sessionQueue.push({
                id: Date.now()+Math.random(), date:dVal, team:activeContext, opp:opp, tourn:document.getElementById('mTourn').value,
                our:parseInt(document.getElementById('mOur').value)||0, their:parseInt(document.getElementById('mTheir').value)||0,
                coach:document.getElementById('mCoach').value,
                scorers:Array.from(document.querySelectorAll('.m-sc-input')).map(s=>s.value),
                awards:Array.from(document.querySelectorAll('.m-aw-input')).filter(s=>s.value).map(s=>({name:s.dataset.name, player:s.value})),
                notes:document.getElementById('mNotes').value, season:globalData.settings.currentSeason
            });
            ui.renderQueue(); 
            // clear inputs
            document.getElementById('mOur').value=0; document.getElementById('mTheir').value=0;
        },
        migrateLocalToCloud: () => {
            // Read old V36 data
            const local = localStorage.getItem('joey_v36');
            if (!local) return alert("No local data found on this device.");
            if (!confirm("Overwrite Cloud data with Local data? This cannot be undone.")) return;
            try {
                const parsed = JSON.parse(local);
                globalData = parsed;
                saveToCloud();
                alert("Migration Successful! Data is now in the cloud.");
            } catch(e) { alert("Error migrating: " + e); }
        },
        // Wrappers for Admin/Editing that call saveToCloud
        adminAddItem: (k, id) => {
            const t = document.getElementById('admTeamSelect').value;
            const v = document.getElementById(id).value.trim();
            if(v) { globalData.teams[t][k].push(v); document.getElementById(id).value=""; saveToCloud(); ui.renderAdminDetails(); }
        },
        startNewSeason: () => {
            const n = document.getElementById('newSeasonNameInput').value;
            if(n) { globalData.settings.seasons.push(n); globalData.settings.currentSeason = n; saveToCloud(); document.getElementById('newSeasonModal').classList.add('hidden'); }
        },
        createTournamentFromHub: () => {
            const n = document.getElementById('newTournNameModal').value;
            if(n) {
                if(!globalData.teams[activeContext].tournaments) globalData.teams[activeContext].tournaments = [];
                globalData.teams[activeContext].tournaments.push({name:n, active:true, winner:""});
                saveToCloud();
                document.getElementById('addTournModal').classList.add('hidden');
                // Auto-select will happen on re-render if we coded it right, or just let user pick
            }
        },
        saveTournWinner: () => {
            const tName = activeContext;
            const trName = document.getElementById('tournSelector').value;
            const win = document.getElementById('tournWinnerInput').value;
            const idx = globalData.teams[tName].tournaments.findIndex(t=>t.name===trName);
            if(idx !== -1) { globalData.teams[tName].tournaments[idx].winner = win; saveToCloud(); alert("Winner Saved"); }
        }
        // ... (Add wrappers for deleteMatch, etc. essentially replacing save() with saveToCloud())
    };

    // --- UI LOGIC (Similar to V36 but using globalData) ---
    window.ui = {
        renderNav: () => {
            const p = document.getElementById('navPrimary'); p.innerHTML='';
            Object.keys(globalData.teams).forEach(t => {
                const b = document.createElement('div'); b.className=`nav-btn ${activeContext===t?'active':''}`; b.innerText=t;
                b.onclick=()=>{activeContext=t; ui.switchSubTab('Stats');}; p.appendChild(b);
            });
            // Add Career/Admin buttons...
            const a = document.createElement('div'); a.className=`nav-btn admin ${activeContext==='Admin'?'active':''}`; a.innerText='âš™ï¸ Admin'; a.onclick=()=>ui.switchContext('Admin'); p.appendChild(a);
            // Render secondary nav logic...
            if(activeContext==='Admin') document.getElementById('navSecondary').classList.add('hidden');
            else document.getElementById('navSecondary').classList.remove('hidden');
        },
        switchContext: (c) => { activeContext = c; ui.renderNav(); ui.renderMainView(); },
        switchSubTab: (t) => { activeSubTab = t; ui.renderNav(); ui.renderMainView(); },
        renderMainView: () => {
            // Hide all views
            ['viewMatchDay','viewTournaments','viewAdmin','viewCareer'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            
            if(activeContext === 'Admin') {
                document.getElementById('viewAdmin').classList.remove('hidden');
                // Render Admin
                const sel = document.getElementById('admTeamSelect');
                sel.innerHTML=''; Object.keys(globalData.teams).forEach(t=>sel.add(new Option(t,t)));
                ui.renderAdminDetails();
            } else if (activeContext !== 'Career') {
                // Team Views
                document.documentElement.style.setProperty('--primary', globalData.teams[activeContext].color);
                if(activeSubTab === 'Stats') {
                    document.getElementById('viewMatchDay').classList.remove('hidden');
                    document.getElementById('teamStatTitle').innerText = activeContext;
                    ui.renderMatchDayInputs();
                    ui.renderTeamStats();
                    ui.renderHistory(globalData.history.filter(m=>m.team===activeContext && m.season===globalData.settings.currentSeason));
                    ui.renderLeagueTable();
                } else {
                    document.getElementById('viewTournaments').classList.remove('hidden');
                    ui.renderTournHub();
                }
            }
        },
        renderMatchDayInputs: () => {
            const t = globalData.teams[activeContext];
            const fill = (id, arr) => {const el=document.getElementById(id); el.innerHTML=""; arr.forEach(x=>el.add(new Option(x,x)))};
            fill('mOpp', t.opps || []); fill('mCoach', t.coaches || []);
            // populate mTourn...
        },
        renderQueue: () => {
            document.getElementById('matchQueue').innerHTML = sessionQueue.map((g,i)=>`<div>vs ${g.opp} (${g.our}-${g.their})</div>`).join('');
            document.getElementById('btnFinalize').classList.toggle('hidden', sessionQueue.length===0);
        },
        renderTeamStats: () => {
            // Calculate stats for current season/team
        },
        renderHistory: (data) => {
             const list = document.getElementById('teamHistoryList'); list.innerHTML = data.reverse().map(m => `
                <div class="match-row">
                    <div><strong>vs ${m.opp}</strong> <span style="font-size:0.8em">${m.tourn}</span></div>
                    <div class="result-badge ${m.our>m.their?'res-w':m.our<m.their?'res-l':'res-d'}">${m.our}-${m.their}</div>
                </div>
             `).join('');
        },
        renderLeagueTable: () => {
            // Same aggregated logic as V36
        },
        renderTournHub: () => {
            const sel = document.getElementById('tournSelector');
            // Populate if empty...
            const val = sel.value;
            if(!val) { document.getElementById('tournStatsArea').classList.add('hidden'); return; }
            document.getElementById('tournStatsArea').classList.remove('hidden');
            // Render stats for tournament...
        },
        renderAdminDetails: () => {
            // Populate admin lists...
        }
    };

    function applyTheme() { document.body.setAttribute('data-theme', globalData.settings.theme); }
    
    // Quick Fix for Scorer Rendering in Inputs
    document.getElementById('mOur').addEventListener('input', () => {
        // Logic to create dropdowns based on goal count
    });

</script>
</body>
</html>
