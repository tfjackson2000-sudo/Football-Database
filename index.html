<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Football Tracker V136</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#222222">

    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>âš½</text></svg>">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22 style=%22background:white;%22><rect width=%22100%22 height=%22100%22 fill=%22white%22/><text x=%2250%22 y=%2250%22 dominant-baseline=%22central%22 text-anchor=%22middle%22 font-size=%2270%22>âš½</text></svg>">

    <style>
        :root { 
            --bg: #f4f4f5; --card: #ffffff; --text: #1f1f1f; --text-muted: #666; --border: #e4e4e7; 
            --primary: #333333; --primary-tint: #f0f0f0; --text-on-primary: #ffffff; --accent: #DAA520;        
            --text-highlight: #111111; --success: #28a745; --danger: #dc3545; --shadow: 0 4px 12px rgba(0,0,0,0.06); --table-head-bg: #f0f0f0;
        }
        [data-theme="dark"] { 
            --bg: #121212; --card: #1e1e1e; --text: #e4e6eb; --text-muted: #b0b3b8; --border: #333333; 
            --shadow: 0 4px 12px rgba(0,0,0,0.4); --text-highlight: #ffffff; --primary-tint: #2a2a2a; --table-head-bg: #2d2d2d;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding-bottom: 40px; padding-top: env(safe-area-inset-top); min-height: 100vh; display: flex; flex-direction: column; }
        
        .app-header { text-align: center; padding: 10px 15px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: center; align-items: center; position: relative; }
        .logo-text { font-weight: 900; font-size: 1.5rem; letter-spacing: -0.5px; }
        .logo-wrapper { display: flex; align-items: center; gap: 10px; }
        
        .sticker { padding: 4px 8px; border-radius: 4px; font-weight: 800; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 2px solid #fff; white-space: nowrap; display: inline-block; }
        .season-sticker { background: linear-gradient(135deg, #FFD700, #DAA520); color: #000; transform: rotate(-3deg); margin-left: 10px; }
        .clubs-sticker { background: #111 !important; color: #fff !important; transform: rotate(-2deg); margin-right: 0; flex-shrink: 0; }
        .admin-icon-btn { position: absolute; right: 15px; background: none; border: none; font-size: 1.4rem; cursor: pointer; color: var(--text-muted); }

        .nav-container { background: var(--card); border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .clubs-container { display: flex; align-items: center; padding: 10px 15px; border-bottom: 1px solid var(--border); gap: 10px; overflow-x: hidden; }
        
        @media (min-width: 768px) { .clubs-container { justify-content: center; } .clubs-scroll-area { flex-grow: 0 !important; } }
        .clubs-scroll-area { flex-grow: 1; overflow-x: auto; white-space: nowrap; display: flex; gap: 8px; padding-bottom: 2px; scrollbar-width: none; }
        .clubs-scroll-area::-webkit-scrollbar { display: none; }

        .nav-btn { padding: 6px 14px; border-radius: 20px; cursor: pointer; font-weight: 700; font-size: 0.85rem; white-space: nowrap; border: 1px solid var(--border); background: var(--bg); color: var(--text-muted); opacity: 0.8; }
        .nav-btn.active { transform: translateY(-1px); box-shadow: 0 2px 5px rgba(0,0,0,0.2); background: var(--primary); color: var(--text-on-primary); border-color: transparent; opacity: 1; }
        .career-pill { border: 1px solid #DAA520; color: #B8860B; background: var(--card); }
        .career-pill.active { background: linear-gradient(135deg, #DAA520, #FFD700); color: #000; }

        .container { max-width: 800px; margin: 25px auto; padding: 0 15px; width: 100%; box-sizing: border-box; flex-grow: 1; }
        .card { background: var(--card); border-radius: 16px; margin-bottom: 25px; box-shadow: var(--shadow); border: 1px solid var(--border); overflow: hidden; }
        .card-header { font-size: 1.1rem; font-weight: 800; padding: 15px 20px; display:flex; justify-content:space-between; align-items:center; background: var(--primary-tint); color: var(--text-highlight); border-bottom: 1px solid var(--border); }
        .card-body { padding: 20px; }
        
        .stat-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; text-align: center; }
        .stat-item { background: var(--bg); padding: 10px; border-radius: 10px; border: 1px solid var(--border); }
        .stat-item strong { font-size: 1.5rem; color: var(--text-highlight); display: block; line-height: 1; }

        .form-group { margin-bottom: 20px; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        select, input, textarea { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; font-size: 1rem; background: var(--card); color: var(--text); box-sizing: border-box; }
        .flex-row { display: flex; gap: 10px; align-items: center; }
        .flex-grow { flex: 1; min-width: 0; }
        .color-picker { width: 50px !important; flex: none !important; padding: 2px; height: 45px; cursor: pointer; border-radius: 8px; border: 1px solid var(--border); }

        .admin-list li { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border); align-items: center; }
        .admin-list li:last-child { border-bottom: none; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 10px; font-weight: 800; cursor: pointer; font-size: 0.95rem; margin-top:5px; }
        .btn-add { background: var(--primary); color: var(--text-on-primary); }
        .btn-save { background: var(--success); color: white; }
        .btn-update { background: #3b82f6; color: white; }
        .btn-del { background: transparent; color: var(--danger); font-size: 1.1rem; padding: 0 10px; width: auto; }
        .btn-edit { background: transparent; color: #3b82f6; font-size: 1.2rem; padding: 0 10px; width: auto; }
        .btn-sm { font-size: 0.8rem; padding: 4px 8px; width: auto; font-weight: 600; border: 1px solid var(--border); background: var(--bg); color: var(--text); }
        .btn-google { background: #4285F4; color: white; margin-bottom: 10px; }
        .btn-guest { background: transparent; border: 2px solid var(--border); color: var(--text); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-cancel { background: transparent; border: 1px solid var(--danger); color: var(--danger); }

        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; margin-top: 10px; table-layout: fixed; }
        th { background: var(--table-head-bg); color: var(--text-highlight); padding: 12px 6px; font-size: 0.75rem; text-transform: uppercase; border-bottom: 2px solid var(--border); text-align: center; }
        td { padding: 12px 6px; border-bottom: 1px solid var(--border); text-align: center; white-space: nowrap; }
        th:first-child, td:first-child { text-align: left; width: 35%; padding-left: 10px; white-space: normal; }
        .is-me { background: var(--primary-tint); font-weight: bold; }

        .lineup-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 8px; margin-top: 10px; }
        .lineup-item { background: var(--bg); border: 1px solid var(--border); padding: 8px; border-radius: 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 8px; cursor: pointer; }
        .lineup-item input { width: auto; padding: 0; margin: 0; cursor: pointer; }
        
        .hidden { display: none !important; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; display: flex; justify-content: center; align-items: center; padding: 20px; box-sizing: border-box; }
        .modal-box { background: var(--card); padding: 25px; border-radius: 16px; width: 100%; max-width: 450px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); border: 1px solid var(--border); max-height: 90vh; overflow-y: auto; }
        
        #toast { visibility: hidden; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 12px 24px; border-radius: 50px; display: flex; align-items: center; gap: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 3000; opacity: 0; transition: opacity 0.3s; pointer-events: none; }
        #toast.visible { visibility: visible; opacity: 1; pointer-events: all; }
        #toast button { background: transparent; border: none; color: #4dabf7; font-weight: bold; cursor: pointer; padding: 0; font-size: 0.95rem; }

        .app-footer { margin-top: auto; padding: 20px 15px 40px 15px; text-align: center; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; opacity: 0.8; border-top: 1px solid var(--border); background: var(--bg); }
        #authOverlay, #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg); z-index:9999; display:flex; justify-content:center; align-items:center; flex-direction:column; padding: 20px; text-align: center; }
        .auth-card { background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); max-width: 400px; width: 100%; border: 1px solid var(--border); }
        
        /* MATCH HISTORY ROUNDED BOXES & LAYOUT */
        .history-group { background: var(--card); border: 1px solid var(--border); border-radius: 16px; margin-bottom: 25px; overflow: hidden; box-shadow: var(--shadow); }
        .group-header { background: var(--primary-tint); padding: 12px 15px; border-bottom: 1px solid var(--border); }
        .gh-top { display: flex; justify-content: space-between; align-items: center; }
        
        .match-row { padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; background: var(--card); gap: 10px; }
        .match-row:last-child { border-bottom: none; }
        
        .match-info { flex-grow: 1; min-width: 0; }
        .match-actions { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; min-width: 80px; }
        
        .result-badge { padding: 8px 12px; border-radius: 8px; font-weight: 800; font-size: 1rem; min-width: 45px; text-align: center; display: inline-block; }
        .res-w { background: rgba(40, 167, 69, 0.15); color: #28a745; }
        .res-l { background: rgba(220, 53, 69, 0.15); color: #dc3545; }
        .res-d { background: rgba(255, 193, 7, 0.15); color: #d39e00; }
        
        .detail-grid { margin-top: 5px; font-size: 0.85rem; color: var(--text-muted); line-height: 1.4; }
        .dt-label { font-size: 0.7rem; text-transform: uppercase; opacity: 0.7; font-weight: bold; margin-top: 4px; }
        .dt-val { font-weight: 500; }
        
        .gh-awards { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
        .aw-tag { background: linear-gradient(135deg, #FFD700, #DAA520); color: #000; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 800; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 4px; border: 1px solid #B8860B; }
        
        details > summary { list-style: none; cursor: pointer; outline: none; font-weight: bold; font-size: 1.1rem; }
        details > summary::after { content: ' â–¼'; float: right; font-size: 0.8em; opacity: 0.5; }
        details[open] > summary::after { transform: rotate(180deg); }
        
        /* RADIO TOGGLE BUTTONS */
        .toggle-group { display: flex; gap: 10px; margin-bottom: 15px; }
        .toggle-group label { flex: 1; text-align: center; padding: 10px; border: 1px solid var(--border); border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 0.9rem; background: var(--bg); color: var(--text-muted); transition: 0.2s; }
        .toggle-group input { display: none; }
        .toggle-group input:checked + span { color: var(--text-highlight); }
        .toggle-group label:has(input:checked) { background: var(--primary-tint); border-color: var(--primary); box-shadow: inset 0 0 0 1px var(--primary); }
    </style>
</head>
<body>

<div id="loadingOverlay">
    <div style="display:flex; align-items:center; gap:10px;">
        <span style="font-size: 2rem;">âš½</span>
        <h2 class="logo-text" style="font-size: 2rem;">Football Tracker</h2>
        <span style="font-size: 2rem;">âš½</span>
    </div>
    <p style="margin-top:10px;">â˜ï¸ Syncing...</p>
</div>

<div id="authOverlay" class="hidden">
    <div class="auth-card">
        <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin-bottom:10px;">
            <span style="font-size: 2rem;">âš½</span>
            <h2 style="margin:0;" class="logo-text">Football Tracker</h2>
            <span style="font-size: 2rem;">âš½</span>
        </div>
        <p style="color:var(--text-muted); margin-bottom:20px;">Please sign in to manage your data.</p>
        <button id="btnLogin" class="btn btn-google">Sign in with Google</button>
        <button id="btnGuest" class="btn btn-guest" onclick="app.enterAsGuest()">Guest View</button>
    </div>
</div>

<div id="toast"><span id="toastMsg">Deleted</span><button onclick="app.performUndo()">UNDO</button></div>

<div class="nav-container hidden" id="mainNav">
    <div class="app-header">
        <div class="logo-wrapper">
            <span class="logo-icon">âš½</span>
            <span class="logo-text">Football Tracker</span>
            <div id="headerSeasonBadge" class="sticker season-sticker"></div>
        </div>
        <button class="admin-icon-btn protected-area" onclick="ui.switchContext('Admin')">âš™ï¸</button>
    </div>
    <div class="clubs-container">
        <div class="sticker-area">
            <div id="clubsSticker" class="sticker clubs-sticker">Stats</div>
        </div>
        <div class="nav-divider"></div>
        <div id="navRowTeams" class="clubs-scroll-area"></div>
    </div>
</div>

<div class="container hidden" id="mainApp">
    
    <div id="viewMatchDay" class="hidden">
        <div class="card">
            <div class="card-header"><span>ğŸ“Š <span id="teamStatTitle">Stats</span></span></div>
            <div class="card-body">
                <div class="stat-grid">
                    <div class="stat-item"><span>Games</span><strong id="st-p">0</strong></div>
                    <div class="stat-item"><span>Wins</span><strong id="st-w">0</strong></div>
                    <div class="stat-item"><span>Goals</span><strong id="st-g">0</strong></div>
                    <div class="stat-item"><span>Awards</span><strong id="st-a">N/A</strong></div>
                </div>
            </div>
        </div>
        
        <div class="card"><details open><summary class="card-header">ğŸ† League Table</summary><div class="card-body" style="padding:0;"><table id="teamLeagueTable"><thead><tr><th>Team</th><th class="num-col">P</th><th class="num-col">W</th><th class="num-col">D</th><th class="num-col">L</th><th class="num-col">GD</th><th class="num-col">Pts</th></tr></thead><tbody></tbody></table></div></details></div>
        <div class="card"><details><summary class="card-header">ğŸ‘Ÿ Top Scorers</summary><div class="card-body" style="padding:0;"><table id="topScorerTable"><thead><tr><th>Player</th><th class="num-col">Goals</th></tr></thead><tbody></tbody></table></div></details></div>
        <div class="card" style="background:transparent; box-shadow:none; border:none;"><details open><summary class="card-header" style="border-radius:16px;">ğŸ•’ Match History</summary><div id="teamHistoryList" style="padding-top:15px;"></div></details></div>

        <div class="card protected-area">
            <details>
                <summary class="card-header">âš½ Standard Match Input</summary>
                <div class="card-body">
                    <div class="form-group"><label>Date:</label><input type="date" id="mDate"></div>
                    <div class="form-group"><label>Competition:</label><select id="mTourn"><option value="League">League</option></select></div>
                    <div class="form-row"><div><label>Opponent:</label><select id="mOpp"></select></div><div><label>Manager:</label><select id="mCoach"></select></div></div>
                    
                    <div class="form-group" style="border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--bg);">
                        <div class="lineup-header">
                            <label style="margin:0;">ğŸƒâ€â™‚ï¸ Lineup (Who played?)</label>
                            <button type="button" class="btn-sm" onclick="app.selectAllLineup('m')">Select All</button>
                        </div>
                        <div id="mLineupArea" class="lineup-grid"></div>
                    </div>

                    <div class="form-row"><div><label>Us:</label><input type="number" id="mOur" value="0" oninput="app.renderScorers('m')"></div><div><label>Them:</label><input type="number" id="mTheir" value="0"></div></div>
                    <div id="mScorerList" class="form-group"></div>
                    <div class="form-group"><label>Notes:</label><textarea id="mNotes" rows="2"></textarea></div>
                    <button type="button" class="btn btn-add" onclick="app.addToQueue()">+ Add Game to Queue</button>
                    <div id="matchQueue" style="margin-top:15px; padding-top:15px; border-top:1px solid var(--border);"></div>
                    <button type="button" id="btnFinalize" class="btn btn-save hidden" onclick="app.saveSession()">ğŸ’¾ Save Session</button>
                </div>
            </details>
        </div>

        <div class="card">
            <details>
                <summary class="card-header">ğŸ† Tournament Hub</summary>
                <div class="card-body">
                    <div class="form-group" style="clear:both; padding-top:10px;"><label>Select Tournament:</label><select id="tournSelector" onchange="ui.renderTournamentView()"></select></div>
                    
                    <div id="tournStatsArea" class="hidden">
                        
                        <div class="stat-grid" style="margin-bottom:20px;">
                            <div class="stat-item"><span>Games</span><strong id="tr-p">0</strong></div>
                            <div class="stat-item"><span>Wins</span><strong id="tr-w">0</strong></div>
                            <div class="stat-item"><span>Goals</span><strong id="tr-g">0</strong></div>
                            <div class="stat-item"><span>Awards</span><strong id="tr-a">0</strong></div>
                        </div>
                        
                        <div class="protected-area flex-row" style="justify-content: flex-end; margin-bottom: 20px;">
                            <button type="button" class="btn-edit" style="width:auto; border:1px solid var(--border);" onclick="app.openEditActiveTourn()">âš™ï¸ Manage in Admin</button>
                        </div>
                        
                        <div class="card protected-area" style="border: 2px solid var(--accent); box-shadow: none;">
                            <div class="card-header" style="background:rgba(218, 165, 32, 0.1);">âš½ Log Tournament Game</div>
                            <div class="card-body">
                                
                                <div class="toggle-group">
                                    <label><input type="radio" name="tmType" value="us" checked onchange="ui.toggleTournInput()"><span>Our Match</span></label>
                                    <label><input type="radio" name="tmType" value="other" onchange="ui.toggleTournInput()"><span>Other Teams</span></label>
                                </div>
                                
                                <div id="tmUsInput">
                                    <div class="form-row">
                                        <div><label>Opponent:</label><select id="tmOpp"></select></div>
                                        <div><label>Manager:</label><select id="tmCoach"></select></div>
                                    </div>
                                    <div class="form-group" style="border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--bg);">
                                        <div class="lineup-header"><label style="margin:0;">ğŸƒâ€â™‚ï¸ Squad</label><button type="button" class="btn-sm" onclick="app.selectAllLineup('tm')">Select All</button></div>
                                        <div id="tmLineupArea" class="lineup-grid"></div>
                                    </div>
                                    <div class="form-row">
                                        <div><label>Us:</label><input type="number" id="tmOur" value="0" oninput="app.renderScorers('tm')"></div>
                                        <div><label>Them:</label><input type="number" id="tmTheir" value="0"></div>
                                    </div>
                                    <div id="tmScorerList" class="form-group"></div>
                                </div>

                                <div id="tmOtherInput" class="hidden">
                                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:15px;">Log games between other teams to update the tournament league table.</p>
                                    <div class="form-row">
                                        <div><label>Team 1:</label><select id="tmTeamA"></select></div>
                                        <div><label>Score:</label><input type="number" id="tmScoreA" value="0"></div>
                                    </div>
                                    <div class="form-row">
                                        <div><label>Team 2:</label><select id="tmTeamB"></select></div>
                                        <div><label>Score:</label><input type="number" id="tmScoreB" value="0"></div>
                                    </div>
                                </div>
                                
                                <button type="button" class="btn btn-save" onclick="app.saveTournMatch()">ğŸ’¾ Save Game</button>
                            </div>
                        </div>

                        <div class="card" style="box-shadow:none; border:none; padding:0; margin-bottom: 0;">
                            <details open>
                                <summary class="card-header" style="border-radius:10px; padding: 10px 15px; font-size: 1rem;">ğŸ“Š Tournament Table</summary>
                                <div class="card-body" style="padding:0;">
                                    <table id="tournLeagueTable">
                                        <thead><tr><th>Team</th><th class="num-col">P</th><th class="num-col">W</th><th class="num-col">D</th><th class="num-col">L</th><th class="num-col">GD</th><th class="num-col">Pts</th></tr></thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </details>
                        </div>
                        
                        <div class="protected-area" style="background:var(--primary-tint); padding:15px; border-radius:10px; margin-top:20px; border:1px solid var(--border);">
                            <label>ğŸ† Tournament Winner:</label>
                            <div class="flex-row">
                                <input type="text" id="tournWinnerInput" placeholder="Enter winner" class="flex-grow">
                                <button type="button" class="btn btn-save" style="width:auto; margin-top:0;" onclick="app.saveTournWinner()">Save</button>
                            </div>
                        </div>

                        <h3 style="margin-top:25px; border-bottom:2px solid var(--border);">ğŸ•’ Fixtures</h3>
                        <div id="tournHistoryList"></div>
                    </div>
                </div>
            </details>
        </div>
    </div>

    <div id="viewCareer" class="hidden">
        <div class="card" style="border-color: #DAA520;">
            <div class="card-header" style="background:rgba(218, 165, 32, 0.1);"><span>ğŸŒŸ Career Overview</span><select id="careerSeasonFilter" onchange="ui.renderCareer()" style="width:auto;"><option value="All Time">All Time</option></select></div>
            <div class="card-body">
                <div class="stat-grid"><div class="stat-item"><span>Games</span><strong id="c-p">0</strong></div><div class="stat-item"><span>Wins</span><strong id="c-w">0</strong></div><div class="stat-item"><span>Goals</span><strong id="c-g">0</strong></div><div class="stat-item"><span>Awards</span><strong id="c-a">0</strong></div></div>
            </div>
        </div>
        <div class="card"><div class="card-header" style="background:rgba(218, 165, 32, 0.1);">ğŸ† Your Clubs Comparison</div><div class="card-body" style="padding:0;"><table id="masterTable"><thead><tr><th class="t-left">Team</th><th>P</th><th>W</th><th>D</th><th>L</th><th>GD</th><th>GF</th><th>Pts</th></tr></thead><tbody></tbody></table></div></div>
    </div>

    <div id="viewAdmin" class="hidden protected-area">
        <h2 style="margin-bottom:20px;">âš™ï¸ Admin</h2>
        <div class="card"><div class="card-header">ğŸ›  Select Team</div><div class="card-body"><div class="flex-row"><select id="admTeamSelect" onchange="ui.renderAdminDetails()" class="flex-grow"></select></div></div></div>
        <div class="card"><div class="card-header">ğŸ“… Season</div><div class="card-body"><div class="flex-row"><select id="admActiveSeason" onchange="app.switchActiveSeason()" class="flex-grow"></select><button type="button" class="btn-del" style="width:auto;" onclick="app.deleteSeason()">ğŸ—‘</button></div><button type="button" class="btn btn-save" onclick="document.getElementById('newSeasonModal').classList.remove('hidden')">â• New Season</button></div></div>
        
        <div class="card"><div class="card-header">ğŸƒâ€â™‚ï¸ Squad</div><div class="card-body">
            <div class="form-group">
                <div class="flex-row" style="gap:5px;">
                    <input type="text" id="admNewPlayerFirst" placeholder="First Name" class="flex-grow">
                    <input type="text" id="admNewPlayerLast" placeholder="Surname" class="flex-grow">
                    <input type="number" id="admNewPlayerNum" placeholder="#" style="width:60px;">
                </div>
                <div class="flex-row" style="margin-top:10px;">
                    <button type="button" id="btnAddUpdatePlayer" class="btn btn-add" onclick="app.adminAddPlayer()">+ Add Player</button>
                    <button type="button" id="btnCancelPlayer" class="btn btn-cancel hidden" onclick="app.cancelEdit('player')">Cancel</button>
                </div>
            </div>
            <ul id="admPlayerList" class="admin-list"></ul>
        </div></div>

        <div class="card"><div class="card-header">ğŸ‘” Managers</div><div class="card-body">
            <div class="form-group flex-row">
                <input type="text" id="admNewCoach" placeholder="Add Manager" class="flex-grow">
                <button type="button" id="btnAddUpdateCoach" class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddCoach()">Add</button>
                <button type="button" id="btnCancelCoach" class="btn btn-cancel hidden" style="width:auto; margin-top:0;" onclick="app.cancelEdit('coach')">âœ•</button>
            </div>
            <ul id="admCoachList" class="admin-list"></ul>
        </div></div>

        <div class="card"><div class="card-header">ğŸ›¡ Opponents</div><div class="card-body">
            <div class="form-group flex-row">
                <input type="text" id="admNewOpp" placeholder="Add Opponent" class="flex-grow">
                <button type="button" id="btnAddUpdateOpp" class="btn btn-add" style="width:auto; margin-top:0;" onclick="app.adminAddOpp()">Add</button>
                <button type="button" id="btnCancelOpp" class="btn btn-cancel hidden" style="width:auto; margin-top:0;" onclick="app.cancelEdit('opp')">âœ•</button>
            </div>
            <ul id="admOppList" class="admin-list"></ul>
        </div></div>
        
        <div class="card"><div class="card-header">ğŸ† Tournaments</div><div class="card-body">
            <button type="button" class="btn btn-add" style="margin-bottom:15px;" onclick="app.openTournConfigModal(-1)">+ Create Tournament</button>
            <ul id="admTournList" class="admin-list"></ul>
        </div></div>

        <div class="card"><div class="card-header">ğŸ… Awards</div><div class="card-body">
            <div class="flex-row" style="margin-bottom:10px; align-items:flex-end;">
                <input type="text" id="newAwardName" placeholder="Name" class="flex-grow">
                <div style="width:100px;">
                    <label style="font-size:0.7rem; color:var(--text-muted); display:block;">Max Qty</label>
                    <input type="number" id="newAwardMax" placeholder="1" style="width:100%;">
                </div>
                <button type="button" id="btnAddUpdateAward" class="btn btn-save" style="width:auto; margin-top:12px;" onclick="app.adminAddAward()">Add</button>
                <button type="button" id="btnCancelAward" class="btn btn-cancel hidden" style="width:auto; margin-top:12px;" onclick="app.cancelEdit('award')">âœ•</button>
            </div>
            <ul id="admAwardList" class="admin-list"></ul>
        </div></div>

        <div class="card neutral-card"><div class="card-header">ğŸŒ Global Settings</div><div class="card-body"><p style="color:var(--text-muted); font-size:0.85rem; margin-bottom:15px;">Note: Profile selection is now personal to each device (see footer). The setting below only sets a default for new visitors.</p><label style="display:block; margin-bottom:5px;">Default Profile Name:</label><div class="flex-row" style="margin-bottom:20px;"><select id="adminProfileName" class="flex-grow"></select><button type="button" class="btn btn-save" style="width:auto; margin-top:0;" onclick="app.saveProfileName()">Save</button></div>
        
        <label style="display:block; margin-bottom:5px;">Manage/Add Club:</label>
        <div class="flex-row" style="margin-bottom:15px;">
            <input type="text" id="newTeamName" placeholder="Club Name" class="flex-grow">
            <input type="color" id="newTeamColor" value="#333333" class="color-picker">
            <button type="button" id="btnAddUpdateClub" class="btn btn-add" style="width:auto; margin-top:0; background:#333;" onclick="app.adminAddClub()">Create</button>
            <button type="button" id="btnCancelClub" class="btn btn-cancel hidden" style="width:auto; margin-top:0;" onclick="app.cancelEdit('club')">âœ•</button>
        </div>
        <ul id="admClubList" class="admin-list" style="margin-bottom:0;"></ul></div></div>
    </div>
    <div class="version-tag">V136</div>
</div>

<footer class="app-footer" id="appFooter">
    <button id="btnSwitchProfile" onclick="app.openProfileModal()">ğŸ‘¤ Profile: Loading...</button>
    <button onclick="app.toggleTheme()">ğŸŒ“ Theme</button>
    <button onclick="app.doSignOut()">ğŸšª Log Out</button>
</footer>

<div id="tournConfigModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3 id="tcTitle">Tournament Setup</h3>
        <input type="hidden" id="tcIndex" value="-1">
        
        <div class="form-group">
            <label>Tournament Name:</label>
            <input type="text" id="tcName" placeholder="e.g., Summer Cup 2026">
        </div>
        <div class="form-group">
            <label>Tournament Date:</label>
            <input type="date" id="tcDate">
        </div>
        
        <div class="form-group">
            <label>Other Teams Participating:</label>
            <p style="font-size:0.75rem; color:var(--text-muted); margin-top:0;">Type names separated by commas.</p>
            <textarea id="tcTeams" rows="2" placeholder="e.g. Red FC, Blue Utd, Green City"></textarea>
        </div>
        
        <div class="form-group" style="border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--bg);">
            <div class="lineup-header">
                <label style="margin:0;">ğŸƒâ€â™‚ï¸ Our Tournament Squad:</label>
                <button type="button" class="btn-sm" onclick="app.tcSelectAllSquad()">Select All</button>
            </div>
            <div id="tcSquadArea" class="lineup-grid" style="max-height:150px; overflow-y:auto;"></div>
        </div>

        <button class="btn btn-save" onclick="app.saveTournConfig()">ğŸ’¾ Save Tournament</button>
        <button class="btn btn-outline" onclick="document.getElementById('tournConfigModal').classList.add('hidden')">Cancel</button>
    </div>
</div>

<div id="newSeasonModal" class="modal-overlay hidden"><div class="modal-box"><h3>New Season</h3><input type="text" id="newSeasonNameInput" placeholder="YYYY/YY"><button class="btn btn-save" onclick="app.startNewSeason()">Start</button><button class="btn" onclick="document.getElementById('newSeasonModal').classList.add('hidden')">Cancel</button></div></div>
<div id="profileModal" class="modal-overlay hidden"><div class="modal-box"><h3>ğŸ‘¤ Switch Profile</h3><p style="color:var(--text-muted); margin-bottom:15px; font-size:0.9rem;">Select your name to see your personal stats. This only affects this device.</p><div class="form-group"><select id="profileSelect"></select></div><button class="btn btn-save" onclick="app.confirmProfileSwitch()">Switch</button><button class="btn btn-outline" onclick="document.getElementById('profileModal').classList.add('hidden')">Cancel</button></div></div>

<div id="daySummaryModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Edit Awards & Honors</h3>
        <input type="hidden" id="dsDate">
        <p id="dsDateDisplay" style="color:var(--text-muted); font-weight:bold; margin-bottom:15px;"></p>
        <div class="form-group" style="border-top:1px solid var(--border); padding-top:15px;">
            <label>ğŸ… Awards (For this day)</label>
            <div id="dsAwardList"></div>
            <button class="btn-sm" style="margin-top:5px;" onclick="window.app.addDayAwardRow()">+ Add Award</button>
        </div>
        <button class="btn btn-save" onclick="app.saveDaySummary()">Save Group Info</button>
        <button class="btn btn-outline" onclick="document.getElementById('daySummaryModal').classList.add('hidden')">Cancel</button>
    </div>
</div>

<div id="editModal" class="modal-overlay hidden">
    <div class="modal-box">
        <h3>Edit Match</h3>
        <input type="hidden" id="editId">
        <div class="form-group"><label>Date (Change to move Group)</label><input type="date" id="eDate"></div>
        <div class="form-group"><label>Tournament</label><select id="eTourn"></select></div>
        <div class="form-row"><div><label>Opponent</label><select id="eOpp"></select></div><div><label>Manager</label><select id="eCoach"></select></div></div>
        
        <div class="form-group" style="border:1px solid var(--border); padding:10px; border-radius:10px; background:var(--bg);">
            <div class="lineup-header">
                <label style="margin:0;">ğŸƒâ€â™‚ï¸ Lineup (Who played?)</label>
                <button type="button" class="btn-sm" onclick="app.selectAllLineup('e')">Select All</button>
            </div>
            <div id="eLineupArea" class="lineup-grid"></div>
        </div>

        <div class="form-row"><div><label>Us</label><input type="number" id="eOur" oninput="app.renderScorers('e')"></div><div><label>Them</label><input type="number" id="eTheir"></div></div>
        <div id="eScorerList"></div>
        <div class="form-group"><label>Notes</label><textarea id="eNotes"></textarea></div>
        <button class="btn btn-save" onclick="app.saveEditedMatch()">Save</button>
        <button class="btn btn-outline" onclick="document.getElementById('editModal').classList.add('hidden')">Cancel</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, onValue, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = { apiKey: "AIzaSyAkhLB-XkffuTny8yJOw_FCtZSRIo5qQLE", authDomain: "joeyfootball-875eb.firebaseapp.com", databaseURL: "https://joeyfootball-875eb-default-rtdb.europe-west1.firebasedatabase.app", projectId: "joeyfootball-875eb", storageBucket: "joeyfootball-875eb.firebasestorage.app", messagingSenderId: "647816306796", appId: "1:647816306796:web:686918e1d1c82b8a17f849", measurementId: "G-PX5PH27CES" };
    const ALLOWED_UIDS = ["QC6D1Smr9SVgpITffUTrRZSTQEq1", "Np9ZXcd2wNWvwsYA3X1QTcFpSIB3"];
    
    let fbApp, db, auth, rtdb, globalData, activeContext = "Career", sessionQueue = [], currentUser = null, isGuest = false;
    let lastDeleted = null, undoTimer = null;
    let lastActiveTeam = "Llanelli Town"; 
    let localProfileName = localStorage.getItem('userProfileName') || "Joey";
    
    // Edit States
    let editingPlayerIdx = -1, editingOppIdx = -1, editingCoachIdx = -1, editingAwardIdx = -1, editingTournIdx = -1, editingClubName = null;

    try { fbApp = initializeApp(firebaseConfig); rtdb = getDatabase(fbApp); auth = getAuth(fbApp); } 
    catch (e) { document.getElementById('loadingOverlay').innerHTML = "<h2>âš ï¸ Error</h2><p>Firebase Config Failed</p>"; }

    const btnLogin = document.getElementById('btnLogin');
    if(btnLogin) btnLogin.onclick = () => signInWithPopup(auth, new GoogleAuthProvider());

    window.app = window.app || {};
    window.ui = window.ui || {};

    window.app.enterAsGuest = () => { isGuest = true; currentUser = { uid: "GUEST" }; document.getElementById('authOverlay').classList.add('hidden'); document.getElementById('loadingOverlay').classList.remove('hidden'); document.body.classList.add('read-only-mode'); listenToData(); };
    window.app.doSignOut = () => { isGuest = false; signOut(auth).then(() => window.location.reload()); };
    window.app.toggleTheme = () => { globalData.settings.theme = globalData.settings.theme === 'light' ? 'dark' : 'light'; document.body.setAttribute('data-theme', globalData.settings.theme); if (!isGuest && ALLOWED_UIDS.includes(currentUser?.uid)) saveToCloud(); };

    onAuthStateChanged(auth, (user) => {
        if (isGuest) return; currentUser = user;
        if (user) { document.getElementById('authOverlay').classList.add('hidden'); if (ALLOWED_UIDS.includes(user.uid)) { document.body.classList.remove('read-only-mode'); document.querySelectorAll('.protected-area').forEach(el => el.classList.remove('hidden')); } else { document.body.classList.add('read-only-mode'); document.querySelectorAll('.protected-area').forEach(el => el.classList.add('hidden')); } listenToData(); } 
        else { document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('authOverlay').classList.remove('hidden'); document.getElementById('mainNav').classList.add('hidden'); document.getElementById('mainApp').classList.add('hidden'); document.getElementById('appFooter').classList.add('hidden'); }
    });

    function listenToData() {
        const dataRef = ref(rtdb, 'joey_v38');
        onValue(dataRef, (snapshot) => {
            document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('mainNav').classList.remove('hidden'); document.getElementById('mainApp').classList.remove('hidden'); document.getElementById('appFooter').classList.remove('hidden');
            const val = snapshot.val();
            if (val) { globalData = val; initUI(); } else { globalData = { teams: { "Llanelli Town": { color: "#d32f2f", players: ["Joey"], opps: [], coaches: [], awards: [], tournaments: [], active: true } }, history: [], daySummaries: {}, settings: { theme: 'light', currentSeason: "2025/26", seasons: ["2025/26"], profileName: "Joey" } }; if(!isGuest && ALLOWED_UIDS.includes(currentUser?.uid)) set(dataRef, globalData); initUI(); }
        });
    }

    function saveToCloud() { if (!ALLOWED_UIDS.includes(currentUser?.uid) || isGuest) return alert("Read Only Mode"); return set(ref(rtdb, 'joey_v38'), globalData); }

    function initUI() {
        if(!globalData.daySummaries) globalData.daySummaries = {};
        if(!globalData.settings.profileName) globalData.settings.profileName = "Joey"; 
        
        const allPlayers = [];
        if(globalData.teams) Object.values(globalData.teams).forEach(t => { if(t.players) allPlayers.push(...t.players); });
        
        if (!localStorage.getItem('userProfileName')) { 
            localProfileName = globalData.settings.profileName; 
            localStorage.setItem('userProfileName', localProfileName); 
        } else { 
            localProfileName = localStorage.getItem('userProfileName'); 
        }
        
        if(allPlayers.length > 0 && !allPlayers.includes(localProfileName)) {
             localProfileName = allPlayers[0];
             localStorage.setItem('userProfileName', localProfileName);
        }

        document.getElementById('btnSwitchProfile').innerText = `ğŸ‘¤ Profile: ${localProfileName}`;
        
        if (!activeContext || (activeContext !== 'Career' && activeContext !== 'Admin' && !globalData.teams[activeContext])) {
            activeContext = "Career";
        }
        
        if(globalData && !globalData.history) globalData.history = [];
        try { ui.switchContext(activeContext); } catch(e) { console.error(e); }
        document.body.setAttribute('data-theme', globalData?.settings?.theme || 'light');
    }
    
    function showToast(msg) { const t = document.getElementById('toast'); document.getElementById('toastMsg').innerText = msg; t.classList.add('visible'); if(undoTimer) clearTimeout(undoTimer); undoTimer = setTimeout(() => { t.classList.remove('visible'); lastDeleted = null; }, 5000); }
    const fmtDate = (ds) => { if(!ds) return ""; const d = new Date(ds); const day = d.getDate(); const m = d.toLocaleString('en-GB', { month: 'short' }); const y = d.getFullYear(); const s = ["th", "st", "nd", "rd"]; const v = day % 100; const suffix = s[(v - 20) % 10] || s[v] || s[0]; return `${day}${suffix} ${m} ${y}`; };
    function hexToRgb(hex) { let r = 0, g = 0, b = 0; if(hex.startsWith('#')) hex = hex.slice(1); if (hex.length === 3) { r = parseInt(hex[0]+hex[0], 16); g = parseInt(hex[1]+hex[1], 16); b = parseInt(hex[2]+hex[2], 16); } else if (hex.length === 6) { r = parseInt(hex.substring(0,2), 16); g = parseInt(hex.substring(2,4), 16); b = parseInt(hex.substring(4,6), 16); } return `rgba(${r},${g},${b}, 0.08)`; }

    // --- APP LOGIC ---
    Object.assign(window.app, {
        openProfileModal: () => {
            const sel = document.getElementById('profileSelect'); sel.innerHTML = '';
            let playerMap = {};
            if (globalData && globalData.teams) {
                Object.keys(globalData.teams).forEach(teamName => {
                    const team = globalData.teams[teamName];
                    if (team.players) {
                        team.players.forEach(p => {
                            if (!playerMap[p]) playerMap[p] = [];
                            playerMap[p].push(teamName);
                        });
                    }
                });
            }
            const sortedNames = Object.keys(playerMap).sort();
            sortedNames.forEach(p => {
                const teamList = playerMap[p].join(', ');
                const label = `${p} (${teamList})`;
                sel.add(new Option(label, p)); 
            });
            if(sortedNames.length === 0) sel.add(new Option("No players found", ""));
            sel.value = localProfileName; 
            document.getElementById('profileModal').classList.remove('hidden');
        },
        confirmProfileSwitch: () => {
            const newName = document.getElementById('profileSelect').value;
            if (newName) { 
                localProfileName = newName; 
                localStorage.setItem('userProfileName', newName); 
                document.getElementById('btnSwitchProfile').innerText = `ğŸ‘¤ Profile: ${localProfileName}`; 
                document.getElementById('profileModal').classList.add('hidden'); 
                ui.renderNav(); 
                ui.renderMainView(); 
            }
        },
        saveSession: () => { const batchId = Date.now(); sessionQueue.forEach(g => g.batchId = batchId); globalData.history.push(...sessionQueue); sessionQueue = []; saveToCloud().then(()=>{ui.renderQueue(); showToast("Saved!");}); },
        
        selectAllLineup: (p) => {
             const checks = document.querySelectorAll(`.${p}-lineup-chk`);
             checks.forEach(c => c.checked = true);
             app.renderScorers(p);
        },
        
        addToQueue: () => {
            const opp = document.getElementById('mOpp').value; if(!opp) return alert("Select Opponent");
            let dVal = document.getElementById('mDate').value || new Date().toISOString().split('T')[0];
            
            const lineup = [];
            document.querySelectorAll('.m-lineup-chk:checked').forEach(c => lineup.push(c.value));
            
            sessionQueue.push({ 
                id: Date.now()+Math.random(), 
                date: dVal, 
                team: activeContext, 
                opp: opp, 
                tourn: document.getElementById('mTourn').value, 
                our: parseInt(document.getElementById('mOur').value)||0, 
                their: parseInt(document.getElementById('mTheir').value)||0, 
                coach: document.getElementById('mCoach').value, 
                scorers: Array.from(document.querySelectorAll('.m-sc-input')).map(s=>s.value), 
                notes: document.getElementById('mNotes').value, 
                season: globalData.settings.currentSeason,
                lineup: lineup,
                type: 'regular'
            });
            ui.renderQueue(); 
            document.getElementById('mOur').value=0; document.getElementById('mTheir').value=0; document.getElementById('mNotes').value=""; app.renderScorers('m');
        },
        
        saveProfileName: () => { const newName = document.getElementById('adminProfileName').value; if(newName) { globalData.settings.profileName = newName; saveToCloud().then(() => { showToast("Global Default updated to " + newName); ui.renderMainView(); }); } },
        openDaySummary: (date) => { document.getElementById('dsDate').value = date; document.getElementById('dsDateDisplay').innerText = fmtDate(date); const sum = globalData.daySummaries[date] || {}; const awContainer = document.getElementById('dsAwardList'); awContainer.innerHTML = ''; const currentAwards = sum.awards || []; const matches = globalData.history.filter(m => m.date === date && m.team === activeContext); matches.forEach(m => { if(m.awards && m.awards.length > 0) m.awards.forEach(a => currentAwards.push(a)); }); const uniqueAwards = currentAwards.filter((a, index, self) => index === self.findIndex((t) => (t.name === a.name && t.player === a.player))); uniqueAwards.forEach(a => window.app.addDayAwardRow(a.name, a.player)); document.getElementById('daySummaryModal').classList.remove('hidden'); },
        addDayAwardRow: (selAward, selPlayer) => { const container = document.getElementById('dsAwardList'); const t = globalData.teams[activeContext]; const div = document.createElement('div'); div.className = 'flex-row'; div.style.marginBottom = '5px'; const s1 = document.createElement('select'); s1.className = 'ds-aw-name flex-grow'; s1.add(new Option("-- Award --", "")); const awardsList = t.awards || []; awardsList.forEach(a => s1.add(new Option(a.name, a.name))); if(selAward && !awardsList.some(a=>a.name===selAward)) s1.add(new Option(selAward, selAward)); if(selAward) s1.value = selAward; const s2 = document.createElement('select'); s2.className = 'ds-aw-player flex-grow'; s2.add(new Option("-- Player --", "")); const playerList = t.players || []; playerList.forEach(p => s2.add(new Option(p, p))); if(selPlayer && !playerList.includes(selPlayer)) s2.add(new Option(selPlayer, selPlayer)); if(selPlayer) s2.value = selPlayer; const btn = document.createElement('button'); btn.className = 'btn-del'; btn.innerHTML = 'âœ•'; btn.onclick = () => div.remove(); div.appendChild(s1); div.appendChild(s2); div.appendChild(btn); container.appendChild(div); },
        saveDaySummary: () => { const date = document.getElementById('dsDate').value; const names = document.querySelectorAll('.ds-aw-name'); const players = document.querySelectorAll('.ds-aw-player'); let awards = []; names.forEach((n, i) => { if(n.value && players[i].value) awards.push({ name: n.value, player: players[i].value }); }); globalData.daySummaries[date] = { awards: awards }; globalData.history.forEach(m => { if(m.date === date && m.team === activeContext) m.awards = []; }); saveToCloud().then(() => { document.getElementById('daySummaryModal').classList.add('hidden'); ui.renderMainView(); }); },
        
        admDel: (k, i) => { const t = document.getElementById('admTeamSelect').value; const item = globalData.teams[t][k][i]; lastDeleted = { type: 'adminItem', key: k, index: i, data: item, team: t }; globalData.teams[t][k].splice(i,1); saveToCloud().then(()=>{ ui.renderAdminDetails(); showToast("Item Deleted"); }); },
        admDelAw: (i) => { const t = document.getElementById('admTeamSelect').value; const item = globalData.teams[t].awards[i]; lastDeleted = { type: 'award', index: i, data: item, team: t }; globalData.teams[t].awards.splice(i,1); saveToCloud().then(()=>{ ui.renderAdminDetails(); showToast("Award Deleted"); }); },
        admDelClub: (name) => { if(Object.keys(globalData.teams).length <= 1) return alert("Cannot delete the last team."); if(name === activeContext) return alert("Cannot delete the active club. Switch to another club first."); if(confirm(`Delete club ${name}? This cannot be undone.`)) { delete globalData.teams[name]; saveToCloud().then(() => { ui.renderAdminDetails(); showToast("Club Deleted"); }); } },
        
        deleteTeam: () => { app.admDelClub(document.getElementById('admTeamSelect').value); },
        deleteMatch: (id) => { if(confirm("Delete this match?")) { const m = globalData.history.find(x => x.id == id); lastDeleted = { type: 'match', data: m }; globalData.history = globalData.history.filter(x => x.id != id); saveToCloud().then(()=>{ ui.renderMainView(); showToast("Match Deleted"); }); } },
        performUndo: () => { if(!lastDeleted) return; const ld = lastDeleted; if(ld.type === 'match') { globalData.history.push(ld.data); } else if (ld.type === 'adminItem') { globalData.teams[ld.team][ld.key].splice(ld.index, 0, ld.data); } else if (ld.type === 'award') { globalData.teams[ld.team].awards.splice(ld.index, 0, ld.data); } saveToCloud().then(() => { ui.renderMainView(); document.getElementById('toast').classList.remove('visible'); lastDeleted = null; showToast("Restored!"); }); },
        
        // --- EDIT LOGIC START ---
        cancelEdit: (type) => {
             if(type === 'player') {
                 editingPlayerIdx = -1;
                 document.getElementById('admNewPlayerFirst').value = ""; document.getElementById('admNewPlayerLast').value = ""; document.getElementById('admNewPlayerNum').value = "";
                 const btn = document.getElementById('btnAddUpdatePlayer'); btn.innerText = "+ Add Player"; btn.classList.remove('btn-update'); btn.classList.add('btn-add');
                 document.getElementById('btnCancelPlayer').classList.add('hidden');
             } else if (type === 'opp') {
                 editingOppIdx = -1;
                 document.getElementById('admNewOpp').value = "";
                 const btn = document.getElementById('btnAddUpdateOpp'); btn.innerText = "Add"; btn.classList.remove('btn-update'); btn.classList.add('btn-add');
                 document.getElementById('btnCancelOpp').classList.add('hidden');
             } else if (type === 'coach') {
                 editingCoachIdx = -1;
                 document.getElementById('admNewCoach').value = "";
                 const btn = document.getElementById('btnAddUpdateCoach'); btn.innerText = "Add"; btn.classList.remove('btn-update'); btn.classList.add('btn-add');
                 document.getElementById('btnCancelCoach').classList.add('hidden');
             } else if (type === 'award') {
                 editingAwardIdx = -1;
                 document.getElementById('newAwardName').value = ""; document.getElementById('newAwardMax').value = "";
                 const btn = document.getElementById('btnAddUpdateAward'); btn.innerText = "Add"; btn.classList.remove('btn-update'); btn.classList.add('btn-save');
                 document.getElementById('btnCancelAward').classList.add('hidden');
             } else if (type === 'tourn') {
                 editingTournIdx = -1;
                 document.getElementById('admNewTourn').value = "";
                 const btn = document.getElementById('btnAddUpdateTourn'); btn.innerText = "Add"; btn.classList.remove('btn-update'); btn.classList.add('btn-add');
                 document.getElementById('btnCancelTourn').classList.add('hidden');
             } else if (type === 'club') {
                 editingClubName = null;
                 document.getElementById('newTeamName').value = ""; document.getElementById('newTeamColor').value = "#333333";
                 const btn = document.getElementById('btnAddUpdateClub'); btn.innerText = "Create"; btn.classList.remove('btn-update'); btn.classList.add('btn-add');
                 document.getElementById('btnCancelClub').classList.add('hidden');
             }
        },

        admEditPlayer: (i) => {
            editingPlayerIdx = i; const t = document.getElementById('admTeamSelect').value; const fullName = globalData.teams[t].players[i];
            let namePart = fullName; let numPart = "";
            if(fullName.includes(" (#")) { const parts = fullName.split(" (#"); namePart = parts[0]; numPart = parts[1].replace(")", ""); }
            const lastSpace = namePart.lastIndexOf(" "); let first = namePart; let last = "";
            if (lastSpace !== -1) { first = namePart.substring(0, lastSpace); last = namePart.substring(lastSpace + 1); } else { first = namePart; }
            document.getElementById('admNewPlayerFirst').value = first; document.getElementById('admNewPlayerLast').value = last; document.getElementById('admNewPlayerNum').value = numPart;
            const btn = document.getElementById('btnAddUpdatePlayer'); btn.innerText = "Update Player"; btn.classList.remove('btn-add'); btn.classList.add('btn-update');
            document.getElementById('btnCancelPlayer').classList.remove('hidden');
        },
        
        adminAddPlayer: () => {
             const t = document.getElementById('admTeamSelect').value;
             const f = document.getElementById('admNewPlayerFirst').value.trim(); const l = document.getElementById('admNewPlayerLast').value.trim(); const n = document.getElementById('admNewPlayerNum').value.trim();
             if (!f || !l) return alert("First Name and Surname are mandatory.");
             let fullName = `${f} ${l}`; if (n) fullName += ` (#${n})`;
             if(!globalData.teams[t].players) globalData.teams[t].players = [];
             
             if (editingPlayerIdx > -1) {
                 const oldName = globalData.teams[t].players[editingPlayerIdx]; globalData.teams[t].players[editingPlayerIdx] = fullName;
                 if (oldName !== fullName) {
                     globalData.history.forEach(m => {
                         if (m.team === t) {
                             if(m.lineup) { const idx = m.lineup.indexOf(oldName); if(idx !== -1) m.lineup[idx] = fullName; }
                             if(m.scorers) { m.scorers = m.scorers.map(s => s === oldName ? fullName : s); }
                             if(m.awards) { m.awards.forEach(a => { if(a.player === oldName) a.player = fullName; }); }
                         }
                     });
                     Object.values(globalData.daySummaries).forEach(ds => { if(ds.awards) ds.awards.forEach(a => { if(a.player === oldName) a.player = fullName; }); });
                 }
                 app.cancelEdit('player');
             } else {
                 if (globalData.teams[t].players.includes(fullName)) return alert("Player already exists.");
                 globalData.teams[t].players.push(fullName);
                 document.getElementById('admNewPlayerFirst').value = ""; document.getElementById('admNewPlayerLast').value = ""; document.getElementById('admNewPlayerNum').value = "";
             }
             saveToCloud().then(() => ui.renderAdminDetails());
        },

        admEditCoach: (i) => {
            editingCoachIdx = i; const t = document.getElementById('admTeamSelect').value;
            document.getElementById('admNewCoach').value = globalData.teams[t].coaches[i];
            const btn = document.getElementById('btnAddUpdateCoach'); btn.innerText = "Update"; btn.classList.remove('btn-add'); btn.classList.add('btn-update');
            document.getElementById('btnCancelCoach').classList.remove('hidden');
        },
        adminAddCoach: () => {
             const t = document.getElementById('admTeamSelect').value; const v = document.getElementById('admNewCoach').value.trim();
             if(!v) return;
             if(!globalData.teams[t].coaches) globalData.teams[t].coaches = [];
             if (editingCoachIdx > -1) { globalData.teams[t].coaches[editingCoachIdx] = v; app.cancelEdit('coach'); } 
             else { globalData.teams[t].coaches.push(v); document.getElementById('admNewCoach').value = ""; }
             saveToCloud().then(() => ui.renderAdminDetails());
        },

        admEditOpp: (i) => {
            editingOppIdx = i; const t = document.getElementById('admTeamSelect').value;
            document.getElementById('admNewOpp').value = globalData.teams[t].opps[i];
            const btn = document.getElementById('btnAddUpdateOpp'); btn.innerText = "Update"; btn.classList.remove('btn-add'); btn.classList.add('btn-update');
            document.getElementById('btnCancelOpp').classList.remove('hidden');
        },
        adminAddOpp: () => {
             const t = document.getElementById('admTeamSelect').value; const v = document.getElementById('admNewOpp').value.trim();
             if(!v) return;
             if(!globalData.teams[t].opps) globalData.teams[t].opps = [];
             if (editingOppIdx > -1) { globalData.teams[t].opps[editingOppIdx] = v; app.cancelEdit('opp'); } 
             else { globalData.teams[t].opps.push(v); document.getElementById('admNewOpp').value = ""; }
             saveToCloud().then(() => ui.renderAdminDetails());
        },

        admEditAward: (i) => {
            editingAwardIdx = i; const t = document.getElementById('admTeamSelect').value; const aw = globalData.teams[t].awards[i];
            document.getElementById('newAwardName').value = aw.name; document.getElementById('newAwardMax').value = aw.max;
            const btn = document.getElementById('btnAddUpdateAward'); btn.innerText = "Update"; btn.classList.remove('btn-save'); btn.classList.add('btn-update');
            document.getElementById('btnCancelAward').classList.remove('hidden');
        },
        adminAddAward: () => {
             const t = document.getElementById('admTeamSelect').value; const n = document.getElementById('newAwardName').value.trim(); const m = parseInt(document.getElementById('newAwardMax').value) || 1;
             if(!n) return;
             if(!globalData.teams[t].awards) globalData.teams[t].awards = [];
             if (editingAwardIdx > -1) { globalData.teams[t].awards[editingAwardIdx] = {name:n, max:m}; app.cancelEdit('award'); } 
             else { globalData.teams[t].awards.push({name:n, max:m}); document.getElementById('newAwardName').value = ""; document.getElementById('newAwardMax').value = ""; }
             saveToCloud().then(() => ui.renderAdminDetails());
        },

        admEditClub: (name) => {
            editingClubName = name;
            document.getElementById('newTeamName').value = name; document.getElementById('newTeamColor').value = globalData.teams[name].color;
            const btn = document.getElementById('btnAddUpdateClub'); btn.innerText = "Update Club"; btn.classList.remove('btn-add'); btn.classList.add('btn-update');
            document.getElementById('btnCancelClub').classList.remove('hidden'); window.scrollTo(0, document.body.scrollHeight);
        },
        adminAddClub: () => {
            const n = document.getElementById('newTeamName').value.trim(); const c = document.getElementById('newTeamColor').value;
            if(!n) return;
            if (editingClubName) {
                const oldName = editingClubName;
                if (n !== oldName) {
                     if(globalData.teams[n]) return alert("Club Name already exists!");
                     globalData.teams[n] = globalData.teams[oldName]; globalData.teams[n].color = c; delete globalData.teams[oldName];
                     globalData.history.forEach(m => { if(m.team === oldName) m.team = n; });
                     if (activeContext === oldName) activeContext = n;
                } else { globalData.teams[n].color = c; }
                app.cancelEdit('club'); saveToCloud().then(() => { ui.renderNav(); ui.renderAdminDetails(); });
            } else {
                if(globalData.teams[n]) return alert("Club already exists.");
                globalData.teams[n]={color:c, players:["Joey"], opps:[], coaches:[], awards:[], tournaments:[], active:true};
                document.getElementById('newTeamName').value = ""; saveToCloud().then(() => { ui.renderNav(); ui.renderAdminDetails(); });
            }
        },
        
        // --- NEW TOURNAMENT CONFIG LOGIC V136 ---
        openTournConfigModal: (idx) => {
            const tName = activeContext === 'Admin' ? document.getElementById('admTeamSelect').value : activeContext;
            if (!tName || !globalData.teams[tName]) return;
            
            document.getElementById('tcIndex').value = idx;
            document.getElementById('tcDate').value = new Date().toISOString().split('T')[0];
            
            const luArea = document.getElementById('tcSquadArea');
            luArea.innerHTML = '';
            (globalData.teams[tName].players || []).forEach(p => {
                const div = document.createElement('div'); div.className='lineup-item';
                div.innerHTML = `<input type="checkbox" class="tc-lineup-chk" value="${p}" checked> ${p}`;
                luArea.appendChild(div);
            });

            if (idx > -1) {
                document.getElementById('tcTitle').innerText = "Edit Tournament";
                const tourn = globalData.teams[tName].tournaments[idx];
                document.getElementById('tcName').value = tourn.name;
                if(tourn.date) document.getElementById('tcDate').value = tourn.date;
                if(tourn.teams) document.getElementById('tcTeams').value = tourn.teams.join(', ');
                
                if(tourn.squad) {
                    document.querySelectorAll('.tc-lineup-chk').forEach(c => {
                        c.checked = tourn.squad.includes(c.value);
                    });
                }
            } else {
                document.getElementById('tcTitle').innerText = "Tournament Setup";
                document.getElementById('tcName').value = "";
                document.getElementById('tcTeams').value = "";
            }
            document.getElementById('tournConfigModal').classList.remove('hidden');
        },
        
        tcSelectAllSquad: () => {
            document.querySelectorAll('.tc-lineup-chk').forEach(c => c.checked = true);
        },
        
        saveTournConfig: () => {
            const tName = activeContext === 'Admin' ? document.getElementById('admTeamSelect').value : activeContext;
            if (!tName || !globalData.teams[tName]) return;
            
            const idx = parseInt(document.getElementById('tcIndex').value);
            const n = document.getElementById('tcName').value.trim();
            const d = document.getElementById('tcDate').value;
            const teamsRaw = document.getElementById('tcTeams').value;
            
            if(!n) return alert("Please enter a tournament name.");
            
            let parsedTeams = teamsRaw.split(',').map(s=>s.trim()).filter(s=>s!=="");
            
            const squad = [];
            document.querySelectorAll('.tc-lineup-chk:checked').forEach(c => squad.push(c.value));
            
            if(!globalData.teams[tName].tournaments) globalData.teams[tName].tournaments = [];
            
            if (idx > -1) {
                const oldName = globalData.teams[tName].tournaments[idx].name;
                globalData.teams[tName].tournaments[idx] = { ...globalData.teams[tName].tournaments[idx], name: n, date: d, teams: parsedTeams, squad: squad };
                if (oldName !== n) {
                     globalData.history.forEach(m => { if (m.team === tName && m.tourn === oldName) m.tourn = n; });
                }
            } else {
                if (globalData.teams[tName].tournaments.some(tr => tr.name === n)) return alert("Tournament name already exists.");
                globalData.teams[tName].tournaments.push({name: n, date: d, teams: parsedTeams, squad: squad, active: true, winner: ""});
            }
            
            saveToCloud().then(() => {
                document.getElementById('tournConfigModal').classList.add('hidden');
                if(activeContext === 'Admin') ui.renderAdminDetails();
                else ui.renderMainView();
                showToast("Tournament Saved");
            });
        },
        
        admDelTourn: (i) => {
             const t = document.getElementById('admTeamSelect').value;
             if(confirm("Delete this tournament? This will NOT delete the matches, just the configuration.")) {
                 globalData.teams[t].tournaments.splice(i,1);
                 saveToCloud().then(() => { ui.renderAdminDetails(); showToast("Tournament Deleted"); });
             }
        },

        saveTournWinner: () => { const tName = activeContext, trName = document.getElementById('tournSelector').value, win = document.getElementById('tournWinnerInput').value, idx = globalData.teams[tName].tournaments.findIndex(t=>t.name===trName); if(idx !== -1) { globalData.teams[tName].tournaments[idx].winner = win; saveToCloud().then(()=>showToast("Saved")); } },
        openEditActiveTourn: () => { 
            ui.switchContext('Admin'); 
            setTimeout(() => {
                window.scrollTo(0, document.body.scrollHeight / 1.5);
                showToast("Scroll to Tournaments to edit.");
            }, 300);
        },
        
        saveTournMatch: () => {
            const tName = activeContext;
            const tournName = document.getElementById('tournSelector').value;
            if(!tournName) return;
            const type = document.querySelector('input[name="tmType"]:checked').value;
            const tournData = globalData.teams[tName].tournaments.find(t=>t.name === tournName);
            const tDate = tournData && tournData.date ? tournData.date : new Date().toISOString().split('T')[0];

            let matchObj = { id: Date.now()+Math.random(), tourn: tournName, season: globalData.settings.currentSeason };

            if(type === 'us') {
                const opp = document.getElementById('tmOpp').value;
                if(!opp) return alert("Select Opponent");
                const lineup = [];
                document.querySelectorAll('.tm-lineup-chk:checked').forEach(c => lineup.push(c.value));
                
                matchObj = {
                    ...matchObj,
                    team: tName,
                    opp: opp,
                    date: tDate,
                    our: parseInt(document.getElementById('tmOur').value)||0,
                    their: parseInt(document.getElementById('tmTheir').value)||0,
                    coach: document.getElementById('tmCoach').value,
                    scorers: Array.from(document.querySelectorAll('.tm-sc-input')).map(s=>s.value),
                    lineup: lineup,
                    type: 'regular'
                };
            } else {
                const tA = document.getElementById('tmTeamA').value;
                const tB = document.getElementById('tmTeamB').value;
                if(!tA || !tB || tA === tB) return alert("Select two different valid teams.");
                
                matchObj = {
                    ...matchObj,
                    team: tName, 
                    date: tDate,
                    teamA: tA,
                    teamB: tB,
                    scoreA: parseInt(document.getElementById('tmScoreA').value)||0,
                    scoreB: parseInt(document.getElementById('tmScoreB').value)||0,
                    type: 'neutral'
                };
            }
            
            globalData.history.push(matchObj);
            saveToCloud().then(() => {
                ui.renderTournamentView();
                document.getElementById('tmOur').value = 0; document.getElementById('tmTheir').value = 0;
                document.getElementById('tmScoreA').value = 0; document.getElementById('tmScoreB').value = 0;
                app.renderScorers('tm');
                showToast("Tournament Match Saved");
            });
        },

        saveEditedMatch: () => { 
            const id=document.getElementById('editId').value, i=globalData.history.findIndex(x=>x.id==id); if(i===-1)return; 
            const lineup = []; document.querySelectorAll('.e-lineup-chk:checked').forEach(c => lineup.push(c.value));
            
            globalData.history[i]={ ...globalData.history[i], date:document.getElementById('eDate').value, opp:document.getElementById('eOpp').value, tourn:document.getElementById('eTourn').value, coach:document.getElementById('eCoach').value, our:parseInt(document.getElementById('eOur').value)||0, their:parseInt(document.getElementById('eTheir').value)||0, scorers:Array.from(document.querySelectorAll('.e-sc-input')).map(s=>s.value), notes:document.getElementById('eNotes').value, lineup: lineup }; 
            saveToCloud().then(()=>{document.getElementById('editModal').classList.add('hidden'); ui.renderMainView(); showToast("Updated");}); 
        },

        renderScorers: (p) => { 
            const c = parseInt(document.getElementById(p + 'Our').value) || 0; 
            const d = document.getElementById(p + 'ScorerList'); 
            d.innerHTML = c > 0 ? '<label>Goal Scorers:</label>' : ''; 
            const checkedBoxes = document.querySelectorAll(`.${p}-lineup-chk:checked`);
            const availablePlayers = Array.from(checkedBoxes).map(cb => cb.value);

            for(let i=0; i<c; i++) { 
                const s = document.createElement('select'); 
                s.className = p + '-sc-input'; s.style.marginBottom='5px'; 
                availablePlayers.forEach(x => s.add(new Option(x,x))); 
                s.add(new Option("---", ""));
                s.add(new Option("O.G. (Own Goal)", "O.G."));
                d.appendChild(s); 
            } 
        }
    });

    // --- UI LOGIC ---
    Object.assign(window.ui, {
        renderNav: () => {
            document.getElementById('headerSeasonBadge').innerText = globalData.settings.currentSeason;
            const firstName = (localProfileName || "Player").split(' ')[0];
            document.getElementById('clubsSticker').innerText = firstName + "'s Stats";
            
            const r1 = document.getElementById('navRowTeams'); r1.innerHTML='';
            const cBtn = document.createElement('div'); cBtn.className = `nav-btn career-pill ${activeContext==='Career'?'active':''}`; cBtn.innerText = 'Career'; cBtn.onclick = () => ui.switchContext('Career'); r1.appendChild(cBtn);
            const div = document.createElement('div'); div.className = 'nav-divider'; r1.appendChild(div);
            Object.keys(globalData.teams).forEach(t => { const b = document.createElement('div'); b.className = `nav-btn ${activeContext===t?'active':''}`; b.innerText = t; b.onclick=()=>{ui.switchContext(t);}; r1.appendChild(b); });
        },

        switchContext: (c) => { 
            if (globalData.teams[c]) lastActiveTeam = c;
            activeContext = c; 
            const root = document.documentElement;
            if(c === 'Career') { root.style.setProperty('--primary', '#333333'); root.style.setProperty('--primary-tint', '#f0f0f0'); root.style.setProperty('--text-on-primary', '#ffffff'); root.style.setProperty('--accent', '#DAA520'); } 
            else if (c === 'Admin') { root.style.setProperty('--primary', '#333'); root.style.setProperty('--primary-tint', '#e4e4e7'); root.style.setProperty('--text-on-primary', '#fff'); root.style.setProperty('--accent', '#666'); } 
            else if(globalData.teams[c]) { const color = globalData.teams[c].color; root.style.setProperty('--primary', color); root.style.setProperty('--primary-tint', hexToRgb(color)); root.style.setProperty('--text-on-primary', '#fff'); root.style.setProperty('--accent', color); }
            ui.renderNav(); ui.renderMainView(); 
        },

        renderMainView: () => {
            window.scrollTo(0, 0); 
            ['viewMatchDay','viewCareer','viewAdmin'].forEach(id=>document.getElementById(id).classList.add('hidden'));
            
            if(activeContext === 'Career') { 
                document.getElementById('viewCareer').classList.remove('hidden');
                const cs = document.getElementById('careerSeasonFilter'); const currentVal = cs.value; cs.innerHTML = '<option value="All Time">All Time</option>';
                globalData.settings.seasons.forEach(s => { cs.add(new Option(s, s)); }); cs.value = currentVal; 
                ui.renderCareer(); 
            } 
            else if(activeContext === 'Admin') { 
                document.getElementById('viewAdmin').classList.remove('hidden'); 
                const sel = document.getElementById('admTeamSelect');
                if(sel.options.length === 0) {
                     Object.keys(globalData.teams).forEach(t=>sel.add(new Option(t,t)));
                     if(lastActiveTeam && globalData.teams[lastActiveTeam]) sel.value = lastActiveTeam;
                }
                const sSel = document.getElementById('admActiveSeason'); sSel.innerHTML=''; globalData.settings.seasons.forEach(s=>sSel.add(new Option(s,s))); sSel.value = globalData.settings.currentSeason; ui.renderAdminDetails(); 
            } 
            else { 
                document.getElementById('viewMatchDay').classList.remove('hidden'); 
                const isInSquad = globalData.teams[activeContext].players.includes(localProfileName);
                document.getElementById('teamStatTitle').innerText = activeContext + (isInSquad ? " Overview" : " (Not in Squad)");
                ui.renderMatchDayInputs(); ui.renderTeamStats(); ui.renderLeagueTable(); ui.renderTopScorers(); 
                ui.renderHistory(globalData.history.filter(m=>m.team===activeContext && m.season===globalData.settings.currentSeason)); 
                const sel = document.getElementById('tournSelector'); sel.innerHTML = '<option value="">-- Select --</option>'; 
                if(globalData.teams[activeContext].tournaments) { globalData.teams[activeContext].tournaments.forEach(tr => { if(tr.active) sel.add(new Option(tr.name, tr.name)); }); }
                document.getElementById('tournStatsArea').classList.add('hidden');
            }
        },

        renderMatchDayInputs: () => { 
            const t = globalData.teams[activeContext]; 
            const fill = (id, arr) => {const el=document.getElementById(id); el.innerHTML=""; arr.forEach(x=>el.add(new Option(x,x)))}; 
            fill('mOpp', t.opps || []); fill('mCoach', t.coaches || []); 
            const te = document.getElementById('mTourn'); te.innerHTML='<option value="League">League</option>'; 
            if(t.tournaments) t.tournaments.forEach(tr => { if(tr.active) te.add(new Option("ğŸ† " + tr.name, tr.name)); }); 
            document.getElementById('mDate').value = new Date().toISOString().split('T')[0];
            
            const luArea = document.getElementById('mLineupArea');
            luArea.innerHTML = '';
            (t.players || []).forEach(p => {
                const div = document.createElement('div'); div.className='lineup-item';
                div.innerHTML = `<input type="checkbox" class="m-lineup-chk" value="${p}" checked onchange="app.renderScorers('m')"> ${p}`;
                luArea.appendChild(div);
            });
            app.renderScorers('m'); 
        },

        toggleTournInput: () => {
             const type = document.querySelector('input[name="tmType"]:checked').value;
             if (type === 'us') {
                 document.getElementById('tmUsInput').classList.remove('hidden');
                 document.getElementById('tmOtherInput').classList.add('hidden');
             } else {
                 document.getElementById('tmUsInput').classList.add('hidden');
                 document.getElementById('tmOtherInput').classList.remove('hidden');
             }
        },

        renderHistory: (data, targetId) => { 
            const list = document.getElementById(targetId || 'teamHistoryList'); 
            if(!data || !data.length) { list.innerHTML = '<div style="text-align:center;padding:20px;color:var(--text-muted);">No matches yet</div>'; return; }
            
            data.sort((a,b) => b.id - a.id); 
            let html = ''; let currentDay = null;
            
            data.forEach((m) => {
                const day = fmtDate(m.date);
                if(day !== currentDay) {
                    if(currentDay !== null) html += '</div>'; 
                    currentDay = day;
                    html += `<div class="history-group"><div class="group-header"><div class="gh-top"><span class="gh-date">ğŸ“… ${day}</span><button class="btn-sm protected-area" onclick="window.app.openDaySummary('${m.date}')">Edit Awards</button></div>`;
                    
                    const sum = globalData.daySummaries[m.date] || {};
                    let awardsHtml = '';
                    if(sum.awards && sum.awards.length > 0) { 
                        sum.awards.forEach(a => { awardsHtml += `<span class="aw-tag">ğŸ… ${a.name}: ${a.player}</span>`; }); 
                    }
                    const legacyAwards = data.filter(mx => mx.date === m.date && mx.awards && mx.awards.length > 0);
                    if(legacyAwards.length > 0 && (!sum.awards || sum.awards.length === 0)) { 
                        legacyAwards.forEach(mx => mx.awards.forEach(a => { awardsHtml += `<span class="aw-tag">ğŸ… ${a.name}: ${a.player}</span>`; })); 
                    }
                    if(awardsHtml) { html += `<div class="gh-awards">${awardsHtml}</div>`; }
                    html += `</div>`; 
                }

                if (m.type === 'neutral') {
                    html += `
                    <div class="match-row" style="background:var(--primary-tint); opacity:0.9;">
                        <div class="match-info">
                            <strong>${m.teamA} vs ${m.teamB}</strong> <span style="font-size:0.8em">${m.tourn}</span>
                        </div>
                        <div class="match-actions">
                            <div class="result-badge res-d" style="background:rgba(0,0,0,0.1); color:var(--text);">${m.scoreA}-${m.scoreB}</div>
                            <button class="btn-del protected-area" onclick="app.deleteMatch('${m.id}')" style="margin-top:5px;">ğŸ—‘</button>
                        </div>
                    </div>`;
                } else {
                    const coachHtml = m.coach ? `<div class="dt-label">Manager</div><div class="dt-val">${m.coach}</div>` : '';
                    const scorers = m.scorers || [];
                    const goalsHtml = scorers.length ? `<div class="dt-label">Goals</div><div class="dt-val">${scorers.join(', ')}</div>` : '';
                    const notes = m.notes ? 'ğŸ—’ï¸ ' : '';
                    const resClass = m.our > m.their ? 'res-w' : (m.our < m.their ? 'res-l' : 'res-d');

                    html += `
                    <div class="match-row">
                        <div class="match-info">
                            ${notes}<strong>vs ${m.opp}</strong> <span style="font-size:0.8em">${m.tourn}</span>
                            <div class="detail-grid">${coachHtml}${goalsHtml}</div>
                        </div>
                        <div class="match-actions">
                            <div class="result-badge ${resClass}">${m.our}-${m.their}</div>
                            <div class="protected-area flex-row" style="gap:5px; margin-top:5px;">
                                <button class="btn-edit" onclick="ui.openEditModal('${m.id}')">âœ</button>
                                <button class="btn-del" onclick="app.deleteMatch('${m.id}')">ğŸ—‘</button>
                            </div>
                        </div>
                    </div>`;
                }
            });
            html += '</div>'; 
            list.innerHTML = html;
            
            if(!ALLOWED_UIDS.includes(currentUser?.uid) || isGuest) {
                document.querySelectorAll('.protected-area').forEach(el=>el.classList.add('hidden')); 
            }
        },

        renderTopScorers: () => { 
            const matches = globalData.history.filter(m => m.team === activeContext && m.season === globalData.settings.currentSeason && (!m.type || m.type === 'regular')); 
            const counts = {}; 
            matches.forEach(m => (m.scorers || []).forEach(p => counts[p] = (counts[p] || 0) + 1)); 
            const sorted = Object.entries(counts).filter(([name, count]) => name !== 'O.G.').sort((a,b) => b[1] - a[1]); 
            const tbl = document.querySelector('#topScorerTable tbody'); 
            tbl.innerHTML = sorted.length ? sorted.map(s => `<tr><td>${s[0]}</td><td class="num-col">${s[1]}</td></tr>`).join('') : '<tr><td colspan="2" style="text-align:center">No goals yet</td></tr>'; 
        },

        renderLeagueTable: () => { 
            const matches = globalData.history.filter(m => m.team === activeContext && m.season === globalData.settings.currentSeason && (!m.type || m.type === 'regular')); 
            let my = { p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0 }; 
            matches.forEach(m => { 
                my.p++; my.gf += m.our; my.ga += m.their; 
                if(m.our > m.their) { my.w++; my.pts+=3; } else if(m.our < m.their) { my.l++; my.pts+=0; } else { my.d++; my.pts+=1; } 
            }); 
            let opp = { p: my.p, w: my.l, d: my.d, l: my.w, gf: my.ga, ga: my.gf, pts: (my.l * 3) + (my.d * 1) }; 
            let data = [{ name: activeContext, ...my, isMe: true }, { name: "Opponents", ...opp, isMe: false }]; 
            data.sort((a, b) => (b.pts - a.pts) || ((b.gf - b.ga) - (a.gf - a.ga))); 
            document.querySelector('#teamLeagueTable tbody').innerHTML = data.map((d, i) => `<tr class="${d.isMe?'is-me':''}"><td class="t-left">${i+1}. ${d.name}</td><td>${d.p}</td><td>${d.w}</td><td>${d.d}</td><td>${d.l}</td><td>${d.gf-d.ga}</td><td><b>${d.pts}</b></td></tr>`).join(''); 
        },
        
        renderTeamStats: () => { 
            const profile = localProfileName;
            const t = globalData.teams[activeContext];
            if (!t.players.includes(profile)) {
                document.getElementById('st-p').innerText = 0; document.getElementById('st-w').innerText = 0; document.getElementById('st-g').innerText = 0; document.getElementById('st-a').innerText = "N/A"; return;
            }
            const h = globalData.history.filter(m => m.team === activeContext && m.season === globalData.settings.currentSeason && (!m.type || m.type === 'regular')); 
            const playerMatches = h.filter(m => { if (m.lineup) return m.lineup.includes(profile); return true; });
            const uniqueDates = [...new Set(playerMatches.map(m => m.date))]; 
            const maxAwards = uniqueDates.length; 
            let awardCount = 0; 
            uniqueDates.forEach(d => { 
                const sum = globalData.daySummaries[d]; 
                if(sum && sum.awards && sum.awards.length > 0) { 
                    awardCount += sum.awards.filter(a => a.player === profile).length; 
                } else { 
                    const matchesOnDay = playerMatches.filter(m => m.date === d); 
                    let legacyAwardsOnDay = 0; 
                    matchesOnDay.forEach(m => { if (m.awards) legacyAwardsOnDay += m.awards.filter(a => a.player === profile).length; }); 
                    awardCount += legacyAwardsOnDay; 
                } 
            }); 
            document.getElementById('st-p').innerText = playerMatches.length; 
            document.getElementById('st-w').innerText = playerMatches.filter(m=>m.our>m.their).length; 
            document.getElementById('st-g').innerText = playerMatches.reduce((a,m)=>(a+(m.scorers||[]).filter(s=>s===profile).length),0); 
            if (awardCount === 0) { document.getElementById('st-a').innerText = "N/A"; } else { document.getElementById('st-a').innerText = `${awardCount} / ${maxAwards}`; } 
        },
        
        renderCareer: () => { 
            const f = document.getElementById('careerSeasonFilter').value; 
            const profile = localProfileName; 
            let totalGames = 0, totalWins = 0, totalGoals = 0;
            let totalAwardWins = 0, totalAwardOpps = 0;
            Object.keys(globalData.teams).forEach(teamName => {
                if (!globalData.teams[teamName].players.includes(profile)) return;
                let teamHistory = globalData.history.filter(m => m.team === teamName && (!m.type || m.type === 'regular'));
                if(f !== 'All Time') teamHistory = teamHistory.filter(m => m.season === f);
                const playerMatches = teamHistory.filter(m => { if (m.lineup) return m.lineup.includes(profile); return true; });
                totalGames += playerMatches.length;
                totalWins += playerMatches.filter(m => m.our > m.their).length;
                totalGoals += playerMatches.reduce((acc, m) => acc + (m.scorers||[]).filter(s => s === profile).length, 0);
                const teamUniqueDates = [...new Set(playerMatches.map(m => m.date))];
                let teamAwards = 0;
                teamUniqueDates.forEach(d => {
                    const sum = globalData.daySummaries[d];
                    if(sum && sum.awards && sum.awards.length > 0) {
                        teamAwards += sum.awards.filter(a => a.player === profile).length;
                    } else {
                        const matchesOnDay = playerMatches.filter(m => m.date === d);
                        matchesOnDay.forEach(m => { if (m.awards) teamAwards += m.awards.filter(a => a.player === profile).length; });
                    }
                });
                if (teamAwards > 0) { totalAwardWins += teamAwards; totalAwardOpps += teamUniqueDates.length; }
            });
            document.getElementById('c-p').innerText = totalGames;
            document.getElementById('c-w').innerText = totalWins;
            document.getElementById('c-g').innerText = totalGoals;
            document.getElementById('c-a').innerText = totalAwardWins === 0 ? "N/A" : `${totalAwardWins} / ${totalAwardOpps}`;
            
            let h = globalData.history.filter(m => (!m.type || m.type === 'regular')); 
            if(f !== 'All Time') h = h.filter(m => m.season === f); 
            let stats={}; 
            h.forEach(m=>{
                const u=(n,gf,ga)=>{
                    if(!stats[n]) stats[n]={name:n,p:0,w:0,d:0,l:0,gf:0,ga:0,pts:0};
                    const st=stats[n]; st.p++; st.gf+=gf; st.ga+=ga;
                    if(gf>ga){st.w++; st.pts+=3;} else if(gf<ga){st.l++; st.pts+=0;} else{st.d++; st.pts+=1;}
                };
                u(m.team,m.our,m.their);
            }); 
            const d = Object.values(stats).filter(t => globalData.teams[t.name] !== undefined).sort((a,b)=>b.pts-a.pts); 
            document.querySelector('#masterTable tbody').innerHTML=d.map((t,i)=>{ 
                const color = globalData.teams[t.name].color; 
                return `<tr class="is-me"><td class="t-left" style="color:${color}">${i+1}. ${t.name}</td><td>${t.p}</td><td>${t.w}</td><td>${t.d}</td><td>${t.l}</td><td>${t.gf-t.ga}</td><td>${t.gf}</td><td><b>${t.pts}</b></td></tr>`; 
            }).join(''); 
        },
        
        renderTournamentView: () => { 
            const tName = activeContext; 
            const sel = document.getElementById('tournSelector'); 
            if(!sel.value) { document.getElementById('tournStatsArea').classList.add('hidden'); return; } 
            
            document.getElementById('tournStatsArea').classList.remove('hidden'); 
            const h = globalData.history.filter(m => m.tourn === sel.value && m.team === tName && m.season === globalData.settings.currentSeason); 
            const ourMatches = h.filter(m => !m.type || m.type === 'regular');
            
            const profile = localProfileName; 
            
            document.getElementById('tr-p').innerText = ourMatches.length; 
            document.getElementById('tr-w').innerText = ourMatches.filter(m => m.our > m.their).length; 
            document.getElementById('tr-g').innerText = ourMatches.reduce((a,m)=>(a+(m.scorers||[]).filter(s=>s===profile).length),0); 
            document.getElementById('tr-a').innerText = ourMatches.reduce((a,m)=>(a+(m.awards||[]).filter(x=>x.player===profile).length),0); 
            
            const tournData = globalData.teams[tName].tournaments.find(t=>t.name===sel.value);
            document.getElementById('tournWinnerInput').value = tournData && tournData.winner ? tournData.winner : "";

            ui.renderHistory(h, 'tournHistoryList'); 

            // BUILD MATCH INPUT DROPDOWNS & CHECKBOXES FOR THIS TOURNAMENT
            const oppList = tournData && tournData.teams && tournData.teams.length > 0 ? tournData.teams : (globalData.teams[tName].opps || []);
            const sqList = tournData && tournData.squad && tournData.squad.length > 0 ? tournData.squad : (globalData.teams[tName].players || []);
            const cList = globalData.teams[tName].coaches || [];

            const fill = (id, arr) => {const el=document.getElementById(id); el.innerHTML=""; arr.forEach(x=>el.add(new Option(x,x)))}; 
            fill('tmOpp', oppList); fill('tmCoach', cList); 
            fill('tmTeamA', oppList); fill('tmTeamB', oppList);
            
            const luArea = document.getElementById('tmLineupArea');
            luArea.innerHTML = '';
            sqList.forEach(p => {
                const div = document.createElement('div'); div.className='lineup-item';
                div.innerHTML = `<input type="checkbox" class="tm-lineup-chk" value="${p}" checked onchange="app.renderScorers('tm')"> ${p}`;
                luArea.appendChild(div);
            });
            app.renderScorers('tm');

            // RENDER TOURNAMENT LEAGUE TABLE
            let tableData = {};
            tableData[tName] = { name: tName, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, isMe: true };
            
            if(tournData && tournData.teams) {
                tournData.teams.forEach(t => {
                    if(!tableData[t]) tableData[t] = { name: t, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, isMe: false };
                });
            }
            
            h.forEach(m => {
                if (m.type === 'neutral') {
                    let tA = tableData[m.teamA]; let tB = tableData[m.teamB];
                    if(!tA) { tA = { name: m.teamA, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, isMe: false }; tableData[m.teamA] = tA; }
                    if(!tB) { tB = { name: m.teamB, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, isMe: false }; tableData[m.teamB] = tB; }
                    
                    tA.p++; tB.p++;
                    tA.gf += m.scoreA; tA.ga += m.scoreB;
                    tB.gf += m.scoreB; tB.ga += m.scoreA;
                    
                    if(m.scoreA > m.scoreB) { tA.w++; tA.pts+=3; tB.l++; }
                    else if(m.scoreA < m.scoreB) { tB.w++; tB.pts+=3; tA.l++; }
                    else { tA.d++; tB.d++; tA.pts+=1; tB.pts+=1; }
                } else {
                    let me = tableData[tName]; let op = tableData[m.opp];
                    if(!op) { op = { name: m.opp, p:0, w:0, d:0, l:0, gf:0, ga:0, pts:0, isMe: false }; tableData[m.opp] = op; }
                    
                    me.p++; op.p++;
                    me.gf += m.our; me.ga += m.their;
                    op.gf += m.their; op.ga += m.our;
                    
                    if(m.our > m.their) { me.w++; me.pts+=3; op.l++; }
                    else if(m.our < m.their) { me.l++; op.w++; op.pts+=3; }
                    else { me.d++; op.d++; me.pts+=1; op.pts+=1; }
                }
            });
            
            let rows = Object.values(tableData).sort((a,b) => (b.pts - a.pts) || ((b.gf-b.ga) - (a.gf-a.ga)));
            document.querySelector('#tournLeagueTable tbody').innerHTML = rows.map((d, i) => `<tr class="${d.isMe?'is-me':''}"><td class="t-left">${i+1}. ${d.name}</td><td>${d.p}</td><td>${d.w}</td><td>${d.d}</td><td>${d.l}</td><td>${d.gf-d.ga}</td><td><b>${d.pts}</b></td></tr>`).join('');
        },
        
        openEditModal: (id) => { 
            const m = globalData.history.find(x => x.id == id); 
            if(m.type === 'neutral') { alert("Neutral matches cannot be edited yet. Please delete and re-enter if a mistake was made."); return; }
            
            document.getElementById('editId').value = id; 
            document.getElementById('eDate').value = m.date; 
            document.getElementById('eOur').value = m.our; 
            document.getElementById('eTheir').value = m.their; 
            document.getElementById('eNotes').value = m.notes || ""; 
            const t = globalData.teams[m.team]; 
            const fill = (eid, arr, val) => { const el = document.getElementById(eid); el.innerHTML = ""; arr.forEach(x => el.add(new Option(x,x))); el.value = val || ""; }; 
            fill('eOpp', t.opps, m.opp); fill('eCoach', t.coaches || [], m.coach); 
            const te = document.getElementById('eTourn'); te.innerHTML='<option value="League">League</option>'; 
            if(t.tournaments) t.tournaments.forEach(tr => te.add(new Option("ğŸ† "+tr.name, tr.name))); te.value = m.tourn; 
            
            const luArea = document.getElementById('eLineupArea');
            luArea.innerHTML = '';
            (t.players || []).forEach(p => {
                const div = document.createElement('div'); div.className='lineup-item';
                const isChecked = m.lineup ? m.lineup.includes(p) : true;
                div.innerHTML = `<input type="checkbox" class="e-lineup-chk" value="${p}" ${isChecked?'checked':''} onchange="app.renderScorers('e')"> ${p}`;
                luArea.appendChild(div);
            });

            app.renderScorers('e'); 
            
            if (m.scorers) {
                 const selects = document.querySelectorAll('.e-sc-input');
                 m.scorers.forEach((s, idx) => { if (selects[idx]) selects[idx].value = s; });
            }

            document.getElementById('editModal').classList.remove('hidden'); 
        },
        
        renderAdminDetails: () => { 
            const selectEl = document.getElementById('admTeamSelect');
            if(selectEl.options.length === 0) {
                 Object.keys(globalData.teams).forEach(t=>selectEl.add(new Option(t,t)));
                 if(lastActiveTeam && globalData.teams[lastActiveTeam]) selectEl.value = lastActiveTeam;
            } else {
                 if(lastActiveTeam && globalData.teams[lastActiveTeam]) selectEl.value = lastActiveTeam;
            }
            const t=globalData.teams[selectEl.value]; 
            if(!t) return; 
            
            document.getElementById('admPlayerList').innerHTML=(t.players||[]).map((x,i)=>`<li>${x} <div><button class="btn-edit" onclick="app.admEditPlayer(${i})">âœ</button> <button class="btn-del" onclick="app.admDel('players',${i})">ğŸ—‘</button></div></li>`).join('');
            document.getElementById('admCoachList').innerHTML=(t.coaches||[]).map((x,i)=>`<li>${x} <div><button class="btn-edit" onclick="app.admEditCoach(${i})">âœ</button> <button class="btn-del" onclick="app.admDel('coaches',${i})">ğŸ—‘</button></div></li>`).join('');
            document.getElementById('admOppList').innerHTML=(t.opps||[]).map((x,i)=>`<li>${x} <div><button class="btn-edit" onclick="app.admEditOpp(${i})">âœ</button> <button class="btn-del" onclick="app.admDel('opps',${i})">ğŸ—‘</button></div></li>`).join('');
            
            // TOURNAMENTS LIST
            document.getElementById('admTournList').innerHTML = (t.tournaments||[]).map((tr,i)=>`<li>${tr.name} <div><button class="btn-edit" onclick="app.openTournConfigModal(${i})">âœ</button> <button class="btn-del" onclick="app.admDelTourn(${i})">ğŸ—‘</button></div></li>`).join('');
            
            document.getElementById('admAwardList').innerHTML = (t.awards||[]).map((a,i)=>`<li>${a.name} (Max: ${a.max}) <div><button class="btn-edit" onclick="app.admEditAward(${i})">âœ</button> <button class="btn-del" onclick="app.admDelAw(${i})">ğŸ—‘</button></div></li>`).join('');
            
            const profSel = document.getElementById('adminProfileName'); 
            profSel.innerHTML = '';
            let playerMap = {};
            Object.keys(globalData.teams).forEach(teamName => {
                const team = globalData.teams[teamName];
                if (team.players) {
                    team.players.forEach(p => {
                        if (!playerMap[p]) playerMap[p] = [];
                        playerMap[p].push(teamName);
                    });
                }
            });
            const sortedNames = Object.keys(playerMap).sort();
            sortedNames.forEach(p => {
                const teamList = playerMap[p].join(', ');
                const label = `${p} (${teamList})`;
                profSel.add(new Option(label, p));
            });
            if(globalData.settings.profileName) profSel.value = globalData.settings.profileName;
            
            const clubList = document.getElementById('admClubList'); 
            clubList.innerHTML = Object.keys(globalData.teams).map(teamName => { 
                const isCurrent = teamName === activeContext; 
                const color = globalData.teams[teamName].color;
                const editBtn = `<button class="btn-edit" onclick="app.admEditClub('${teamName}')">âœ</button>`;
                const deleteBtn = isCurrent ? '<span style="font-size:0.7em; opacity:0.5;">(Active)</span>' : `<button class="btn-del" onclick="app.admDelClub('${teamName}')">ğŸ—‘</button>`; 
                return `<li><span style="color:${color}; font-weight:bold;">${teamName}</span> <div>${editBtn} ${deleteBtn}</div></li>`; 
            }).join(''); 
        }
    });
</script>
</body>
</html>
